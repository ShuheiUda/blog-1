<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Japan Azure Identity Support Blog</title>
  
  <subtitle>日本マイクロソフトの Azure Active Directory と AD FS に関するサポート情報のブログです。</subtitle>
  <link href="https://jpazureid.github.io/blog/atom.xml" rel="self"/>
  
  <link href="https://jpazureid.github.io/blog/"/>
  <updated>2023-04-15T23:00:14.466Z</updated>
  <id>https://jpazureid.github.io/blog/</id>
  
  <author>
    <name>Azure Identity Support Japan</name>
    
  </author>
  
  <generator uri="https://hexo.io/">Hexo</generator>
  
  <entry>
    <title>Azure AD のメンバー ユーザーとゲスト ユーザー</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/member-and-guest-user/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/member-and-guest-user/</id>
    <published>2023-04-16T01:00:00.000Z</published>
    <updated>2023-04-15T23:00:14.466Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は Technet Blog の更新停止に伴い <a href="https://blogs.technet.microsoft.com/jpazureid/2017/12/12/azuread-member-guest/">https://blogs.technet.microsoft.com/jpazureid/2017/12/12/azuread-member-guest/</a> の内容を移行したものです。</p><p>元の記事の最新の更新情報については、本内容をご参照ください。</p></div><div class="alert is-info"><p class="alert-title">Note</p><p>2017/12/12: 本記事の初版を投稿</p><p>2018/02/26: Microsoft Connect のリタイアに伴い MSOnline モジュールのダウンロードができなくなったため記載を変更</p><p>2018/10/31: メンバーとゲストの既定のアクセス許可の比較情報のリンクを追加</p><p>2023/04/16: Msol コマンドのリタイアに伴い Microsoft Graph コマンドでの実施方法に更新  </p></div><p>こんにちは、Azure &amp; Identity サポート チームの三輪です。</p><p>Azure AD に所属しているユーザーの種類として、下記のように「メンバー」と「ゲスト」があります。今回は、こちらのユーザーの種類について説明します。</p><p><img src="/blog/azure-active-directory/member-and-guest-user/member-and-guest-new.png"></p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>下記のように、個人アカウントや別テナントの職場または学校アカウント (組織アカウント) を追加した (Azure AD B2B の機能を利用した) 場合に、ユーザーの種類が「ゲスト」として追加されます。</p><p><img src="/blog/azure-active-directory/member-and-guest-user/personal-work-account.png"></p><p>これ以外の Azure のサブスクリプションのサインアップで利用した個人アカウントや組織内のドメイン (上記の例の場合: contso.com) をユーザー名 (例: <a href="mailto:&#116;&#x65;&#x73;&#x74;&#64;&#x63;&#x6f;&#x6e;&#116;&#111;&#115;&#x6f;&#x2e;&#99;&#x6f;&#109;">&#116;&#x65;&#x73;&#x74;&#64;&#x63;&#x6f;&#x6e;&#116;&#111;&#115;&#x6f;&#x2e;&#99;&#x6f;&#109;</a>) に持つユーザーは「メンバー」として登録されます。また、現在は利用できないクラシック ポータル (旧ポータル) より追加した外部ユーザーについては「メンバー」として登録されております。</p><h2 id="詳細"><a href="#詳細" class="headerlink" title="詳細"></a>詳細</h2><p>既定ではゲスト ユーザーに対しては、 Azure AD のデータへのアクセスが制限されています。このため、ゲスト ユーザーで Azure AD テナントにサインインした場合、招待された Azure AD のユーザーの一覧を参照することはできませんし、各種設定の参照および変更も制限されています。もちろん、サブスクリプションに対する権限を付与していない場合は、サブスクリプションのリソースを操作することもできません。一般ユーザーとゲスト ユーザーがそれぞれできること (アクセス許可の比較) は、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/fundamentals/users-default-permissions#compare-member-and-guest-default-permissions">こちら</a>をご参照ください。</p><p><img src="/blog/azure-active-directory/member-and-guest-user/access-denied-new.png"></p><p><img src="/blog/azure-active-directory/member-and-guest-user/no-access-permission-new.png"></p><p>ゲストに対するアクセス制限は、[すべてのユーザー] - [ユーザー設定] - [外部コラボレーションの設定を管理します] と辿り [ゲストのアクセス制限] で変更できます。この設定が “ゲスト ユーザーは、ディレクトリ オブジェクトのプロパティとメンバーシップへのアクセスが制限されます” (既定値) の場合には「ゲスト」の操作は上記のように制限されています。外部コラボレーションの設定については、<a href="https://jpazureid.github.io/blog/azure-active-directory/external-collaboration-setting-b2b-access/">こちら</a> をご参照ください。</p><p><img src="/blog/azure-active-directory/member-and-guest-user/guest-users-permissions-are-limited1-new.png"></p><p><img src="/blog/azure-active-directory/member-and-guest-user/guest-users-permissions-are-limited2-new.png"></p><p>ユーザーの属性については、Azure ポータル上での操作、または PowerShell の実行により、メンバーからゲスト、またその逆についても変更が可能です。ゲストからメンバーに変更する際は「ゲスト」に対して行っていた制御の対象外のユーザーとなるため、セキュリティ ポリシーに沿った対応や特定のユーザーに絞った設定変更をお勧め致します。</p><h2 id="ユーザー-タイプの変更手順"><a href="#ユーザー-タイプの変更手順" class="headerlink" title="ユーザー タイプの変更手順"></a>ユーザー タイプの変更手順</h2><h3 id="Azure-ポータル上の操作で該当ユーザーを-ゲストからメンバーに変更する手順"><a href="#Azure-ポータル上の操作で該当ユーザーを-ゲストからメンバーに変更する手順" class="headerlink" title="Azure ポータル上の操作で該当ユーザーを ゲストからメンバーに変更する手順"></a>Azure ポータル上の操作で該当ユーザーを ゲストからメンバーに変更する手順</h3><ol><li>管理者権限で Azure ポータルにサインインします。</li><li>Azure Active Directory を開き、[ユーザー] を開きます。</li><li>ユーザー タイプを変更したいユーザーを開きます。</li><li>[プロパティの編集] をクリックします。<br>ユーザーの種類のタブを [メンバー] に変更し、[保存] をクリックします。</li></ol><h3 id="PowerShell-を実行して該当ユーザーをゲストからメンバーに変更する手順"><a href="#PowerShell-を実行して該当ユーザーをゲストからメンバーに変更する手順" class="headerlink" title="PowerShell を実行して該当ユーザーをゲストからメンバーに変更する手順"></a>PowerShell を実行して該当ユーザーをゲストからメンバーに変更する手順</h3><p>この作業を実施するためには、Azure AD 用の PowerShell を利用する必要がありますが、 PowerShell を利用する際には Microsoft アカウントではなく、組織アカウントでのグローバル管理者が必要です (Azure AD の PowerShell については <a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement3/">リンク</a> も参照ください)。そのために次の手順で実施する必要があります。</p><ol><li>Azure AD のグローバル管理者アカウントを作成する (※すでに組織アカウントのグローバル管理者が存在する場合はスキップ)</li><li>PowerShell を実行し、該当ユーザーを Guest から Member に変更する</li></ol><p>まず、1. の手順として、Azure AD のグローバル管理者アカウントを作成します。すでに組織アカウントのグローバル管理者が存在する場合はスキップください。</p><ol><li>[ユーザー] - [＋新しいユーザー] と辿り、 [ 新しいユーザーの作成]  をクリックします。</li><li>ユーザー名と名前欄に admin などの任意の値を入力します。</li><li>[役割]をクリックし、ディレクトリ ロール欄で “グローバル管理者” を選択し、 [選択] をクリックします。</li><li>“パスワードを表示” をクリックし、パスワードを控えて [作成] をクリックします。</li></ol><p>次に、2. の手順として、PowerShell を実行し、該当ユーザーを Guest から Member に変更します。以下の手順を順に実行ください。</p><ol><li><p>PowerShell を起動します。</p><p> ※ モジュールの入手方法については、弊社<a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement3/">ブログ</a> をご参照ください。Graph PowerShell SDK のモジュールの利用をお願いします。</p></li><li><p>以下のコマンドを実行します。</p><p> Connect-MgGraph -Scope “User.ReadWrite.All”</p></li><li><p>資格情報の入力を求められるため、1 で作成したアカウントの情報を入力します。パスワードの変更が求められるはずですので、パスワードを新しく設定します。</p></li><li><p>以下のコマンドを実行して、対象ユーザーの UserPrincipalName および UserType 属性値を確認します。</p> <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Get-MgUser</span> <span class="literal">-All</span> <span class="literal">-Property</span> UserPrincipalName,UserType | <span class="built_in">Format-Table</span> UserPrincipalName,UserType</span><br></pre></td></tr></table></figure><p> 出力例:</p> <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">UserPrincipalName                             UserType</span><br><span class="line">user_live.com<span class="comment">#EXT#@contoso.onmicrosoft.com    Guest  -&gt; 「Guest」 であることが確認できます。</span></span><br></pre></td></tr></table></figure></li><li><p>以下のコマンドを実行して、対象ユーザーの UserType を 「Member」 に変更します。</p> <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Update-MgUser</span> <span class="literal">-UserId</span> &lt;対象ユーザーの オブジェクトID または UserPrincipalName&gt; <span class="literal">-UserType</span> Member</span><br></pre></td></tr></table></figure><p> 実行例:</p> <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Update-MgUser</span> <span class="literal">-UserId</span> user_live.com<span class="comment">#EXT#@contoso.onmicrosoft.com -UserType Member</span></span><br></pre></td></tr></table></figure></li><li><p>再度以下のコマンドを実行して、対象ユーザーの UserType を確認します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Get-MgUser</span> <span class="literal">-All</span> <span class="literal">-Property</span> UserPrincipalName,UserType | <span class="built_in">Format-Table</span> UserPrincipalName,UserType</span><br></pre></td></tr></table></figure><p>出力例:</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">UserPrincipalName                             UserType</span><br><span class="line">user_live.com<span class="comment">#EXT#@contoso.onmicrosoft.com    Member  -&gt; 変更されたことを確認します。</span></span><br></pre></td></tr></table></figure></li></ol><p>なお、「Member」から「Guest」に変更する場合は、UserType に「Guest」を指定します。</p><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Update-MgUser</span> <span class="literal">-UserId</span> &lt;対象ユーザーの オブジェクトID または UserPrincipalName&gt; <span class="literal">-UserType</span> Guest</span><br></pre></td></tr></table></figure><p>上記内容が少しでも皆様の参考となりますと幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は Technet Blog の更新停止に伴い &lt;a href=&quot;https://blogs.technet.microsoft.com/jpazure</summary>
      
    
    
    
    
    <category term="Azure AD B2B" scheme="https://jpazureid.github.io/blog/tags/Azure-AD-B2B/"/>
    
  </entry>
  
  <entry>
    <title>Azure ポータルへのアクセス制限</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/access-restriction-azure-portal/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/access-restriction-azure-portal/</id>
    <published>2023-04-16T00:30:00.000Z</published>
    <updated>2023-04-15T23:00:14.062Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は Technet Blog の更新停止に伴い <a href="https://blogs.technet.microsoft.com/jpazureid/2017/12/29/azuread-portal/">https://blogs.technet.microsoft.com/jpazureid/2017/12/29/azuread-portal/</a> の内容を移行したものです。</p><p>元の記事の最新の更新情報については、本内容をご参照ください。</p></div><div class="alert is-info"><p class="alert-title">Note</p><p>2017-12-29: 本記事の初版を投稿</p><p>2023-04-16: MSOL コマンドのリタイアに伴い内容を全体的に更新</p></div><p>こんにちは、Azure &amp; Identity サポート チームの三輪です。</p><p>今回は、一般ユーザーに対して Azure ポータルへのアクセスを制限する方法について紹介します。</p><p>Azure ポータル (<a href="https://portal.azure.com/">https://portal.azure.com</a>) には、サブスクリプションの有無によらずログインすることが可能です。この動作変更により、ユーザーが簡単に Azure に対してアクセスできるようになっています。</p><p>Azure ポータルからは、そのログインしたユーザーが所属する Azure AD ディレクトリにアクセスすることができ、このとき Azure AD に対しての管理者権限を持たない一般ユーザーであっても、既定では Azure AD に登録されているユーザーの一覧を参照できるようになっています。これは <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/fundamentals/users-default-permissions">ドキュメント</a> にも記載されていることで、一般ユーザーは他のユーザーの基本情報を見ることが可能であり、この動作自体は Azure AD で想定されるものです。</p><p>Azure ポータルへ一般ユーザーがアクセスできたとしても、一般ユーザーの権限以上のことはできません。例えば、テナントやユーザーの構成を変更したり、詳細を確認することはできません。上述のとおり、他のユーザーの一覧 (基本情報) を確認することは既定で可能ですが、これは Office 365 を利用する中で他のユーザーを参照できるのと同等です。Azure AD は組織内のユーザーの認証とコラボレーションを促進するディレクトリ サービスであるため、他のユーザーが参照できることはその機能の一部であり問題ではありません。</p><p>Azure ポータルへのアクセスを制限しても、ユーザーは Office 365 のサービス (Exchange や Teams) を利用して他のユーザーの情報を確認可能であることにご注意ください。また、Azure AD 以外の項目、例えば仮想マシンなどのリソースに対しては、サブスクリプションの権限を明示的に付与しない限りは、各ユーザーは参照することもできませんのでご安心ください。</p><p>ただし、上記を踏まえてもお客様の運用形態によっては、Azure ポータル上やその他の方法で他のユーザーの一覧が見えてしまうことが運用上好ましくない場合もあると思います。今回は、このような一般ユーザーによる他のユーザーの参照や管理ツールへのアクセスをできる限り制限する方法についておまとめしました。</p><h2 id="Azure-ポータルを含めた-Azure-の管理ツール全般へのアクセスを制限する方法"><a href="#Azure-ポータルを含めた-Azure-の管理ツール全般へのアクセスを制限する方法" class="headerlink" title="Azure ポータルを含めた Azure の管理ツール全般へのアクセスを制限する方法"></a>Azure ポータルを含めた Azure の管理ツール全般へのアクセスを制限する方法</h2><p>Azure ポータルやその他 Azure CLI など管理ツールへのアクセスを限られたユーザーのみに制限する方法としては、条件付きアクセスの機能を利用することがおすすめです。条件付きアクセスの機能を利用するためには Azure AD Premium (P1 or P2) のライセンスが制御対象のユーザー分必要となります。</p><ol><li><p>Azure ポータル (<a href="https://portal.azure.com/">https://portal.azure.com</a>) に管理者のアカウントでアクセスします。</p></li><li><p>[セキュリティ] から [条件付きアクセス] – [ポリシー] の順にクリックします。</p></li><li><p>上部 [+ 新しいポリシー] をクリックします。</p></li><li><p>[名前] にポリシーの名前を入力します。</p></li><li><p>ポリシーを割り当てるユーザーまたはグループを選択します。</p><p> この時、ポリシーを全ての管理者に割り当てないようご注意ください。全ての管理者がポリシーの制限を受け、Azure ポータルにアクセスすることができなくなります。結果として、設定解除もできなくなるというお問い合わせを過去に複数いただいております。</p></li><li><p>[クラウド アプリ] では 「アプリを選択」にチェックを入れます。</p></li><li><p>[選択] では、[Microsoft Azure Management] アプリケーションを検索し、選択します。</p><p>追加の条件を設定する場合は [条件] にてポリシーが適用される条件を選択します。条件を選択しない場合、すべてのアクセスが対象となります。</p></li><li><p>[アクセス制御] の [許可] で「アクセスのブロック」を選択して、[選択] をクリックします。</p></li><li><p>即時ポリシーを有効化する場合には、ポリシーの有効化で [オン] を選択し、[作成] をクリックします。</p></li></ol><p>該当ユーザーで Azure ポータルへアクセスすると下記の画面が表示され、アクセスがブロックされます。</p><p><img src="/blog/azure-active-directory/access-restriction-azure-portal/access-restricted.png"></p><div class="alert is-important"><p class="alert-title">重要</p><p><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-conditional-access-cloud-apps#microsoft-azure-management">Microsoft Azure Management</a> は複数のサービスが対象となっており、これへのアクセスをブロックすると、Azure ポータル以外にも Azure CLI などを利用したサブスクリプションへのアクセスがブロックされる点にご留意ください。</p></div><h2 id="Azure-AD-管理ポータルへのアクセスを制限する方法"><a href="#Azure-AD-管理ポータルへのアクセスを制限する方法" class="headerlink" title="Azure AD 管理ポータルへのアクセスを制限する方法"></a>Azure AD 管理ポータルへのアクセスを制限する方法</h2><p>これは Azure AD の管理者 (グローバル管理者または制限付き管理者) を与えられていないユーザーによるポータル内 [Azure Active Directory] へのアクセスを制限する方法です。以下の手順で構成いただけます。本設定は、Azure ポータル上のアクセス制限になるため、設定完了後も PowerShell や Azure CLI を使用すれば、ユーザーの一覧は参照できます。</p><ol><li>グローバル管理者として Azure ポータル (<a href="https://portal.azure.com/">https://portal.azure.com</a>) にサインインします。</li><li>[Azure Active Directory] を開きます。</li><li>表示されたメニューから [ユーザー設定] をクリックします。</li><li>右側にある [管理ポータル] - [Azure AD 管理ポータルへのアクセスを制限する] の項目で [はい] を選択します。</li><li>上にある [保存] をクリックします。</li></ol><p>※ 上記 4. で [はい] を選択することで管理者以外の一般ユーザーは、Azure ポータル内での [Azure Active Directory] にアクセスしようとすると、下記の画面が表示されアクセス権がなくなります。</p><p><img src="/blog/azure-active-directory/access-restriction-azure-portal/no-access.png"></p><h2 id="Microsoft-Graph-API-でユーザーの一覧を取得できなくする方法"><a href="#Microsoft-Graph-API-でユーザーの一覧を取得できなくする方法" class="headerlink" title="Microsoft Graph API でユーザーの一覧を取得できなくする方法"></a>Microsoft Graph API でユーザーの一覧を取得できなくする方法</h2><p>上述のとおり、Azure AD では他のユーザーの一覧 (基本情報) を確認することが既定で可能であり、これは想定される動作です。ただし、学校など運用形態によっては、コマンドなどでユーザーが他のユーザーを一覧で取得できることが好ましくない状況もあると存じます。この場合、以下の設定を使用することで、他のユーザーの読み取りをある程度制限可能です。本設定をご利用の際は検証用のテナントで動作を確認したうえで、運用テナントでの利用を検討ください。</p><p>この設定を有効にするためには、Azure AD 用の PowerShell を利用する必要があります。PowerShell を利用する際には組織アカウントのグローバル管理者が必要です (Azure AD の PowerShell については <a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement3/">リンク</a> も参照ください)。</p><ol><li><p>PowerShell を開き、下記のコマンドでグローバル管理者で Azure AD に接続します。</p> <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-Scopes</span> Policy.ReadWrite.Authorization</span><br></pre></td></tr></table></figure></li><li><p>下記コマンドで現在の設定を確認します。    </p>  <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">(<span class="built_in">Get-MgPolicyAuthorizationPolicy</span>).DefaultUserRolePermissions | <span class="built_in">fl</span></span><br></pre></td></tr></table></figure><p> AllowedToReadOtherUsers が該当の設定になります。 True になっていることを確認します。</p><p> <img src="/blog/azure-active-directory/access-restriction-azure-portal/ps-1.png"></p></li><li><p>下記コマンドで他のユーザーの情報を取得させないように設定します。</p> <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="variable">$params</span>=<span class="selector-tag">@</span>&#123;</span><br><span class="line">    defaultUserRolePermissions = <span class="selector-tag">@</span>&#123;</span><br><span class="line">    allowedToReadOtherUsers = <span class="variable">$false</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"> </span><br><span class="line"><span class="built_in">Update-MgPolicyAuthorizationPolicy</span> <span class="literal">-BodyParameter</span> <span class="variable">$params</span></span><br></pre></td></tr></table></figure></li><li><p>再度、下記コマンドで他のユーザーの情報を取得させないように設定されたか確認します。</p> <figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line">(<span class="built_in">Get-MgPolicyAuthorizationPolicy</span>).DefaultUserRolePermissions | <span class="built_in">fl</span></span><br></pre></td></tr></table></figure><p> AllowedToReadOtherUsers が False に変更されたことを確認します。</p><p> <img src="/blog/azure-active-directory/access-restriction-azure-portal/ps-2.png"></p></li></ol><h2 id="補足-ゲスト-ユーザーのアクセス権"><a href="#補足-ゲスト-ユーザーのアクセス権" class="headerlink" title="補足: ゲスト ユーザーのアクセス権"></a>補足: ゲスト ユーザーのアクセス権</h2><p>外部から追加したゲスト ユーザーについては既定で Azure AD へのアクセスが制限されています。ゲストとメンバー の違いについては、<a href="https://jpazureid.github.io/blog/azure-active-directory/member-and-guest-user/">こちら</a> を参照ください。</p><h2 id="補足-Azure-サブスクリプションの作成権限の制御"><a href="#補足-Azure-サブスクリプションの作成権限の制御" class="headerlink" title="補足: Azure サブスクリプションの作成権限の制御"></a>補足: Azure サブスクリプションの作成権限の制御</h2><p>既定では Azure ポータルにユーザーがサインインすることで、自由に新規サブスクリプションを作成することが可能です。ここで作成されるサブスクリプションはそのユーザーが新たに自身のクレジット カードを登録して利用するものです。つまり、会社のサブスクリプションのリソースや課金観点において影響はありません。</p><p>Azure AD のグローバル管理者においては下記の設定で、自身が管理する Azure AD に紐づく全サブスクリプションを確認可能です。</p><ol><li>グローバル管理者として Azure ポータル (<a href="https://portal.azure.com/">https://portal.azure.com</a>) にサインインします。</li><li>左側のメニューから [Azure Active Directory] をクリックします。</li><li>表示されたメニューから [プロパティ] をクリックします。</li><li>[Azure リソースのアクセス管理] より、[すべての Azure サブスクリプションおよび管理グループへのアクセスを管理できます] を [はい] に設定します。</li><li>上にある [保存] をクリックします。</li></ol><p>上記内容が少しでも皆様の参考となりますと幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は Technet Blog の更新停止に伴い &lt;a href=&quot;https://blogs.technet.microsoft.com/jpazure</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
  </entry>
  
  <entry>
    <title>ハイブリッド Azure AD 参加を再構成する</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/haadj-re-registration/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/haadj-re-registration/</id>
    <published>2023-04-16T00:00:00.000Z</published>
    <updated>2023-04-15T23:00:14.334Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure &amp; Identity サポート チームの長谷川です。</p><p>この記事では、対象デバイスのハイブリッド Azure AD 参加 (略称 HAADJ) を再構成する手順を紹介します。</p><span id="more"></span><p>HAADJ を構成完了後、たとえばなんらか Azure AD 上から誤ってデバイス オブジェクトを削除してしまう場合があるかと思います。削除後、再度 Azure AD Connect (略称 AADC) でデバイス オブジェクトが同期されると [Azure Portal (portal.azure.com)] &gt; [Azure Active Directory] &gt; [デバイス] &gt; [すべてのデバイス] で対象のデバイス オブジェクトが表示されるようになりますが、[登録済み] の項目が「保留中」のまま遷移しない状態になります。「保留中」から登録日に遷移させるためにはデバイスで HAADJ を再構成する必要があるものの、実際のデバイス側は既に HAADJ の構成が完了しているため、そのままでは HAADJ を再構成する動作が生じません。こういった場合に、本ブログを参考に HAADJ を再構成いただけると幸いです。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ol><li><a href="#anchor1">注意事項</a></li><li><a href="#anchor2">事前準備: Windows Hello for Business のリセット</a></li><li><a href="#anchor3">事前準備: Intune の登録解除</a></li><li><a href="#anchor4">HAADJ 再構成: 既存情報のクリア</a></li><li><a href="#anchor5">HAADJ 再構成: 改めて構成</a></li><li><a href="#anchor6">事後確認: Intune の登録</a></li><li><a href="#anchor7">事後作業: WHfB の再プロビジョニング</a></li></ol><h2 id="anchor1">1. 注意事項</h2><p>本手順は Azure AD でデバイスを認証する「Sync Join」「マネージド」「クラウド認証」などと呼ばれる構成方法にのみ適用可能です。</p><p>この構成方法は、オンプレミスの Active Directory サーバーから AADC を介して Azure AD にデバイス オブジェクトを同期し、Azure AD でデバイスを認証して HAADJ としてデバイスを構成するものです。もしも AD FS でクレーム ルールを使用してデバイスを認証し、Azure AD にデバイスを登録して HAADJ を構成している場合はこの手順は利用できません。</p><p>なお、再度 HAADJ を構成するためにはそのデバイス上での管理者権限と、デバイスがオンプレミスの Active Directory にアクセスできる環境 (社外にデバイスがある場合は、オンプレミス AD 環境への VPN 接続) が必要です。</p><h2 id="anchor2">2. 事前準備: Windows Hello for Business のリセット</h2><p><strong>Windows Hello for Business (略称 WHfB) を利用していない場合はこの手順はスキップください。</strong></p><ol><li><p>端末にサインインします。</p></li><li><p><strong>ユーザー権限</strong> でコマンド プロンプトを起動します (管理者として実行から起動しないようご注意ください)。</p></li><li><p>以下のコマンドを実行して、WHfB の情報をリセットします。</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">certutil -deletehellocontainer</span><br></pre></td></tr></table></figure></li><li><p>次のコマンドを実行し、<code>NgcSet : NO</code> となっていることを確認します。</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dsregcmd /status</span><br></pre></td></tr></table></figure></li></ol><h2 id="anchor3">3. 事前準備: Intune の登録解除</h2><p><strong>Intune 登録していなければスキップください。</strong></p><ol><li><p>[Microsoft Intune admin center (endpoint.microsoft.com)] &gt; [デバイス] &gt; [すべてのデバイス] から該当デバイスを検索し、存在する場合は対象デバイスを開いて [削除] ボタンをクリックして削除します (削除完了するまでに少し時間がかかります)。</p></li><li><p>対象のデバイス上で、[PowerShell] を <strong>管理者権限</strong> で実行します。</p></li><li><p>以下のコマンドを実行し、Enrollment ID (GUID の形式となる想定) が表示されるかを確認します。(表示されない場合は以下の 4. から 7. の手順は不要です)</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-ChildItem HKLM:\Software\Microsoft\Enrollments | ForEach-Object &#123;Get-ItemProperty $_.pspath&#125; | where-object &#123;$_.DiscoveryServiceFullURL&#125; | Foreach-Object &#123;$_.PSChildName&#125;</span><br></pre></td></tr></table></figure></li><li><p>以下のコマンドを実行し、Enrollment ID を変数に格納します。</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$EnrollmentGUID = Get-ChildItem HKLM:\Software\Microsoft\Enrollments | ForEach-Object &#123;Get-ItemProperty $_.pspath&#125; | where-object &#123;$_.DiscoveryServiceFullURL&#125; | Foreach-Object &#123;$_.PSChildName&#125;</span><br></pre></td></tr></table></figure></li><li><p>以下のコマンドを実行し削除対象のレジストリを変数に格納します。(長いですが 1 行のコマンドです)</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$RegistryKeys = &quot;HKLM:\SOFTWARE\Microsoft\Enrollments&quot;, &quot;HKLM:\SOFTWARE\Microsoft\Enrollments\Status&quot;,&quot;HKLM:\SOFTWARE\Microsoft\EnterpriseResourceManager\Tracked&quot;, &quot;HKLM:\SOFTWARE\Microsoft\PolicyManager\AdmxInstalled&quot;, &quot;HKLM:\SOFTWARE\Microsoft\PolicyManager\Providers&quot;,&quot;HKLM:\SOFTWARE\Microsoft\Provisioning\OMADM\Accounts&quot;, &quot;HKLM:\SOFTWARE\Microsoft\Provisioning\OMADM\Logger&quot;, &quot;HKLM:\SOFTWARE\Microsoft\Provisioning\OMADM\Sessions&quot;</span><br></pre></td></tr></table></figure></li><li><p>以下のコマンドを実行し、デバイス登録情報に関するレジストリを削除します。</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">foreach ($Key in $RegistryKeys) &#123;if (Test-Path -Path $Key) &#123;Get-ChildItem -Path $Key | Where-Object &#123;$_.Name -match $EnrollmentGUID&#125; | Remove-Item -Recurse -Force -Confirm:$false -ErrorAction SilentlyContinue&#125;&#125;</span><br></pre></td></tr></table></figure></li><li><p>以下のコマンドを実行し、デバイス登録のタスクを削除します。</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-ScheduledTask | Where-Object &#123;$_.Taskpath -match $EnrollmentGUID&#125; | Unregister-ScheduledTask -Confirm:$false</span><br></pre></td></tr></table></figure></li></ol><h2 id="anchor4">4. HAADJ 再構成: 既存情報のクリア</h2><p>実際に HAADJ の再登録を行うに際して既存の情報をクリアしておきます。</p><ol><li><p>対象のデバイスにて <strong>管理者権限</strong> でコマンド プロンプトを起動し、次のコマンドで HAADJ を解除します。</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dsregcmd /leave</span><br></pre></td></tr></table></figure></li><li><p>次のコマンドで <code>AzureAdJoined : NO</code> となっていることを確認します。</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dsregcmd /status</span><br></pre></td></tr></table></figure></li><li><p>オンプレミスの Active Directory にて、[Active Directory ユーザーとコンピューター] を開き、[表示(V)] &gt; [拡張機能(V)] を有効にします。(すでに有効であればスキップしてください)</p><p> <img src="/blog/azure-active-directory/haadj-re-registration/haadj-re-registration4-3.png"></p></li><li><p>[Active Directory ユーザーとコンピューター] にて対象のコンピューター アカウントを探し、右クリックから [プロパティ] を開きます (誤ったオブジェクトを操作しないよう直接対象のコンピューター アカウントを探すことをお勧めします。)</p><p> <img src="/blog/azure-active-directory/haadj-re-registration/haadj-re-registration4-4.png"></p></li><li><p>[属性エディター] から [userCertificate] を選択し、[編集(E)] を選択します。</p><p> <img src="/blog/azure-active-directory/haadj-re-registration/haadj-re-registration4-5.png"></p></li><li><p>[削除(R)] してから [OK] を選択します。</p><p> <img src="/blog/azure-active-directory/haadj-re-registration/haadj-re-registration4-6.png"></p></li><li><p>[userCertificate] が &lt;未設定&gt; となっていることを確認したら [OK] を選択して閉じます。</p><p> <img src="/blog/azure-active-directory/haadj-re-registration/haadj-re-registration4-7.png"></p></li><li><p>AADC の同期 (既定では 30 分間隔) を待ち、[Azure Portal (portal.azure.com)] &gt; [Azure Active Directory] &gt; [デバイス] &gt; [すべてのデバイス] にて対象のデバイス オブジェクトが削除されていることを確認します。</p></li></ol><h2 id="anchor5">5. HAADJ 再構成: 改めて構成</h2><p>以下の手順で実際に再構成を行います。</p><ol><li><p>対象のデバイスを再起動したのち、対象のユーザーでサインインします。</p></li><li><p>対象のデバイスがオンプレミスの Active Directory にアクセスできるネットワーク環境に接続していることを確認します (社内ネットワーク環境に接続するなど)。</p></li><li><p><strong>管理者権限</strong> でタスク スケジューラを起動し [タスク スケジューラ ライブラリ] &gt; [Microsoft] &gt; [Windows] &gt; [Workplace Join] を開きます。</p></li><li><p>[Automatic-Device-Join] を 右クリックし [実行する(R)] を選択します。</p><p> <img src="/blog/azure-active-directory/haadj-re-registration/haadj-re-registration5-4.png"></p></li><li><p>オンプレミスの Active Directory にて対象のコンピューター アカウントに userCertificate に値が書き込まれたことを確認します (上記「4. HAADJ 再構成: 既存情報のクリア」の 3 から 5 の手順を参考)。</p><p> <img src="/blog/azure-active-directory/haadj-re-registration/haadj-re-registration5-5.png"></p></li><li><p>AADC の同期 (既定では 30 分間隔) を経て [Azure Portal (portal.azure.com)] &gt; [Azure Active Directory] &gt; [デバイス] &gt; [すべてのデバイス] に対象のデバイス オブジェクトが同期されたことを確認します。</p><p> <img src="/blog/azure-active-directory/haadj-re-registration/haadj-re-registration5-6.png"></p></li><li><p>Azure AD への同期を確認後、再度 [Automatic-Device-Join] を実行します。(3 から 4 の手順を参考)</p></li><li><p>コマンド プロンプトを起動し次のコマンドを実行し <code>AzureAdJoined : YES</code> となっていることを確認します。</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dsregcmd /status</span><br></pre></td></tr></table></figure></li><li><p>[Azure Portal (portal.azure.com)] &gt; [Azure Active Directory] &gt; [デバイス] &gt; [すべてのデバイス] で対象のデバイス オブジェクトの [登録済み] の項目が「保留中」から現在の日付に遷移したことを確認します。</p><p> <img src="/blog/azure-active-directory/haadj-re-registration/haadj-re-registration5-9.png"></p></li><li><p>対象デバイスにて 画面のロック &gt; アンロック をすることで プライマリ更新トークン (PRT) を取得します。(すぐにアンロックしていただいて問題ありません)</p></li><li><p>対象のデバイスにて対象の <strong>ユーザー権限</strong> でコマンド プロンプトを起動し、次のコマンドを実行して <code>AzureAdPrt : YES</code> となっていることを確認します (管理者として実行から起動しないようご注意ください)。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">dsregcmd /status</span><br></pre></td></tr></table></figure></li></ol><h2 id="anchor6">6. 事後確認: Intune の登録</h2><p><strong>この手順は Intune 登録しなければ不要です。</strong> また、反映に時間がかかることがあります。</p><ol><li> [Azure Portal (portal.azure.com)] &gt; [Azure Active Directory] &gt; [デバイス] &gt; [すべてのデバイス] で対象のデバイス オブジェクトの [MDM] の項目に値が入り [準拠している] が「はい」となっていることを確認します。</li><li>[Microsoft Intune admin center (endpoint.microsoft.com)] &gt; [デバイス] &gt; [すべてのデバイス] から該当デバイスを検索し対象デバイスの [対応] の項目が「準拠している」となっていることを確認します。</li></ol><h2 id="anchor7">7. 事後作業: WHfB の再プロビジョニング</h2><p><strong>WHfB を利用していなければ不要です。</strong></p><ol><li>端末を再起動します。</li><li>対象のユーザーでサインインすると WHfB のプロビジョニングが自動的に始まりますのでウィザードに沿ってセットアップします (ウィザードの中で多要素認証が要求されます)。</li></ol><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>以上、HAADJ の再構成手順が運用の助けになると嬉しく思います。製品動作に関する正式な見解や回答については、お客様環境などを十分に把握したうえでサポート部門より提供しますので、ぜひ弊社サポート サービスをご利用ください。</p>]]></content>
    
    
    <summary type="html">&lt;p&gt;こんにちは、Azure &amp;amp; Identity サポート チームの長谷川です。&lt;/p&gt;
&lt;p&gt;この記事では、対象デバイスのハイブリッド Azure AD 参加 (略称 HAADJ) を再構成する手順を紹介します。&lt;/p&gt;</summary>
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="Troubleshooting" scheme="https://jpazureid.github.io/blog/tags/Troubleshooting/"/>
    
    <category term="Hybrid Azure AD Join" scheme="https://jpazureid.github.io/blog/tags/Hybrid-Azure-AD-Join/"/>
    
  </entry>
  
  <entry>
    <title>MSOnline / AzureAD PowerShell から Graph PowerShell SDK への移行について 4_ユーザー管理</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement4/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement4/</id>
    <published>2023-04-14T00:00:00.000Z</published>
    <updated>2023-04-15T23:00:14.158Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、 Azure Identity サポート チームの小出です。</p><p>この記事は、この記事は、MSOnline / AzureAD モジュール廃止について、<a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement1/">1. 概要編</a>、<a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement2/">2. 移行導入編</a>、<a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement3/">3. インストール・接続編</a> の続きとして連載しています。</p><p>4 回目となる今回からは、具体的に、新しい Microsoft Graph PowerShell SDK を使用したユーザーの管理方法についてご案内します。以前、<a href="https://jpazureid.github.io/blog/azure-active-directory/operating-license-with-microsoft-graph/">こちらの記事</a> にて、ライセンス管理についてご案内させていただきましたが、今回はユーザー管理に特化してご紹介します。まだモジュールをインストールしていない場合や、 Connect-MgGraph コマンドを使用した接続方法が分からない場合などは、本シリーズの 2 と 3 をご確認ください。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ol><li><a href="#idx1">ユーザーの取得</a><ul><li><a href="#idx1-1">テナントの全ユーザーを取得したい</a></li><li><a href="#idx1-2">特定のユーザーを取得したい</a></li><li><a href="#idx1-3">ゲスト ユーザーのみを取得したい)</a></li><li><a href="#idx1-4">アカウントが有効なゲスト ユーザーのみを取得したい)</a></li><li><a href="#idx1-5">特定のユーザーの extensionAttribute の値を取得したい</a></li><li><a href="#idx1-6">削除済みユーザーを取得したい</a></li></ul></li><li><a href="#idx2">ユーザーの作成</a></li><li><a href="#idx3">ユーザーの削除</a></li><li><a href="#idx4">削除済みユーザーの完全削除と復元</a></li><li><a href="#idx5">ユーザーの属性を更新する</a></li><li><a href="#idx6">よくある質問</a></li></ol><hr><h2 id="idx1">1. ユーザーの取得</h2><p>これまでユーザー情報の取得にし使用していた Get-MsolUser や Get-AzureADUser コマンドは、 Get-MgUser コマンドに置き換えられます。ここでは様々なシナリオでユーザーを取得する方法についてご紹介します。</p><h3 id="idx1-1">テナントの全ユーザーを取得したい</h3><p>全てのユーザーを取得するには、-All オプションを使用します。Get-AzureADUser コマンドでは、-All $true とする必要がありましたが、新しいコマンドでは -All のみで動作します。-All を指定しない場合は、100 ユーザーなど一部の結果のみが返されます。 ユーザー数の非常に多い環境では -All オプションをつけると大量の結果が表示されますのでご注意ください。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgUser -All</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-1.png"></p><h3 id="idx1-2">特定のユーザーを取得したい</h3><p>これまでのコマンドと同様に、 ObjectID や UPN を指定することで取得が可能です。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgUser -UserId admin@m365x219253.onmicrosoft.com</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-2.png"></p><p>上記で気になった方もいると思いますが、Usertype の中身が空になっていることにお気づきでしょうか。Get-MsolUser コマンドや Get-AzureADUser コマンドでは、何も指定しなくても、すべての属性の情報が一括で出力されていました。</p><p> Microsoft Graph Powershell SDK では、属性によって下記のような特徴がある点を理解しておくと、「入れたはずの値が表示されない」といった混乱を避けることができます。</p><ul><li>Microsoft Graph PowerShell SDK にはバージョンがあり、v1.0 で取得できる属性値 beta でしか取得できない属性値がある</li><li>Property オプションを使用して明示的に指定しないと、結果に表示されないものがある</li></ul><p>そのため、たとえば下記のように実行すると、Usertype 属性が取得できるようになります。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgUser -UserId admin@m365x219253.onmicrosoft.com -Property Id,Displayname,Mail,UserPrincipalName,Usertype</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-3.png"></p><p>これは、| format-list を利用したときも同様で、| format-list 自体は新しいモジュールでも機能しますが、下記のように、必要な情報が出てこないことがあります。</p><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-4.png"></p><p>AccountEnabled に値が入っていない！と疑問に思うかもしれませんが、Usertype と同様に下記のように実行すると、AccountEnabled の値も取得することが可能です。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgUser -UserId 30a4a94b-9bca-4141-94d2-2dd0e2cc341b -Property Id,Displayname,Mail,UserPrincipalName,Usertype,AccountEnabled | fl</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-5.png"></p><p>もしくは、上記にて紹介した -Property オプションを使用したうえで、さらに Select を使用すると、表示される属性と値をカスタマイズできます。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgUser -UserId 2e7c8a97-ab50-4e53-b193-be3ff9ddc6aa -Property Id,Displayname,Mail,UserPrincipalName,Usertype,AccountEnabled | select displayname,accountenabled</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-6.png"></p><p>次に、-Filter オプションをはじめとするオプションを活用できます。よくお問い合わせをいただく取得方法についてご案内します。</p><h3 id="idx1-3">ゲスト ユーザーのみを取得したい</h3><p>特定の条件を満たすユーザーのみを取得したい場合は -Filter オプションを使用します。usertype が Guest となっているユーザーをフィルターして表示しています。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgUser -All  -Filter &quot;usertype eq &#x27;Guest&#x27;&quot; -Property Id,displayname,Mail,Userprincipalname,Usertype</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-7.png"></p><h3 id="idx1-4">アカウントが有効なゲスト ユーザーのみを取得したい</h3><p>-Filter の条件を 2 つ以上記載したいときは and でつなげると利用できます。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgUser -Filter &quot;accountEnabled eq true and usertype eq &#x27;Guest&#x27;&quot;</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-8.png"></p><h3 id="idx1-5">特定のユーザーの extensionAttribute の値を取得したい</h3><p>ExtensionAttribute1 などの属性は、ユーザーの onpremisesExtensionAttributes の配下に用意されているので、下記のように実行して取得します。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(get-mguser -UserId 4e6bc6e4-d6e7-4bd8-9079-3393e12dcec3).onpremisesExtensionAttributes | fl</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-9.png"></p><p>こちらは beta のみ対応しておりますので、Connect-MgGraph での接続後、本コマンド実行前に Select-Mgprofile -name beta にてベータに切り替えを実施ください。</p><h3 id="idx1-6">削除済みユーザーを取得したい</h3><p>削除済みのオブジェクトを取得するコマンドは、Get-MgDirectoryDeletedItem です。-DirectoryObjectID オプションに microsoft.graph.user と記載すると、削除されたユーザー オブジェクトが返されます (これらは、いわゆるごみ箱にある状態のユーザーで、30 日後に完全に削除されると参照できなくなります)。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(Get-MgDirectoryDeletedItem -DirectoryObjectId microsoft.graph.user).AdditionalProperties.value</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-10.png"></p><p>利用可能なパラメーターは Filter 以外にもありますが、各属性によってサポートされるオプションが異なります。下記のような公開情報を確認いただき、使用したい属性とオプションがサポートされているか、あらかじめご確認ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/graph/api/resources/user?view=graph-rest-1.0#properties">user リソースの種類 - プロパティ</a></li><li><a href="https://learn.microsoft.com/ja-jp/graph/api/user-list?view=graph-rest-1.0&tabs=powershell#optional-query-parameters">ユーザーを一覧表示する - オプションのクエリ パラメーター</a></li></ul><h2 id="idx2">2. ユーザーの作成</h2><p>下記のように必要なパラメーターを記載して、 New-Mguser を使用すると新しいユーザーを作成できます。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$params = @&#123;</span><br><span class="line">AccountEnabled = $true</span><br><span class="line">DisplayName = &quot;Adele Vance22&quot;</span><br><span class="line">MailNickname = &quot;AdeleV22&quot;</span><br><span class="line">UserPrincipalName = &quot;AdeleV22@m365x61971868.onmicrosoft.com&quot;</span><br><span class="line">PasswordProfile = @&#123;</span><br><span class="line">ForceChangePasswordNextSignIn = $true</span><br><span class="line">Password = &quot;xWwvJ]6NMw+bWH-d11&quot;</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br><span class="line">New-MgUser -BodyParameter $params</span><br></pre></td></tr></table></figure><p>もしくは、下記のように直接 New-Mguser コマンド内で必要な情報を記載することも可能です。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$PasswordProfile = @&#123;</span><br><span class="line">  Password = &#x27;Passw0rd&#x27;</span><br><span class="line">  &#125;</span><br><span class="line">New-MgUser -DisplayName &#x27;Rene Magi&#x27; -PasswordProfile $PasswordProfile -AccountEnabled -MailNickName &#x27;ReneMagi&#x27; -UserPrincipalName &#x27;ReneMagi@m365x61971868.onmicrosoft.com&#x27;</span><br></pre></td></tr></table></figure><p>以下の公開情報も併せてご確認ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/powershell/module/microsoft.graph.users/new-mguser?view=graph-powershell-1.0">New-MgUser</a></li><li><a href="https://learn.microsoft.com/ja-jp/graph/api/user-post-users?view=graph-rest-1.0&tabs=http">ユーザーを作成する</a></li></ul><h2 id="idx3">3. ユーザーの削除</h2><p>Remove-MgUser コマンドにて削除可能です。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Remove-MgUser -UserId 282f0fb7-06a6-4a86-b3d5-01569d7393a1</span><br></pre></td></tr></table></figure><h2 id="idx4">4. 削除済みユーザーの完全削除と復元</h2><p>削除されたユーザーは、30 日間の間、削除済みユーザーとして一時的に保存されます。30 日以内であれば、誤って削除してしまった場合でもこれらのユーザーを復元することが可能です。復元したい場合、 Restore-MgDirectoryDeletedItem コマンドを使用します。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Restore-MgDirectoryDeletedItem -DirectoryObjectId 282f0fb7-06a6-4a86-b3d5-01569d7393a1</span><br></pre></td></tr></table></figure><p><a href="https://learn.microsoft.com/ja-jp/graph/api/directory-deleteditems-restore?view=graph-rest-1.0&tabs=http">削除済みアイテムを復元する</a> の公開情報も併せてご確認ください。</p><p>完全に削除したい場合、Remove-MgDirectoryDeletedItem コマンドを使用します。こちらのコマンドを実行すると、オブジェクトは完全に削除され復元できなくなるためご留意ください。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Remove-MgDirectoryDeletedItem -DirectoryObjectId 282f0fb7-06a6-4a86-b3d5-01569d7393a1</span><br></pre></td></tr></table></figure><p><a href="https://learn.microsoft.com/ja-jp/graph/api/directory-deleteditems-delete?view=graph-rest-1.0&tabs=powershell">アイテムを完全に削除する</a> の公開情報も併せてご確認ください。</p><h2 id="idx5">5. ユーザーの属性を更新する</h2><p>Update-Mguser コマンドを利用して更新が可能です。たとえばユーザーの displayname とその他のメール (Othermails) を更新したい場合は下記のように実行します。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Update-MgUser -UserId 2e7c8a97-ab50-4e53-b193-be3ff9ddc6aa -DisplayName test1228a -OtherMails @(&quot;bob@contoso.com&quot;, &quot;admin@m365x219253.onmicrosoft.com&quot;)</span><br></pre></td></tr></table></figure><p>一般的には上記のように、変更したい属性を指定して、新しい値を指定すれば更新できます。</p><p>時折ご質問をいただくものとして、extensionattribute 関連の属性を更新したいといったお問い合わせがよくあるため、以下に手順を例として案内します。 Extensionattribute の値を更新したい場合、事前に beta に切り替えてからコマンドを実行ください。</p><ol><li><p>Connect-MgGraph にて接続します。</p></li><li><p>beta バージョンへ切り替えます。</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Select-MgProfile -Name &quot;beta&quot;</span><br></pre></td></tr></table></figure></li><li><p>Get-Mguser コマンドを実行して、ユーザーの情報を取得します。</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(Get-MgUser -UserId 4e6bc6e4-d6e7-4bd8-9079-3393e12dcec3).onpremisesExtensionAttributes | fl</span><br></pre></td></tr></table></figure><p> 以下の画面では、ユーザーの ExtensionAttribute1 の値に test という文字列が入っていることが確認できます。</p><p> <img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-11.png"></p></li><li><p>以下のコマンドを実行して、たとえば ExtensionAttribute1 の値を test2 に更新します。</p> <figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Update-MgUser -UserId 4e6bc6e4-d6e7-4bd8-9079-3393e12dcec3 -OnPremisesExtensionAttributes @&#123;&quot;ExtensionAttribute1&quot;=&#x27;test2&#x27;&#125;</span><br></pre></td></tr></table></figure></li><li><p>値が test2 に更新されたことを確認します。</p><p> <img src="/blog/azure-active-directory/azuread-module-retirement4/azuread-module-retirement4-12.png"></p></li></ol><h2 id="idx6">6. よくある質問</h3><p>Q. Set-MsolUser コマンドで実施できた StrongAuthenticationRequirements の有効化や、StrongAuthenticationMethod を無効化する代替案はありますか？</p><p>A. いいえ、現状新しい Microsoft Graph PowerShell SDK では対応していません。<a href="https://learn.microsoft.com/ja-jp/graph/api/resources/authenticationmethods-overview?view=graph-rest-1.0">公開情報</a> にも記載があります。</p><blockquote><p>この機能は現在、StrongAuthenticationMethods プロパティを使用して、MSOL Set-MsolUser コマンドレットを使用してのみサポートされています。</p></blockquote><p>StrongAuthenticationMethod プロパティは、”ユーザーごとの MFA” の機能で利用される項目ですが、この機能はレガシーとなり、現在は条件付きアクセスでの管理を推奨しております。そのため、ユーザーごとの MFA を利用している場合、今後は条件付きアクセスで MFA を要求する形に移行することをお勧めいたします。条件付きアクセスにてユーザーに MFA を要求すると、そのユーザー次回サインイン時に自動的に MFA の登録を求められます。例えば、条件付きアクセスにてすべてのアプリに対して MFA を要求するように構成すると、これは “ユーザーごとの MFA” の機能において、ユーザーの MFA の状態を “有効” にするのと同じ意味になります。このため、現在 “ユーザーごとの MFA” の機能において、ユーザーの MFA の状態を “有効” にすることで MFA を構成している場合は、条件付きアクセスにてすべてのアプリに対して MFA を要求するように構成ください。</p><p>一方で、MFA の再登録を要求する場合は、<a href="https://learn.microsoft.com/en-us/graph/api/resources/authenticationmethods-overview?view=graph-rest-1.0">公開情報 (英語)</a> に記載があり、Microsoft Graph API (PowerShell SDK) を利用して、利用可能なすべての認証方法を個別に削除するというのが今後の正しい代替方法となります。</p><p>基本的なユーザー管理コマンドについて案内していますが、もし利用方法が不明なコマンドがございましたらお気軽にお問い合わせを起票ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、 Azure Identity サポート チームの小出です。&lt;/p&gt;
&lt;p&gt;この記事は、この記事は、MSOnline / AzureAD モジュール廃止について、&lt;a href=&quot;https://jpazureid.github.io/blog/azure-ac</summary>
      
    
    
    
    
    <category term="PowerShell" scheme="https://jpazureid.github.io/blog/tags/PowerShell/"/>
    
    <category term="Microsoft Graph" scheme="https://jpazureid.github.io/blog/tags/Microsoft-Graph/"/>
    
  </entry>
  
  <entry>
    <title>カスタム クレーム プロバイダーで認証フローをカスタマイズ！</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/customize-your-authentication-flows-with-custom-claims-providers/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/customize-your-authentication-flows-with-custom-claims-providers/</id>
    <published>2023-04-13T03:00:00.000Z</published>
    <updated>2023-04-15T23:00:14.286Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 五十嵐 です。</p><p>本記事は、2023 年 3 月 20 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/customize-your-authentication-flows-with-custom-claims-providers/ba-p/2464388">Customize your authentication flows with custom claims providers!</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>皆さん、こんにちは。</p><p>Microsoft Entra の一部である Azure Active Directory (Azure AD) においてカスタム クレーム プロバイダーのパブリック プレビューを発表できることを大変うれしく思います。</p><p>カスタム クレーム プロバイダーを使うと、認証フローの最中に API を呼び出してカスタム クレームをトークンにマッピングすることができます。API の呼び出しは、ユーザーがすべての認証要求を完了した後で、トークンがアプリへ発行される直前に実行されます。アプリが想定どおり機能するために、アプリに送信されるトークンに追加のクレームを返す必要があるというシナリオを多くのお客様から伺いました。これらのクレームを外部のシステムから取得するのは、以下のような理由が挙げられます:</p><ul><li>機密性の高い属性をオンプレミスで管理しており、Active Directory Federation Services やその他のフェデレーション サービスを使用して Azure AD にクレームを渡す必要がある。</li><li>規制上、これら機密性の高い属性を Azure AD に同期させることができない。</li><li>属性が外部データベースに格納されており、複雑な RBAC モデルを保有している。</li><li>アプリを所有していない、または認証後にこれらの属性を取得するようにアプリを変更することができない。</li></ul><p>カスタム クレーム プロバイダーを使用すると、外部システムからクレームを取得し、トークンに直接発行することができます。LDAP や SQL など、あらゆるデータ ストアと連携することもできます。カスタム クレーム プロバイダーは、OpenID および SAML アプリに設定でき、従業員や外部の ID を認証するシナリオで機能します。</p><p>Contoso 社の人事アプリを使って設定方法を紹介したいと思います。このシナリオでは、Contoso 社は人事アプリを Active Directory Federation Services から切り離し、Azure AD で直接認証することを検討しています。人事アプリは、オンプレミスの Active Directory に保存されているトークンに、ユーザーの社員番号が返されることを想定しています。 </p><p>Contoso 社はカスタム クレーム プロバイダーを構成し、このデータを取得して認証時にトークンに挿入することがで切るようになります。Contoso 社の Azure AD 側の設定を始めてみましょう。 </p><p>まず、[<strong>エンタープライズ アプリケーション</strong>] メニューで、Contoso の管理者は [<strong>カスタム認証拡張機能</strong>] を選択後、[<strong>カスタム拡張機能の作成</strong>] を選択します。</p><p><img src="/blog/azure-active-directory/customize-your-authentication-flows-with-custom-claims-providers/customize-your-authentication-flows-with-custom-claims-providers1.png"></p><p>そして [<strong>TokenIssuanceStart</strong>] を選択し、[<strong>次へ</strong>] を選択します。 </p><p><img src="/blog/azure-active-directory/customize-your-authentication-flows-with-custom-claims-providers/customize-your-authentication-flows-with-custom-claims-providers2.png"></p><p>管理者は、Contoso 社の API の [<strong>名前</strong>] [<strong>対象 URL</strong>] [<strong>説明</strong>] を入力し、[<strong>次へ</strong>] を選択します。API エンドポイントは、LDAP 検索を使用して Active Directory と通信し、ユーザーの社員番号を取得することになります。</p><p><img src="/blog/azure-active-directory/customize-your-authentication-flows-with-custom-claims-providers/customize-your-authentication-flows-with-custom-claims-providers3.png"></p><p>次に、Contoso 社の管理者は、カスタム拡張機能がどのようにして自社の API に認証するかを設定できます。[<strong>アプリの登録を新規作成する</strong>] を選択し、[<strong>名前</strong>] を入力し、[<strong>次へ</strong>] を選択します。Contoso 社の API を認証するために、クライアント資格情報を使用します。Contoso 社は Azure Functions アプリを使用して API をホストしているため、このアプリ登録が自動的に API を保護するために使用されます。</p><p><img src="/blog/azure-active-directory/customize-your-authentication-flows-with-custom-claims-providers/customize-your-authentication-flows-with-custom-claims-providers4.png"></p><p>そして、API から返される属性名をカスタム拡張機能に設定します。Contoso 社の API は、<strong>employeeNumber</strong> という属性を返します。管理者は [<strong>要求名</strong>] に <strong>employeeNumber</strong> を入力し、[<strong>次へ</strong>] を選択します。</p><p><img src="/blog/azure-active-directory/customize-your-authentication-flows-with-custom-claims-providers/customize-your-authentication-flows-with-custom-claims-providers5.png"></p><p><img src="/blog/azure-active-directory/customize-your-authentication-flows-with-custom-claims-providers/customize-your-authentication-flows-with-custom-claims-providers6.png"></p><p>次に、カスタム クレーム プロバイダーを使用して、人事アプリ登録のクレームをマッピングしてみましょう。Contoso 社の管理者は、[<strong>エンタープライズ アプリケーション</strong>] メニューに移動して 人事アプリを選択し、[<strong>シングル サインオン</strong>] &gt; [<strong>属性とクレーム</strong>] で [<strong>編集</strong>] を選択します。</p><p><img src="/blog/azure-active-directory/customize-your-authentication-flows-with-custom-claims-providers/customize-your-authentication-flows-with-custom-claims-providers7.png"></p><p>Contoso 社の管理者は、カスタム クレーム プロバイダーを構成して、カスタム拡張機能から社員番号を取得するためのクレーム マッピングを作成する必要があります。</p><p>[<strong>詳細設定</strong>] メニューを展開し、［<strong>設定</strong>］を選択します。</p><p><img src="/blog/azure-active-directory/customize-your-authentication-flows-with-custom-claims-providers/customize-your-authentication-flows-with-custom-claims-providers8.png"></p><p>管理者は、[<strong>カスタム クレーム プロバイダー</strong>] を選択し、先に作成したカスタム拡張機能を選択し、[<strong>保存</strong>] します。</p><p><img src="/blog/azure-active-directory/customize-your-authentication-flows-with-custom-claims-providers/customize-your-authentication-flows-with-custom-claims-providers9.png"></p><p>最後に、管理者は [<strong>新しいクレームの追加</strong>] を選択し、トークンに発行されるクレームの [<strong>名前</strong>] を入力します。次に [<strong>ソース</strong>] にて [<strong>属性</strong>] を選択し、[<strong>ソース属性</strong>] をプルダウンから選択します (<strong>customClaimsProvider.attributeName</strong> という形式)。そして [<strong>保存</strong>] します。</p><p><img src="/blog/azure-active-directory/customize-your-authentication-flows-with-custom-claims-providers/customize-your-authentication-flows-with-custom-claims-providers10.png"></p><p>これですべての設定が完了しました。ユーザーが Contoso 人事アプリへのサインインを完了すると、カスタム拡張機能がトリガーされます。カスタム クレーム プロバイダーはカスタム拡張機能を使用して、トークンに社員番号を追加します。</p><p>以下はそのフローを示す図です。</p><p><img src="/blog/azure-active-directory/customize-your-authentication-flows-with-custom-claims-providers/customize-your-authentication-flows-with-custom-claims-providers11.png"></p><p>より詳細なビデオ チュートリアルは以下からご覧いただけます: <a href="https://youtu.be/BYOMshjlwbc">https://youtu.be/BYOMshjlwbc</a></p><p>カスタム クレーム プロバイダーは、カスタム拡張機能のまだ最初の利用シナリオの一つでしかありません。今後もカスタム拡張機能のイベントを追加でリリースしていきますので、認証フローをさらにカスタマイズすることができるようにます。</p><p>カスタム拡張機能については <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/custom-extension-overview">こちら</a>、カスタム クレーム プロバイダーについては <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/custom-claims-provider-overview">こちら</a> で詳しく説明しています。カスタム クレーム プロバイダーのセットアップを開始するには、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/custom-extension-get-started?tabs=azure-portal">こちら</a> をご覧ください。</p><p>いつものとおり、皆様のご意見、ご感想、ご提案をお聞かせください。<a href="https://feedback.azure.com/d365community/forum/22920db1-ad25-ec11-b6e6-000d3a4f0789">Azure AD フォーラム</a> で共有するか、以下にコメントください。皆様からのご連絡をお待ちしております。</p><p>よろしくお願いします。</p><p>Alex Simons (@Alex_A_Simons)<br>Corporate VP of Program Management<br>Microsoft Identity Division</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 五十嵐 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 3 月 20 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techc</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>MSOnline / AzureAD PowerShell から Graph PowerShell SDK への移行について 1_概要</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement1/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement1/</id>
    <published>2023-04-13T00:00:00.000Z</published>
    <updated>2023-04-15T23:00:14.154Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>2022-10-03: 本記事の初版を投稿</p><p>2023-04-13: MSOL/AzureAD PowerShell の最新の廃止情報を反映</p></div><p>こんにちは、 Azure ID チームの小出です。</p><p>今回は、MSOnline (以降 MSOL) および Azure AD PowerShell の廃止スケジュールについてご案内します。</p><p>以前より、下記の弊社ブログにて、本内容については案内を行っていますが、情報のアップデートにより、複数の記事に分かれてしまうなどわかりにくくなっている状況でした。そこで今回は、現時点での最新情報と実施いただきたいこと、関連記事の URL などをまとめてご紹介します。</p><h2 id="最新情報-2023-4-13-最終更新-のまとめ"><a href="#最新情報-2023-4-13-最終更新-のまとめ" class="headerlink" title="最新情報 (2023/4/13 最終更新) のまとめ"></a>最新情報 (2023/4/13 最終更新) のまとめ</h2><h3 id="MSOL-Azure-AD-PowerShell-のライセンス割り当て関連のコマンド"><a href="#MSOL-Azure-AD-PowerShell-のライセンス割り当て関連のコマンド" class="headerlink" title="MSOL / Azure AD PowerShell のライセンス割り当て関連のコマンド"></a>MSOL / Azure AD PowerShell のライセンス割り当て関連のコマンド</h3><p>ライセンス割り当てに関する MSOL / Azure AD PowerShell コマンド（Set-MsolUserLicense や Set-AzureADUserLicense など）は、2023/3/31 にすでに廃止されました。まだこのコマンドを利用しているお客様は、早急に新しいコマンドに移行ください。これらのコマンドは今後予告なく動作しなくなります。</p><p>新しいコマンドでのライセンス割り当て方法は、<a href="https://jpazureid.github.io/blog/azure-active-directory/operating-license-with-microsoft-graph/">本ブログ記事</a> にてサンプルを用意しておりますので、併せてご確認ください。</p><ul><li>廃止日を 2022/6/30 や 2022/8/26 などと記載している情報もありますが、ライセンス割り当てに関する MSOL / Azure AD PowerShell コマンドの廃止日は 2023/3/31 です。それ以降の延長はなく 2023/3/31 にすでに廃止されました。</li><li>2023/3/31 を過ぎると MSOL / Azure AD のライセンス割り当ての PowerShell コマンドは予告なく使用できなくなる見込みです。2023/4/1 以降も引き続きテナントによっては動作はする可能性はあり、2023/4/13 現在、弊社検証環境では引き続き Set-MsolUserLicense コマンドでのライセンス付与は実施できています。しかし、いつ利用できなくなってもおかしくない状況です。</li><li>2022/11/1 以降に新しく作成するテナントでは、MSOL / Azure AD PowerShell コマンドによるライセンス割り当て関連のコマンドが、テナント作成時点から正常に動作しません。</li></ul><p>対象となるコマンドの詳細は、<a href="https://jpazureid.github.io/blog/azure-active-directory/migrate-your-apps-to-access-the-license-managements/">こちらの記事</a>の下記該当箇所をご確認ください。</p><table>  <thead>    <tr>      <th>既存のコマンド (2023 年 3 月 31 日以降に利用できなくなる操作)</th>      <th>今後推奨される Microsoft Graph PowerShell および API</th>    </tr>  </thead>  <tbody>    <tr>      <td><a href ="https://docs.microsoft.com/ja-jp/powershell/module/msonline/?view=azureadps-1.0" target="_blank">MSOnline Powershell</a>      <br/>・Set-MsolUserLicense      <br/>・New-MsolUser (-LicenseAssignment か -LicenseOptions を指定)</td>      <td rowspan="2">Microsoft Graph PowerShell      <br/>・<a href="https://docs.microsoft.com/ja-jp/powershell/module/microsoft.graph.users.actions/set-mguserlicense?view=graph-powershell-1.0" target="_blank">Set-MgUserLicense</a>      </td>    </tr>    <tr>      <td><a href="https://docs.microsoft.com/en-us/powershell/azure/active-directory/overview?view=azureadps-2.0">Azure AD Powershell</a>      <br/>・Set-AzureADUserLicense      </td>    </tr>    <tr>      <td>Azure AD Graph API (graph.windows.net)      <br/>・assignLicense</td>      <td>Microsoft Graph API      <br/>・<a href="https://docs.microsoft.com/ja-jp/graph/api/user-assignlicense?view=graph-rest-1.0&tabs=http">assignLicense</a></td>    </tr>      </tbody></table><h3 id="MSOL-Azure-AD-PowerShell-のライセンス割り当て関連「以外」のコマンドについて"><a href="#MSOL-Azure-AD-PowerShell-のライセンス割り当て関連「以外」のコマンドについて" class="headerlink" title="MSOL / Azure AD PowerShell のライセンス割り当て関連「以外」のコマンドについて"></a>MSOL / Azure AD PowerShell のライセンス割り当て関連「以外」のコマンドについて</h3><p>ライセンス割り当てに関するコマンド以外（例: Connect-MsolService や Get-AzureADUser など）は、2023 年 6 月 30 日 に廃止となる予定です。MSOnline モジュール、AzureAD モジュールだけでなく、 AzureADPreview モジュールのコマンドも廃止されます。</p><p>対象となるコマンドは、Connect-MsolService や Get-AzureADUser コマンドだけでなく、 MSOL や AzureAD がつくコマンドすべてです。各モジュールのコマンド一覧は、下記公開情報にて紹介しています。</p><p><a href="https://learn.microsoft.com/ja-jp/powershell/module/msonline/?view=azureadps-1.0#msonline">MSOnline モジュールのコマンド一覧</a><br><a href="https://learn.microsoft.com/en-us/powershell/module/azuread/?view=azureadps-2.0&preserve-view=true">Azure AD モジュールのコマンド一覧（一般提供版）</a><br><a href="https://learn.microsoft.com/en-us/powershell/module/azuread/?view=azureadps-2.0-preview&preserve-view=true">Azure AD モジュールのコマンド一覧（プレビュー版）</a></p><ul><li>廃止予定日までは、これまでと同様にコマンドを利用可能です。</li><li>廃止後は、動作の保証はされません。マイクロソフトは任意のタイミングで、MSOL / Azure AD (Preview) PowerShell の動作を停止する権利を有します。</li><li>ただし、マイクロソフトは使用状況を確認し、お客様が 3 つの PowerShell モジュールから移行するための猶予を提供した上で、これらモジュールの利用を停止させる予定です。</li><li>従来の MSOL / AzureAD モジュールのコマンドでは実施できた操作が、Microsoft Graph API では実施できないものがあります。こうした操作を行う MSOL / Azure AD モジュールのコマンドも最終的には廃止されますが、Microosft Graph API への移行先がないものについては 2023/6/30 を過ぎてすぐにコマンドが利用できなくなることはありません。Microsoft Graph でこれら API の代替の機能が提供されない限り、API およびコマンドレットを停止させることはありません。</li><li>新しいモジュールのコマンドや代替 API があるものについては、2023/6/30 を過ぎるとすぐに利用できなくなる可能性があるため、引き続き早めに移行ください。</li><li>2023/6/30 を過ぎても引き続き利用できるコマンド一覧の情報、実際に動作しなくなる具体的なコマンド一覧の情報などはありません。</li></ul><h2 id="いまできること・確認すること"><a href="#いまできること・確認すること" class="headerlink" title="いまできること・確認すること"></a>いまできること・確認すること</h2><ol><li>現在利用しているコマンド・スクリプトなどを確認する。<a href="https://jpazureid.github.io/blog/azure-active-directory/how-to-determine-depreacated-azuread-msol/">こちらの記事</a>をもとに、MSOL や Azure AD の PowerShell コマンドを利用していないか確認する</li><li>MSOL や Azure AD の PowerShell コマンドを利用している場合、<a href="https://docs.microsoft.com/en-us/powershell/microsoftgraph/azuread-msoline-cmdlet-map?view=graph-powershell-1.0">こちらの公開情報</a> にて対応するコマンドを探す</li><li>既存のスクリプトの書き換え、コマンドの置き換えを実施し、新しいモジュールで動作するよう修正する</li><li>利用中の MSOL や Azure AD コマンドの置き換えとなるものが見つからない、想定したように動作しない場合は、お問い合わせください</li></ol><h2 id="本廃止に関する弊社ブログ記事リンク"><a href="#本廃止に関する弊社ブログ記事リンク" class="headerlink" title="本廃止に関する弊社ブログ記事リンク"></a>本廃止に関する弊社ブログ記事リンク</h2><h3 id="アップデート情報-英語記事翻訳"><a href="#アップデート情報-英語記事翻訳" class="headerlink" title="アップデート情報 (英語記事翻訳)"></a>アップデート情報 (英語記事翻訳)</h3><p><a href="https://jpazureid.github.io/blog/azure-active-directory/migrate-your-apps-to-access-the-license-managements/">Azure AD Graph および MSOnline での従来のライセンスの割り当て方法が廃止され Microsoft Graph によるライセンス管理に変わります</a><br><a href="https://jpazureid.github.io/blog/azure-active-directory/azure-ad-change-management-simplified/">Azure AD の変更管理を簡素化します</a><br><a href="https://jpazureid.github.io/blog/azure-active-directory/Microsoft-Entra-change-announcements-September-2022-train/#Azure-AD%E3%80%81Azure-AD-Preview%E3%80%81MSOnline-PowerShell-%E3%81%AE%E5%BB%83%E6%AD%A2%E3%81%AB%E3%81%A4%E3%81%84%E3%81%A6">Microsoft Entra の変更管理のアナウンス (2022 年 9 月の状況)</a><br><a href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-change-announcements-march-2023-train/">Microsoft Entra の変更のアナウンス (2023 年 3 月の状況)</a></p><h3 id="既存モジュール使用状況について"><a href="#既存モジュール使用状況について" class="headerlink" title="既存モジュール使用状況について"></a>既存モジュール使用状況について</h3><p><a href="https://jpazureid.github.io/blog/azure-active-directory/how-to-determine-depreacated-azuread-msol/">Azure AD Graph / MSOnline PowerShell モジュール利用状況の調べ方</a></p><h3 id="新しいモジュールへの移行導入"><a href="#新しいモジュールへの移行導入" class="headerlink" title="新しいモジュールへの移行導入"></a>新しいモジュールへの移行導入</h3><p><a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement2/">MSOnline / AzureAD PowerShell から Graph PowerShell SDK への移行について 2_移行導入編</a><br><a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement3/">MSOnline / AzureAD PowerShell から Graph PowerShell SDK への移行について 3_インストール・接続編</a></p><h3 id="新しいモジュールの使用方法-ライセンスに関する操作について"><a href="#新しいモジュールの使用方法-ライセンスに関する操作について" class="headerlink" title="新しいモジュールの使用方法 (ライセンスに関する操作について)"></a>新しいモジュールの使用方法 (ライセンスに関する操作について)</h3><p><a href="https://jpazureid.github.io/blog/azure-active-directory/operating-license-with-microsoft-graph/">Microsoft Graph PowerShell SDK を使用したライセンス管理操作の紹介</a></p><h3 id="新しいモジュールの使用方法-ライセンス以外の操作について"><a href="#新しいモジュールの使用方法-ライセンス以外の操作について" class="headerlink" title="新しいモジュールの使用方法 (ライセンス以外の操作について)"></a>新しいモジュールの使用方法 (ライセンス以外の操作について)</h3><p><a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement4/">MSOnline / AzureAD PowerShell から Graph PowerShell SDK への移行について 4_ユーザー管理</a><br><a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement5/">MSOnline / AzureAD PowerShell から Graph PowerShell SDK への移行について 5_グループ管理</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;2022-10-03: 本記事の初版を投稿&lt;/p&gt;&lt;p&gt;2023-04-13: MSOL/AzureAD PowerShell の最新の廃止情報を反映&lt;/p&gt;</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="PowerShell" scheme="https://jpazureid.github.io/blog/tags/PowerShell/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD テナントの追加・変更・削除</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/add-modify-delete-directory/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/add-modify-delete-directory/</id>
    <published>2023-04-07T00:00:00.000Z</published>
    <updated>2023-04-15T23:00:14.066Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は Technet Blog の更新停止に伴い <a href="https://blogs.technet.microsoft.com/jpazureid/2018/01/16/azuread-operation/">TechNet Blog</a> の内容を移行したものです。元の記事の最新の更新情報については、本内容をご参照ください。</p></div><div class="alert is-info"><p class="alert-title">Note</p><p>2018-01-16: 本記事の初版を投稿</p><p>2023-04-07: “管理者以外のユーザーによるテナントの作成を制限する” 機能を追記して全体を更新</p></div><p>こんにちは、Azure &amp; Identity サポート チームの小出です。この記事はもともと 2018 年 1 月に公開されましたが、直近で新しいプレビューが開始されたことに伴い情報を追記して更新しております。</p><p>今回は下記の 3 つについて紹介します。</p><ul><li>Azure AD テナントの追加手順</li><li>Azure AD テナントの変更手順</li><li>Azure AD テナントの削除手順</li></ul><p>まずは、簡単に Azure AD テナントについて説明します。</p><p>Azure AD テナントは、Azure や Office 365 などの Microsoft クラウド サービスに組織がサインアップしたときに作成されます (もう少し平易な言い方をすると、Office 365 など Azure AD テナントが必須のサービスの新規利用を開始した時点で自動的に作成されます)。Azure AD テナントに存在しているユーザーは、その Azure AD テナントに紐づいているクラウド サービスにサインインして利用することが可能です。Azure AD テナントや Azure AD ディレクトリという言葉が出てきますが、どちらも同じ意味とお考えいただいて結構です。</p><p><img src="/blog/azure-active-directory/add-modify-delete-directory/user-access-o365-subscription.png"></p><h2 id="Azure-AD-テナントの追加手順"><a href="#Azure-AD-テナントの追加手順" class="headerlink" title="Azure AD テナントの追加手順"></a>Azure AD テナントの追加手順</h2><p>冒頭で、クラウド サービスにサインアップした際に Azure AD テナントが作成されると書きましたが、Azure AD テナントを個別に追加することも可能です。下記の手順で、Azure AD Free (無料) テナントを作成できます</p><ol><li><p><a href="https://portal.azure.com/">https://portal.azure.com</a> にアクセスし、任意の管理者アカウントでサインインします。</p></li><li><p>ポータル画面左上のナビゲーションの [Azure Active Directory] をクリックします。</p></li><li><p>表示された画面上で [テナントの管理] をクリックし、[+ 作成] を選択します。</p></li><li><p>[ディレクトリの作成] 画面の下記の項目に入力します。</p><ul><li>テナントの種類を選択する: Azure Active Directory</li><li>組織名: 任意の組織名を入力</li><li>初期ドメイン名: &lt;組織&gt; のドメイン名を入力</li><li>場所: 組織が存在する場所を選択</li></ul></li><li><p>[作成] をクリックします。</p></li><li><p>作成が完了すると、”新しいディレクトリを管理するにはここをクリックします” が表示するので、クリックします。</p></li><li><p>新しく作成したディレクトリの画面に切り替わります。</p></li></ol><p>作成操作を行ったユーザーが新しく作成した Azure AD テナントの管理者となります。</p><h3 id="一般ユーザーに対するテナント作成の制限機能"><a href="#一般ユーザーに対するテナント作成の制限機能" class="headerlink" title="一般ユーザーに対するテナント作成の制限機能"></a>一般ユーザーに対するテナント作成の制限機能</h3><p>上記記載の Azure AD テナント作成操作については、以前は管理者側で制限することができず、一般ユーザーであっても新しいテナントを自由に作成できていました。しかしながら、2023 年に一般ユーザーに対して「新しいテナントの作成を制限する」機能が用意されました。このため、下記を利用することで一般ユーザーによるテナントの作成を制限することが可能です。</p><p><img src="/blog/azure-active-directory/add-modify-delete-directory/tenantcreation.png"></p><p>[管理者以外のユーザーによるテナントの作成を制限する (プレビュー)] の設定を “はい” にした場合、グローバル管理者もしくはテナント作成者ロールをもつユーザーのみが、上記操作を行えるようになります。この設定はその他の機能には特に影響ないほか、操作を行ったテナントと新規テナントは全く別物となりますので、設定が同期されてしまうなど相互に影響しあうこともございません。</p><h2 id="Azure-AD-テナントの変更手順"><a href="#Azure-AD-テナントの変更手順" class="headerlink" title="Azure AD テナントの変更手順"></a>Azure AD テナントの変更手順</h2><p>Azure AD テナントは必ず xxxxx.onmicrosoft.com という名前を持ち、この初期ドメイン名を後から変更することはできません。そのため、Azure AD テナントの初期ドメイン名を例えば contoso.onmicrosoft.com にしたい場合は、上記の「Azure AD の追加手順」の手順に従い、Azure AD を一から新規に作成する必要があります。</p><p>なお、Azure AD の組織名 (よく “既定のディレクトリ” と表示されている名称) については下記の手順で変更可能です。</p><ol><li><p><a href="https://portal.azure.com/">https://portal.azure.com</a> にアクセスし、管理者アカウントでサインインします。</p></li><li><p>ポータル画面左上のナビゲーションの [Azure Active Directory] をクリックします。</p></li><li><p>[プロパティ] をクリックします。</p></li><li><p>[名前] の項目に新しい組織名を入力します。</p><p> 例: 既定のディレクトリ –&gt; コントソ株式会社</p></li><li><p>[保存] を押します。</p></li><li><p>少し時間を空けて再度サインインすると、名前が変更されます。</p></li></ol><p>また、ご利用の Azure サブスクリプションを新規で作成した Azure AD に紐づけたいというような要件がある場合には、<a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/transfer-subscription">サブスクリプションの譲渡</a> の方法もご覧ください。</p><h2 id="Azure-AD-テナントの削除手順"><a href="#Azure-AD-テナントの削除手順" class="headerlink" title="Azure AD テナントの削除手順"></a>Azure AD テナントの削除手順</h2><p>手動で作成した Azure AD テナントについては削除が可能です。テナントを削除するためには、以下のような前提条件があります。</p><ul><li>Azure のご契約時に自動的に作成されたディレクトリ (既定のディレクトリ) ではない。</li><li>ディレクトリにユーザーが存在しない (最後の一名の管理者は除く)。</li><li>連携するアプリケーションが存在しない。</li><li>サブスクリプションが紐づいていない。</li><li>など</li></ul><p>テナントの削除手順は以下のとおりです。</p><ol><li><a href="https://portal.azure.com/">https://portal.azure.com</a> にアクセスし、管理者アカウントでサインインします。</li><li>ポータル画面左上のナビゲーションの [Azure Active Directory] をクリックします。</li><li>表示された画面上で [テナントの管理] をクリックし、[ディレクトリの削除] をクリックします。</li><li>前提条件のチェック完了後に [削除] をクリックします。</li></ol><p>削除時に前提条件のチェックが走るため、すべての条件をクリアすることでテナントの削除が可能となります。前提条件に抵触している場合は、下記のように ! の警告が表示され削除を進めることができません。</p><p><img src="/blog/azure-active-directory/add-modify-delete-directory/new6.png"></p><p><img src="/blog/azure-active-directory/add-modify-delete-directory/new7.png"></p><p>なお、Azure のサインアップ時に自動作成された Azure AD テナント (既定のディレクトリ) やセルフサインアップ テナントについては削除が想定されていません。そのディレクトリはもう利用することはないという場合には、そのディレクトリから一名の管理者を除く他のすべてのユーザーを削除する方法で対応ください。テナントは残りますが、実質的に利用できない (利用しても意味のない) テナントとなりますので、削除と同等の結果になります。</p><ol><li><p><a href="https://portal.azure.com/">https://portal.azure.com</a> にアクセスし、管理者アカウントでサインインします。</p></li><li><p>ポータル画面左上のナビゲーションの [Azure Active Directory] をクリックします。</p></li><li><p>[ユーザーとグループ] – [すべてのユーザー] をクリックします。</p></li><li><p>[＋新しいユーザー] をクリックします。</p></li><li><p>ユーザー名を入力し、ロールでは「グローバル管理者」を選択します (最後の一名のアカウントを作成します)。</p><p> 例) 削除対象のディレクトリ名が contoso.onmicrosoft.com の場合: <a href="mailto:&#x74;&#101;&#x6d;&#x70;&#64;&#99;&#111;&#110;&#111;&#116;&#111;&#115;&#x6f;&#46;&#x6f;&#110;&#109;&#x69;&#99;&#114;&#111;&#115;&#111;&#102;&#x74;&#46;&#99;&#x6f;&#x6d;">&#x74;&#101;&#x6d;&#x70;&#64;&#99;&#111;&#110;&#111;&#116;&#111;&#115;&#x6f;&#46;&#x6f;&#110;&#109;&#x69;&#99;&#114;&#111;&#115;&#111;&#102;&#x74;&#46;&#99;&#x6f;&#x6d;</a></p></li><li><p>手順 5. で作成したグローバル管理者のアカウントで <a href="https://portal.azure.com/">https://portal.azure.com</a> にサインインします。</p></li><li><p>[すべてのユーザー] まで移動して、その他のすべてのアカウントをこのテナントから削除します。</p></li></ol><p>削除されたユーザーで、対象のテナントにアクセスができないことを確認ください。</p><h2 id="補足"><a href="#補足" class="headerlink" title="補足"></a>補足</h2><p>複数の Azure AD テナントは完全に独立したリソースとして管理されます。そのため、Azure AD テナント間の連携が必要なシナリオの場合は、Azure AD B2B の利用をします。B2B については下記の記事を合わせてご参照ください。</p><p><a href="https://blogs.technet.microsoft.com/jpazureid/2017/12/12/about-azure-ad-b2b/">Azure AD B2B とは</a></p><p>上記内容が少しでも皆様の参考となりますと幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は Technet Blog の更新停止に伴い &lt;a href=&quot;https://blogs.technet.microsoft.com/jpazure</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD における入れ子 (ネスト) グループへの権限付与について</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/nesting-group/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/nesting-group/</id>
    <published>2023-04-06T23:00:00.000Z</published>
    <updated>2023-04-15T23:00:14.534Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は Technet Blog の更新停止に伴い <a href="https://blogs.technet.microsoft.com/jpazureid/2019/02/06/nesting-group/">TechNet Blog</a> の内容を移行したものです。元の記事の最新の更新情報については、本内容をご参照ください。</p></div><div class="alert is-info"><p class="alert-title">Note</p><p>2019-02-06: 本記事の初版を投稿</p><p>2023-04-07: 最新の公開情報リンクへの差し替えなど更新</p></div><p>こんにちは、 Azure Identity の平形です。</p><p>今回は Azure AD における入れ子 (ネスト) グループの対応状況についてお伝え致します。本記事は記事はは当初 2019 年 2 月に公開されましたが、その後 Azure ポータルのメニューなどが変更されたため、内容を最新版に更新いたしました。</p><h2 id="入れ子のグループとは"><a href="#入れ子のグループとは" class="headerlink" title="入れ子のグループとは"></a>入れ子のグループとは</h2><p>そもそも入れ子のグループとは、グループの中にグループを所属させているグループを指します。以下の図をご覧ください。</p><p><img src="/blog/azure-active-directory/nesting-group/333.jpg"></p><p>この場合はグループ A が入れ子のグループです。グループ A の中にはグループ B とユーザー B が含まれています。そしてユーザー A はグループ B に含まれている状態ですが、実際の挙動としてユーザー A はグループ A に含まれていると考えて良いかどうかが今回のテーマです。</p><p>例えば、アクセス権限をグループ A に割り当てた場合、ユーザー A に対してもアクセス権限が割り当てられることが期待されますが、 Azure AD の機能によっては必ずしもそうならず、いくつかの制限事項があります。ここではよくお問い合わせ頂く制限事項についてご紹介します。</p><h2 id="Azure-AD-における入れ子グループの制限"><a href="#Azure-AD-における入れ子グループの制限" class="headerlink" title="Azure AD における入れ子グループの制限"></a>Azure AD における入れ子グループの制限</h2><p>主にお問い合わせ頂く機能の中で、現時点では以下の機能については入れ子グループに対応していません。</p><ul><li>グループ ベースのライセンス付与</li><li>エンタープライズ アプリケーションのユーザーおよびグループの割り当て</li></ul><p>上記はグループに直接所属しているユーザーにのみ機能が割り当てられます。一方、条件付きアクセスの機能でグループを条件として設定した場合、入れ子のグループにも対応しており、上の例でいえばグループ A を対象とした条件付きアクセス ポリシーは、ユーザー A も対象になります。</p><p>実際のシナリオを考えてみましょう。グループ A に対して例えば Office 365 E3 のライセンスを割り当てた場合、先程の図のパターンに当てはめると以下のような結果になります。</p><p>例: グループ A に権限を割り当てた場合</p><p><img src="/blog/azure-active-directory/nesting-group/ssssss.jpg"></p><p>ユーザー A はグループ A の直属のメンバーでは無いため、グループ A にライセンスを割り当てても、配下のグループ B に所属しているユーザー A に対してはライセンスが付与されません。ユーザー B はグループ A の直接のメンバーであるため、問題なく権限が割り当てられます。このシナリオは Office 365 E3 のライセンスを割り当てた場合としましたが、エンタープライズ アプリケーションの割り当ての場合にも同様の動作となります。</p><h2 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a>参考情報</h2><p>Azure Active Directory のライセンス管理にグループを使用する際のシナリオ、制限、および既知の問題<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/users-groups-roles/licensing-group-advanced">https://docs.microsoft.com/ja-jp/azure/active-directory/users-groups-roles/licensing-group-advanced</a></p><p>SaaS アプリケーションへのアクセスをグループで管理する<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/users-groups-roles/groups-saasapps">https://docs.microsoft.com/ja-jp/azure/active-directory/users-groups-roles/groups-saasapps</a></p><p>Azure AD サービスの制限と制約 (表内グループの項目でも、本記事に記載の内容を確認できます。)<br><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/enterprise-users/directory-service-limits-restrictions">https://learn.microsoft.com/ja-jp/azure/active-directory/enterprise-users/directory-service-limits-restrictions</a></p><h2 id="備考"><a href="#備考" class="headerlink" title="備考"></a>備考</h2><p>グループの入れ子については多くのお客様よりフィードバックをいただいており、弊社開発部門も実装を検討しています。</p><p><a href="https://feedback.azure.com/d365community/idea/fa8991c1-b125-ec11-b6e6-000d3a4f0789">https://feedback.azure.com/d365community/idea/fa8991c1-b125-ec11-b6e6-000d3a4f0789</a></p><p>上記のフィードバックサイトは開発部門が閲覧しており、フィードバックが多い機能や要望は今後の Azure 機能拡張の参考にしています。</p><p>グループの入れ子については、階層が深い場合や、グループの入れ子構造がループしている場合の検出など技術的に考慮すべき部分もあり現状はサポートされていない機能が多い状況です。グループの入れ子に対応していないことで不便さを感じられている方は、是非上記のフィードバック サイトから投票ください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は Technet Blog の更新停止に伴い &lt;a href=&quot;https://blogs.technet.microsoft.com/jpazure</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
  </entry>
  
  <entry>
    <title>[調査に有効な採取情報] Azure AD に関する問題全般</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/troubleshoot-azure-ad/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/troubleshoot-azure-ad/</id>
    <published>2023-04-06T22:00:00.000Z</published>
    <updated>2023-04-15T23:00:14.670Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は Technet Blog の更新停止に伴い <a href="https://blogs.technet.microsoft.com/jpazureid/2017/10/24/%e8%aa%bf%e6%9f%bb%e3%81%ab%e6%9c%89%e5%8a%b9%e3%81%aa%e6%8e%a1%e5%8f%96%e6%83%85%e5%a0%b1-azure-ad-%e3%81%ab%e9%96%a2%e3%81%99%e3%82%8b%e5%95%8f%e9%a1%8c%e5%85%a8%e8%88%ac/">TechNet Blog</a> の内容を移行したものです。元の記事の最新の更新情報については、本内容をご参照ください。</p></div><div class="alert is-info"><p class="alert-title">Note</p><p>2017-10-24: 本記事の初版を投稿</p><p>2023-04-07: 古い情報を最新のものに更新</p></div><p>こんにちは、Azure &amp; Identity サポート チームの小出です。</p><p>今回は Azure AD に関する問題についてサポートに問い合わせる際に問い合わせに含めることを推奨する情報についてご紹介します。本記事は 2017-10-24 に投稿されたものですが、古い情報を更新し改めて案内しております。</p><p>ここでご紹介する情報は、Azure AD が関係するようなお問い合わせではおおむねどのようなケースにおいても調査に必要になる情報となります。エラーが発生する、正しく動作しないなどの理由でお問い合わせを起票する際には、下記情報も併せてお寄せください。</p><h2 id="お問い合わせ起票時に注意すること"><a href="#お問い合わせ起票時に注意すること" class="headerlink" title="お問い合わせ起票時に注意すること"></a>お問い合わせ起票時に注意すること</h2><p>お問い合わせ起票時に「高度な診断設定」を「はい」に設定すると、Azure サポートでは、お客様のデータ プライバシーに配慮をしつつ、トラブル シューティングに必要な範囲でデータセンター上からお客様環境の情報へアクセスを行うことができます。これにより、お客様にて手動で情報を抽出し、弊社に送信いただくといった手間が省けます。</p><p>トラブル シューティングのお問い合わせの場合、この診断設定が許可されていないと、お客様から連携いただいたログ以外の情報を確認することができません。周辺日時や関連のログなどを確認し、迅速に解決策をご案内できるよう、トラブル シューティングのお問い合わせでは可能な限り、こちらで「はい」を選択していただくことをお勧めいたします。</p><p>詳細を確認されたい場合、下記参考情報もご利用ください。</p><ul><li><a href="https://jpaztech.github.io/blog/information/How-to-inquiry-to-the-Azure-Support/">お問い合わせの発行方法について</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-portal/supportability/how-to-create-azure-support-request#advanced-diagnostic-information-logs">詳細診断情報ログ</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/azure-portal/supportability/how-to-manage-azure-support-request#allow-collection-of-advanced-diagnostic-information">高度な診断情報の収集を許可</a></li></ul><h2 id="お問い合わせ時に合わせて提供いただくと有効な情報"><a href="#お問い合わせ時に合わせて提供いただくと有効な情報" class="headerlink" title="お問い合わせ時に合わせて提供いただくと有効な情報"></a>お問い合わせ時に合わせて提供いただくと有効な情報</h2><p>a) 問題が起きているテナント及び問題に関係しているテナントの Tenant ID か初期ドメイン (******.onmicrosoft.com)</p><p>上記情報は Azure ポータルから問題の発生しているテナントのユーザーでお問い合わせを発行された場合にはサポートにて確認できるので不要です。</p><p>b) 作業対象のユーザーや問題が発生しているユーザーの情報 (UPN、メンバーかゲスト ユーザーか、どのテナントのユーザーか)</p><p>c) 問題ステップ記録 (PSR) ツール情報</p><p>問題ステップ記録ツール (以降、PSR) は、クリックした場所の説明や、表示される画面のスクリーン ショット、その日時などを自動的にキャプチャするツールです。PSR 情報から得られた各オペレーションの実行日時を元に、後述の各種情報から調査・追跡を行うために採取していただきます。PSR の取得手順については後述します。</p><p>d) エラー コード</p><p>下記のようなエラー コードがあるとサポート エンジニアは同様のエラーが出力された事例の調査ができます。また、開発エンジニアの確認が必要になるケースでもエラー コードを元に大まかな要因を特定できる可能性があります。</p><blockquote><p>AADSTS65005: Invalid resource. The client has requested access to a resource which is not listed in the requested permissions in the client’s application registration. Client app ID: f1764360-e0ec-4446-911e-cd6fc0d4dd61. Resource value from request: . Resource app ID: 00000002-0000-0000-c000-000000000000. List of valid resources from app registration: .</p></blockquote><blockquote><p>Exception mapped to interrupt error code: Microsoft.AzureAD.Telemetry.Diagnostics.ServiceException: AADSTS65001: The user or administrator has not consented to use the application with ID ‘box.net’ named ‘Windows Azure Active Directory’. Send an interactive authorization request for this user and resource.</p></blockquote><p>e) Trace ID、または Correlation ID と Timestamp のセット</p><p>サインインなどに失敗し、エラー画面が出力される際に、Trace ID か Correlation ID と Timestamp のセットが出力されることがあります。下記のような Trace ID か Correlation ID と Timestamp のセットが含まれる画面ショットがあると、その情報をもとに Azure のプラットフォーム側のログを確認できます。</p><blockquote><p>Trace ID: 5c19f807-1e0b-489e-ae3b-26c975a20500</p></blockquote><p>もしくは</p><blockquote><p>Correlation ID: e9065a31-0768-44bf-b762-c9e37c9fd8d0</p></blockquote><p>および</p><blockquote><p>Timestamp: 2017-09-12 06:32:13Z</p></blockquote><h2 id="PSR-を採取する手順"><a href="#PSR-を採取する手順" class="headerlink" title="PSR を採取する手順"></a>PSR を採取する手順</h2><p>問題ステップ記録ツールの利用手順は以下のとおりです。以下の手順で、PSR 情報の記録を開始します。不要な情報の採取を避けるために、全ての不要なウィンドウを事前に閉じておくことをお勧めいたします。以下の手順で PSR を起動します。</p><ol><li><p>Windows ボタンを右クリックして [ファイル名を指定して実行] にて psr.exe と入力し、[OK] をクリックします。</p></li><li><p>“問題ステップ記録ツール” が起動しましたら、右端の ▼ をクリックし、表示されるメニューから [設定]をクリックします。</p></li><li><p>“保存する最新の取り込み画像数” を 25 から 100 に変更し、OK をクリックします。</p></li></ol><p>以下の手順で PSR 情報の記録を開始します。</p><ol start="4"><li><p>“問題ステップ記録ツール” の画面を前面に出します。</p></li><li><p>[記録の開始] をクリックします。</p></li><li><p>“問題ステップ記録ツール” の画面を最小化します。</p></li></ol><p>  ※ 目的の画面が隠れないように、必ず最小化します。</p><ol start="7"><li>事象の発生を確認します</li></ol><div class="alert is-info"><p class="alert-title">Note</p><p>Azure ポータルや Office ポータルなどで操作する場合には言語設定を一時的に英語にしておくことを推奨します。ここで取得する情報をグローバルの開発担当エンジニアやデータセンターエンジニアが確認する可能性があるためです。</p></div><ol start="8"><li>PSR 情報の記録を停止します</li></ol><p>以下の手順で PSR 情報の記録を停止して採取します。</p><ol start="9"><li><p>“問題ステップ記録ツール” の画面を前面に出します。</p></li><li><p>[記録の停止] をクリックします。</p></li><li><p>ファイルの保存場所、ファイル名を指定し、保存致します。</p></li><li><p>作成されました ZIP ファイルをお問い合わせ時に提供下さい。</p></li></ol><p>ここで案内しました情報を事前に取得し、お問い合わせと合わせてご提供いただくことで次のようなメリットがあります。</p><ul><li>お問い合わせに対する回答・問題解決をより迅速にすることができます。</li><li>後々、問題が再現できなくなり、問題発生時の情報がないために、問題の発生要因を追及できなくなるケースが減らせます。</li><li>サポート エンジニアより情報採取を案内される分のやり取りを減らせます。</li></ul><p>上記内容が参考となりましたら幸いです。問題によっては、再現頻度が少ないなどのことから、上記情報の提供が難しい場合もあるかと思います。この場合は、まずは可能な限りの詳細を把握したうえで、お問い合わせを発行いただいてもかまいません。その際はサポートエンジニアから詳細をお伺いし、必要な情報採取の詳細をガイドさせていただきます。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は Technet Blog の更新停止に伴い &lt;a href=&quot;https://blogs.technet.microsoft.com/jpazure</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD B2B ゲスト ユーザーの連絡先情報の更新方法について</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/update-B2B-user-address/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/update-B2B-user-address/</id>
    <published>2023-04-06T21:00:00.000Z</published>
    <updated>2023-04-15T23:00:14.678Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>2020-10-22: 本記事の初版を投稿</p><p>2023-04-07: ポータル上の画面が変更されたことに伴い新しい画面ショットの案内を追記し更新</p></div><p>こんにちは、Azure Identity サポート チームの小田です。</p><p>今回は、Azure AD B2B ゲストユーザーの連絡先情報（電子メール / 連絡用メールアドレス）の更新方法についてご案内いたします。</p><p>Azure AD テナントにて別組織のユーザーを招待しますと、テナントにゲスト ユーザーが作成されます。ゲスト ユーザーの連絡先情報（電子メール / 連絡用メールアドレス）には、招待したときに指定した E メール アドレスが設定され、これらは Azure 側からの通知メール (計画メンテナンスなど) の宛先として使用されます。</p><p>ゲスト ユーザーが招待を承諾した後で、そのユーザーの実体が登録されているホーム テナント側で E メール アドレスの変更があった場合、そのユーザーをゲストとして登録しているリソース テナント側では、E メール アドレスの変更は反映されません。</p><p>そのため、ゲスト ユーザーがホーム テナント側で持っている属性値 (E メール アドレス等) を修正する場合、これまではゲスト ユーザーを一旦削除して「再招待」を実施するか、Microsoft Graph API、Exchange 管理センター、または Exchange Online PowerShell 経由で更新する必要がありました。</p><p>しかしながら、2020 年 10 月現在、ゲスト ユーザーの連絡先情報（電子メール / 連絡用メールアドレス）は、Azure AD 管理センターにて編集可能になりました。再招待を実施することなく、ゲスト ユーザーのメール アドレスの変更を変更する具体的な手順は、下記のとおりです。</p><h2 id="変更手順"><a href="#変更手順" class="headerlink" title="変更手順"></a>変更手順</h2><ol><li>Azure ポータル <a href="https://portal.azure.com/">(https://portal.azure.com/)</a> にアクセスし、グローバル管理者もしくはユーザー管理者にてサインインします。</li><li>[Azure Active Directory] - [ユーザー] - [すべてのユーザー] - [編集対象のゲストユーザー] をクリックし、[プロパティ] を開きます。</li><li>[編集] をクリックし、「連絡先情報」を編集します。</li></ol><p><img src="/blog/azure-active-directory/update-B2B-user-address/address-update-in-AzurePortal.png"></p><ol start="4"><li>[保存] をクリックします。</li></ol><h2 id="変更手順-新しいプレビュー画面の場合"><a href="#変更手順-新しいプレビュー画面の場合" class="headerlink" title="変更手順 (新しいプレビュー画面の場合)"></a>変更手順 (新しいプレビュー画面の場合)</h2><p>Azure ポータルでは現在、ユーザーの画面については新しいプレビュー画面を利用可能です。新しい画面を利用している場合は、下記手順をご利用ください。</p><p>なお、従来の画面の “電子メール” は新しい画面の “メール” の項目に該当し、 “連絡用メール アドレス” は “その他のメール” の項目が該当します。</p><ol><li>Azure ポータル <a href="https://portal.azure.com/">(https://portal.azure.com/)</a> にアクセスし、グローバル管理者もしくはユーザー管理者にてサインインします。</li><li>[Azure Active Directory] - [ユーザー] - [すべてのユーザー] - [編集対象のゲストユーザー] をクリックし、[プロパティ] を開きます。</li><li>[編集] をクリックし、「連絡先情報」のタブを開きます。”メール” および “その他のメール”を編集します。</li></ol><p><img src="/blog/azure-active-directory/update-B2B-user-address/address-update-in-aad2.png"></p><ol start="4"><li>[保存] をクリックします。</li></ol><h2 id="参考情報"><a href="#参考情報" class="headerlink" title="参考情報"></a>参考情報</h2><p>Azure Active Directory B2B コラボレーション ユーザーのプロパティ<br><a href="https://docs.microsoft.com/ja-jp/azure/active-directory/external-identities/user-properties#can-i-update-a-guest-users-email-address">https://docs.microsoft.com/ja-jp/azure/active-directory/external-identities/user-properties#can-i-update-a-guest-users-email-address</a></p><p>Changelog for Microsoft Graph<br><a href="https://docs.microsoft.com/en-us/graph/changelog">https://docs.microsoft.com/en-us/graph/changelog</a></p><p>なお、Azure ポータルでは、ゲスト ユーザーだけではなく、組織内ユーザーに対しても E メール アドレスを変更することが可能です。組織内のユーザーは、Exchange Online のライセンスが割り当たっている可能性もありますので、このような場合は、 Exchange Online 側で E メールアドレス操作を実施ください。</p><p>上記内容が少しでも参考となりますと幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;2020-10-22: 本記事の初版を投稿&lt;/p&gt;&lt;p&gt;2023-04-07: ポータル上の画面が変更されたことに伴い新しい画面ショットの案内を追記し更新&lt;/</summary>
      
    
    
    
    
    <category term="Azure AD B2B" scheme="https://jpazureid.github.io/blog/tags/Azure-AD-B2B/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Entra の最新情報</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-updates-you-may-have-missed/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-updates-you-may-have-missed/</id>
    <published>2023-04-06T00:00:00.000Z</published>
    <updated>2023-04-15T23:00:14.518Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 小出 です。</p><p>本記事は、2023 年 3 月 24 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/microsoft-entra-updates-you-may-have-missed/ba-p/2967449">microsoft-entra-updates-you-may-have-missed</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>マイクロソフトの第 2 四半期は、Microsoft Entra のセキュリティ機能のアップデートが行われ、また、組織のセキュリティ態勢を改善するためのセキュリティ分野の幅広い機能領域で一般提供の発表が行われた年でした。</p><p>以下にて、新しく追加された機能のリストをご案内しています。発表された内容を見逃した場合や、マイクロソフトが追加した内容を素早く確認したい場合は、以下のリストをご利用ください。これらのアップデートはエリアごとに整理されており、興味のある分野を簡単に見つけて確認することができます。</p><h2 id="ID-の保護"><a href="#ID-の保護" class="headerlink" title="ID の保護"></a>ID の保護</h2><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-conditional-access-cloud-apps#authentication-context">条件付きアクセスの認証コンテキスト</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-staged-rollout#enable-staged-rollout">段階的なロールアウトを利用した CBA のテスト</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/reports-monitoring/concept-sign-ins">サインイン ログで NPS 拡張機能と AD FS MFA アダプターの MFA イベントを表示する</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/identity-protection/concept-identity-protection-risks#user-linked-detections">ディレクトリの異常な変更に基づくユーザー侵害の検出</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/how-to-mfa-server-migration-utility">Azure 多要素認証 (MFA) サーバー移行</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/howto-conditional-access-session-lifetime#require-reauthentication-every-time">Intune 登録時の強制再認証とリスクのあるサインイン/ユーザーへの対応機能</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/identity-protection/concept-identity-protection-risks">ユーザーを対象とした認証後の異常行動検知</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/identity-protection/concept-workload-identity-risk#workload-identity-risk-detections">サービス プリンシパルの異常な資格情報の変更を検出する</a></li></ul><h2 id="ID-の刷新"><a href="#ID-の刷新" class="headerlink" title="ID の刷新"></a>ID の刷新</h2><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/role-based-access-control/conditions-overview">Azure Blob Services の属性ベースのアクセス制御 - ABAC</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/external-identities/direct-federation">単一の SAML/WS-Fed ベースの IdP を複数のドメインで構成する</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/devices/device-management-azure-portal#configure-device-settings">全ユーザーの Bitlocker セルフサービス リカバリーをブロックする</a>  </li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/roles/admin-units-members-add">管理単位でグループを作成する</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/fundamentals/recover-from-deletions#administrative-units">管理単位とデバイスの論理削除について</a> </li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/hybrid/how-to-connect-fed-group-claims">正規表現を使ってトークン要求のグループ名をフィルタリングして変換する</a>  </li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/active-directory-saml-claims-customization#claim-transformations">アプリケーションの統合と移行のための複数値に対するクレーム変換</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/roles/administrative-units">デバイスの管理単位でのサポート</a></li></ul><h2 id="Identity-Governance"><a href="#Identity-Governance" class="headerlink" title="Identity Governance"></a>Identity Governance</h2><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/lighthouse/how-to/create-eligible-authorizations">Azure Lighthouse のための PIM における権限ある認可について</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/app-provisioning/on-premises-application-provisioning-architecture">オンプレミスのアプリケーションにユーザーをプロビジョニングする</a>  </li></ul><h2 id="パスワードレス"><a href="#パスワードレス" class="headerlink" title="パスワードレス"></a>パスワードレス</h2><ul><li><a href="https://learn.microsoft.com/ja-jp/windows/security/identity-protection/hello-for-business/hello-hybrid-cloud-kerberos-trust">Windows Hello for Business (WHFB) のクラウド信頼性</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/howto-authentication-temporary-access-pass">AADJ デバイスの Windows Web サインインを一時アクセス パスのみ使用するよう制限する</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/howto-authentication-passwordless-phone#multiple-accounts-on-ios">iOS 端末の複数パスワードレス電話サインインについて</a></li></ul><h2 id="外部-ID-B2B-amp-B2C"><a href="#外部-ID-B2B-amp-B2C" class="headerlink" title="外部 ID (B2B &amp; B2C)"></a>外部 ID (B2B &amp; B2C)</h2><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/external-identities/reset-redemption-status">ゲストユーザーの引き換えステータスをリセットする</a></li></ul><h2 id="過去に発表されたアップデート"><a href="#過去に発表されたアップデート" class="headerlink" title="過去に発表されたアップデート"></a>過去に発表されたアップデート</h2><p>さらに、マイクロソフトは以前、当社のセキュリティ サービスを強化するためのいくつかのアップデートを発表しました。これらのアップデートには、証明書ベースの認証、FIPS 140 への準拠、Microsoft Authenticator アプリの高度な機能などが含まれています。これらのアップデートとその機能の詳細については、以下のリンクをご確認ください。</p><ul><li><a href="https://jpazureid.github.io/blog/azure-active-directory/azure-ad-certificate-based-authentication-cba-on-mobile/">モバイル端末での Azure AD 証明書ベース認証 (CBA) (サポート チームによる翻訳)</a></li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-brings-fips-140-compliance/">Microsoft Authenticator が FIPS 140 に準拠しました (サポート チームによる翻訳)</a></li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/defend-your-users-from-mfa-fatigue-attacks/">Microsoft Authenticator の MFA 疲労攻撃対策 - 数値の一致による MFA が 有効化されます (サポート チームによる翻訳)</a></li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/ca-filter-for-apps/">アプリの条件付きアクセス フィルターがパブリック プレビューになりました (サポート チームによる翻訳)</a></li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-workload-id-ga/">Microsoft Entra ワークロード ID の一般提供 (サポート チームによる翻訳)</a></li></ul>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 小出 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 3 月 24 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techco</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>Microsoft Entra の変更のアナウンス (2023 年 3 月の状況)</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-change-announcements-march-2023-train/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/microsoft-entra-change-announcements-march-2023-train/</id>
    <published>2023-04-03T00:00:00.000Z</published>
    <updated>2023-04-15T23:00:14.510Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 高田 です。</p><p>本記事は、2023 年 3 月 31 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/microsoft-entra-change-announcements-march-2023-train/ba-p/2967448">Microsoft Entra Change Announcements – March 2023 Train</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>皆さん、こんにちは。</p><p>本日は、3 月分の機能変更と重大な変更について紹介します。これらの変更は、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/fundamentals/whats-new">リリースノート</a> や電子メールでもお伝えしています。また、お客様が新しい Entra 管理センターでライフサイクルの変更 (廃止、サポート終了、サービスの重大な変更) を管理しやすくするための取り組みも続けています。さらに今後、新機能のリリースをこのブログ記事の一部として掲載し、既存機能の変更と新機能の両方を 1 つのリストで確認できるようにする予定です。</p><p>2023 年 3 月の変更は以下のとおりです。</p><h2 id="セキュリティの改善"><a href="#セキュリティの改善" class="headerlink" title="セキュリティの改善"></a>セキュリティの改善</h2><h3 id="番号の一致機能に関するメッセージ-センターへの投稿内容の更新"><a href="#番号の一致機能に関するメッセージ-センターへの投稿内容の更新" class="headerlink" title="番号の一致機能に関するメッセージ センターへの投稿内容の更新"></a>番号の一致機能に関するメッセージ センターへの投稿内容の更新</h3><p>Microsoft Authenticator アプリの番号の一致機能は、2022 年 11 月に GA しました。Microsoft Authenticator のプッシュ通知を利用しているユーザーに番号の一致機能をスムーズに展開するために、まだ展開の制御機能 (Azure Portal の管理画面と Microsoft Graph API から利用可能) を利用されていない場合は、ぜひ活用されることをお勧めします。弊社では以前、2023 年 2 月 27 日から Microsoft Authenticator のプッシュ通知のすべての利用者に対して、管理者用の設定を削除し、テナント全体で番号の一致機能を強制すると発表していました。しかしながら、お客様の声に耳を傾けた結果、管理者用の設定を利用できる期間をあと数週間延長することにいたしました。組織は、<strong>2023 年 5 月 8 日</strong> まで、既存の展開の制御設定を使用して、組織で番号の一致機能を展開することができます。マイクロソフトは、2023 年 5 月 8 日以降、Microsoft Authenticator のプッシュ通知を利用するすべてのユーザーに対して、番号の一致機能の強制を開始する予定です。また、その日以降、番号の一致に関する管理者用の設定機能を削除する予定です。</p><p>お客様側で 2023 年 5 月 8 日より前にすべてのユーザーに Microsoft Authenticator プッシュ通知の番号一致機能を有効にしない場合、マイクロソフト側でこの変更を強制的に展開しますが、その間、ユーザーのサインイン時の動作が一貫性のないものになる可能性があります。すべてのユーザーで一貫した動作とするために、事前に Microsoft Authenticator のプッシュ通知の番号一致機能を有効にすることを強くお勧めします。詳細については、以下をご覧ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/how-to-mfa-number-match">多要素認証 (MFA) 通知で数値の一致を使用する方法 - 認証方法ポリシー</a></li><li><a href="https://jpazureid.github.io/blog/azure-active-directory/defend-your-users-from-mfa-fatigue-attacks/">Microsoft Authenticator の MFA 疲労攻撃対策 - 数値の一致による MFA が 有効化されます</a></li></ul><h3 id="Azure-Multifactor-Authentication-MFA-Server"><a href="#Azure-Multifactor-Authentication-MFA-Server" class="headerlink" title="Azure Multifactor Authentication (MFA) Server"></a>Azure Multifactor Authentication (MFA) Server</h3><p>2024 年 9 月 30 日より、展開済みの Azure Multifactor Authentication (MFA) Server は、多要素認証 (MFA) リクエストに応答しなくなり、お客様の組織では認証に失敗する可能性があります。認証機能の利用を中断させず、サポートされた状態を維持するため、お客様におかれましては、最新の <a href="https://www.microsoft.com/en-us/download/details.aspx?id=55849">Azure MFA Server の更新</a> に含まれる移行ユーティリティを使用して、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/how-to-migrate-mfa-server-to-azure-mfa-user-authentication">ユーザーの認証データをクラウド ベースの Azure MFA サービスに移行</a> ください。詳しくは、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/how-to-migrate-mfa-server-to-azure-mfa-user-authentication">Azure MFA Server の移行</a> をご覧ください。</p><h3 id="システムが推奨する認証方式の有効化"><a href="#システムが推奨する認証方式の有効化" class="headerlink" title="システムが推奨する認証方式の有効化"></a>システムが推奨する認証方式の有効化</h3><p>現在、さまざまな認証方式をユーザーが選んだ既定の方法として選択できるようになっています。しかし、すべての認証方式が同じレベルのセキュリティを提供するわけではありません。特にフィッシングに強い認証方法の代わりに、安全性の低い認証方法が選択された場合には、組織に潜在的なリスクが生じます。</p><p>これに対処するため、MFA にシステムが推奨する認証方式 (システム優先 MFA 機能) を導入します。この機能が有効になると、MFA の実行時に、ユーザーの登録した認証方法のうち最も安全な認証方法が、第二認証要素として要求されるようになります。これにより、より安全な方法が登録され利用可能な場合でも、ユーザーが指定した既定の方法が選択され、常にその方法が最初に要求されるという、以前の機能が置き換えられます。この機能は、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/concept-system-preferred-multifactor-authentication?branch=pr-en-us-227476#enable-system-preferred-mfa">Microsoft Graph API</a> を使用することで、<strong>本日より利用可能</strong> です。この機能を有効にすると、ユーザーは、利用可能な最も推奨された認証方法を使用してサインインするよう促されます。詳しくは、<a href="https://learn.microsoft.com/en-us/azure/active-directory/authentication/concept-system-preferred-multifactor-authentication?branch=pr-en-us-227476">システム優先多要素認証の記事</a> ご確認ください。</p><h3 id="条件付きアクセスの「承認されたクライアント-アプリが必要です」の廃止"><a href="#条件付きアクセスの「承認されたクライアント-アプリが必要です」の廃止" class="headerlink" title="条件付きアクセスの「承認されたクライアント アプリが必要です」の廃止"></a>条件付きアクセスの「承認されたクライアント アプリが必要です」の廃止</h3><p><strong>2026 年 3 月 31 日に、Azure Active Directory (Azure AD) 条件付きアクセスの 「承認されたクライアント アプリを要求する」の制御が提供終了となり、適用されなくなります。</strong> この日までに、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/conditional-access/concept-conditional-access-grant#require-app-protection-policy">アプリの保護ポリシーが必要</a> の制御に移行して使用を開始する必要があります。<a href="https://learn.microsoft.com/en-us/azure/active-directory/conditional-access/concept-conditional-access-grant#require-app-protection-policy">アプリの保護ポリシーが必要</a> は「承認されたクライアント アプリを要求する」の機能をすべて備えており、加えて以下のような利点もありますので、この恩恵を得るために、早めに移行することをお勧めします。</p><ul><li>対応する Intune ポリシーも検証される。</li><li>ユーザーにアクセスが許可される前に適用される。</li><li>セキュリティが強化されている。</li></ul><p>サービスの利用が中断されるのを避けるため、<strong>2026 年 3 月 31 日までに Azure AD の条件付きアクセスで「アプリ保護ポリシーが必要」の制御を利用する</strong>よう <a href="http://aka.ms/RetireApprovedClientApp">移行</a> ください。ご質問がある場合は、<a href="http://aka.ms/ApprovedClientAppRetirementQA">Microsoft Q&amp;A</a> でコミュニティの専門家にもご質問ください。</p><h3 id="従来の多要素認証-MFA-およびセルフサービス-パスワード-リセット-SSPR-ポリシーにおける認証方法の管理の廃止"><a href="#従来の多要素認証-MFA-およびセルフサービス-パスワード-リセット-SSPR-ポリシーにおける認証方法の管理の廃止" class="headerlink" title="従来の多要素認証 (MFA) およびセルフサービス パスワード リセット (SSPR) ポリシーにおける認証方法の管理の廃止"></a>従来の多要素認証 (MFA) およびセルフサービス パスワード リセット (SSPR) ポリシーにおける認証方法の管理の廃止</h3><p><strong>2024 年 9 月 30 日</strong> 以降、従来の <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/howto-mfa-mfasettings#verification-methods">MFA</a> および <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/concept-sspr-howitworks#authentication-methods">SSPR</a> ポリシーで認証方法を管理することはできなくなります。組織は、パスワードレス、多要素認証、セルフサービス パスワード リセットを含むすべての認証方法を一元的に管理できる、統合された認証方法のポリシーに管理方法を <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/how-to-authentication-methods-manage">移行する</a> 必要があります。詳しくは、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/concept-authentication-methods-manage">Azure AD の認証方式を管理する</a> をご覧ください。</p><h3 id="Azure-AD-で-IPv6-がサポート"><a href="#Azure-AD-で-IPv6-がサポート" class="headerlink" title="Azure AD で IPv6 がサポート"></a>Azure AD で IPv6 がサポート</h3><p>以前、弊社では Microsoft Azure AD に IPv6 サポートを導入し、お客様が IPv4、IPv6、またはデュアル スタックのエンドポイントを経由してAzure AD のサービスにアクセスできるようにする計画を <a href="https://jpazureid.github.io/blog/azure-active-directory/ipv6-coming-to-azuread/">発表</a> しました。改めて、<strong>2023 年 3 月 31 日</strong> から段階的に Azure AD サービスに IPv6 サポートを導入し始めることをここでお知らせします。</p><p>ネットワークが IPv6 をサポートしていない場合、設定やポリシーを変更するためにアクションは必要はありません。ほとんどのお客様にとって、IPv4 の利用が完全に消えることはないため、Azure AD の機能やサービスにおいて IPv6 を必須としたり、IPv4 を非優先としたりすることは計画していません。Azure AD における IPv6 有効化に関する追加ガイダンスは、こちらの覚えやすいリンク (<a href="https://aka.ms/azureadipv6">https://aka.ms/azureadipv6</a>) で引き続き共有していきます。</p><h2 id="ユーザー体験の改善"><a href="#ユーザー体験の改善" class="headerlink" title="ユーザー体験の改善"></a>ユーザー体験の改善</h2><h3 id="利用規約のユーザー体験を刷新"><a href="#利用規約のユーザー体験を刷新" class="headerlink" title="利用規約のユーザー体験を刷新"></a>利用規約のユーザー体験を刷新</h3><p><strong>2023 年 7 月</strong> より、以下の利用規約のエンドユーザー体験を最新の PDF ビューアーに刷新し、URL を <a href="https://account.activedirectory.windowsazure.com/">https://account.activedirectory.windowsazure.com</a> から <a href="https://myaccount.microsoft.com/">https://myaccount.microsoft.com</a> に移行します。</p><ul><li>以前に承認された利用規約を閲覧する</li><li>サインインの流れの一環として利用規約を承認または拒否する</li></ul><p>機能が削除されることはありません。新しい PDF ビューアには機能が追加されますが、エンドユーザーからの見た目の変化は限定的である旨も将来のアップデートで通知される予定です。特定のドメインのみを通信の許可リストに入れている場合、利用規約が期待どおりに機能するためには、許可リストにドメイン「myaccount.microsoft.com」および「*.myaccount.microsoft.com」が含まれていることを確認ください。詳細については、<a href="https://aka.ms/touuiupdate">https://aka.ms/touuiupdate</a> をご覧ください。</p><h3 id="My-Groups-のユーザー体験の向上"><a href="#My-Groups-のユーザー体験の向上" class="headerlink" title="My Groups のユーザー体験の向上"></a>My Groups のユーザー体験の向上</h3><p>新しく改良された <strong>My Groups</strong> のユーザー体験が <a href="https://myaccount.microsoft.com/groups">myaccount.microsoft.com/groups</a> で利用可能でとなり、<strong>2023 年 5 月</strong> に古い画面は廃止となる予定です。以前の URL (<strong>mygroups.microsoft.com</strong>) にアクセスすると、<strong>myaccount.microsoft.com/groups</strong> の新しい画面にユーザーをリダイレクトします。</p><p>My Groups では、エンド ユーザーが参加するグループの検索、所有するグループの管理、既存のグループ メンバーシップの管理など、グループを簡単に管理することができます。また、お客様からのフィードバックに基づき、以下のような機能も追加されました:</p><ul><li>グループとグループ メンバーの一覧での並び替えとフィルタリング</li><li>巨大なグループに対するグループ メンバーの全リスト</li><li>メンバー追加の要求に対して概要ページで対応可能</li></ul><p>本日、ユーザーの皆様は、自身で <strong>myaccount.microsoft.com/groups</strong> に切り替えることで、新しい My Groups の恩恵を得ることができます。新旧の画面間のナビゲーションは、各サイトの通知バナーから利用できます。</p><p>注意: “セルフサービス グループ管理” の管理者用の設定は、新しい My Groups で利用できなくなり、<strong>2023 年 5 月</strong> に <strong>廃止</strong> される予定です。管理者は、グループの所有者やユーザーが My Groups にアクセスしたり利用したりすることを制限できなくなります。ただし、管理者は引き続き <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/enterprise-users/groups-self-service-management">こちら</a> に記載されている設定を使用して、エンド ユーザーが M365 とセキュリティ グループを作成する権限を制御することが可能です。</p><p><strong>この変更はすべてのお客様で自動的に行われ、お客様側での操作は必要はありません。</strong> 詳しくは、<a href="https://support.microsoft.com/ja-jp/account-billing/update-your-groups-info-in-the-my-apps-portal-bc0ca998-6d3a-42ac-acb8-e900fb1174a4">My Apps ポータルでグループ情報を更新する</a> をご覧ください。</p><h3 id="My-Apps-ポータルの改善"><a href="#My-Apps-ポータルの改善" class="headerlink" title="My Apps ポータルの改善"></a>My Apps ポータルの改善</h3><p>貴社にて <strong>myapps.microsoft.com</strong> を使用してアプリの検索やアクセスを行っており、ネットワークにおいて特定の証明書やドメインのみを許可している場合、今後もアプリに期待どおりアクセスできるように、許可リストを更新する必要があります。弊社では、パフォーマンスと耐障害性を向上させるために、アプリの起動に新しいエンドポイントを導入しました。アプリにアクセスした際の要求は、新しいドメインである <strong>launcher.myapps.microsoft.com</strong> に今後送られます。</p><p>現在、お客様が <strong>myapps.microsoft.com/signin</strong> または <strong>account.activedirectory.windowsazure.com/applications/signin</strong> のディープ リンクを使用しており、加えて特定の証明書のみを許可している場合、許可リストを更新して <strong>myapplications.microsoft.com</strong> の証明書も許可リストに含める必要があります。特定のドメインまたは IP アドレスのみを許可している場合は、<strong>launcher.myapps.microsoft.com</strong> を含むように許可リストを更新する必要もあります。My Apps ポータルが期待どおりに動作するために、<strong>2023 年 6 月 30 日</strong> までに許可リストを更新ください。</p><p>証明書の許可リストを更新する必要があるかどうかを簡単に確認するには、<a href="https://myapplications.microsoft.com/">https://myapplications.microsoft.com</a> にアクセスください。期待どおりに読み込まれる場合は対応の必要はありません。問題が発生した場合は更新が必要です。</p><p>過去に My Apps の証明書を許可した経緯があるのであれば、今回も同様に My Apps から返される新しい証明書を許可するように同じように対応する必要があります。許可リストに登録する必要がある My Apps の証明書の取得処理は、使用しているブラウザによって異なります。Edge の場合、URL バーの左側にある鍵のアイコンを選択します。次に、ドロップダウンから「接続がセキュリティで保護されています」と表示されたオプションを選択します。「接続がセキュリティで保護されています」の詳細で、証明書のアイコンを選択すると、証明書の詳細を含む証明書ビューアーが開きます。その他の情報については、<a href="https://learn.microsoft.com/ja-jp/microsoft-365/enterprise/urls-and-ip-address-ranges?view=o365-worldwide">Office 365 の URL と IP アドレスの範囲</a> をご覧ください。</p><h3 id="My-Apps-Secure-Sign-in-Extension"><a href="#My-Apps-Secure-Sign-in-Extension" class="headerlink" title="My Apps Secure Sign-in Extension"></a>My Apps Secure Sign-in Extension</h3><p>2023 年 5 月より、<a href="https://support.microsoft.com/en-us/account-billing/sign-in-and-start-apps-from-the-my-apps-portal-2f3b1bae-0e5a-4a86-a33e-876fbd2a4510">My Apps Secure Sign-in Extension</a> は、<a href="https://developer.chrome.com/docs/extensions/mv3/intro/mv3-overview/">Chromium の新しい Manifest Version 3 フォーマット</a> に対応するためにアップデートされる予定です。この拡張機能を使用しているいくつかの機能でアップデートが発生しますが、現時点ではお客様側で対処の必要はありません。これらのアップデートは以下のとおりです: </p><ul><li>Azure Marketplace または Azure AD アプリケーション ギャラリーからの一部の SAML アプリで利用可能だった、オプションの機能である <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/manage-apps/one-click-sso-tutorial">SAML シングル サインオンのワン クリックのアプリ構成</a> は、<strong>2023 年 5 月</strong> に提供が停止される予定です。この機能を使用して以前に構成されたすべてのアプリケーションは、引き続き動作し続けるため、現時点では追加の対応は必要ありません。</li><li>My Apps のアプリ検索の機能は、MyApps のすべてのアプリを横断的に検索するようになり、新しく起動の機能も提供されます。検索クエリを入力すると、My Apps ポータルが新しいタブで開き、検索クエリがアプリの一覧に適用されるようになりました。そして、検索結果からアプリを起動することが可能となります。拡張機能の画面として、最近使ったものの表示がなくなります。  </li><li>App Proxy のリンク変換機能で、動的かつセッションごとのルールが使用されるようになりました。これにより、1 テナントあたり上限として 2250 の一意なリンク変換の制限が導入されます。</li></ul><p><a href="https://microsoftedge.microsoft.com/addons/detail/my-apps-secure-signin-ex/gaaceiggkkiffbfdpmfapegoiohkiipl?hl=en-gb">Edge アドオン</a> または <a href="https://chrome.google.com/webstore/detail/my-apps-secure-sign-in-ex/ggjhpefgjjfobnfoldnjipclpcfbgbhl?hl=en-US">Chrome エクステンション</a> の最新バージョンを使用していることを確認ください。なお、この拡張機能の Firefox 版のサポートは 2021 年 9 月に終了しています。</p><h3 id="Azure-AD-管理センターから-Microsoft-Entra-管理センターにリダイレクトされる"><a href="#Azure-AD-管理センターから-Microsoft-Entra-管理センターにリダイレクトされる" class="headerlink" title="Azure AD 管理センターから Microsoft Entra 管理センターにリダイレクトされる"></a>Azure AD 管理センターから Microsoft Entra 管理センターにリダイレクトされる</h3><p><strong>2023 年 4 月 1 日</strong> より、Azure AD Admin Center (<a href="https://aad.portal.azure.com]">https://aad.portal.azure.com</a>) へのアクセスは Microsoft Entra Admin Center (<a href="https://entra.microsoft.com/">https://entra.microsoft.com</a>) にリダイレクトされます。新しい管理センター内からは、これまでどおり Azure AD の管理タスクをすべて完了することができます。管理機能へ中断なくアクセス出来るようにするために、必要に応じてファイアウォール規則を更新ください。ファイアウォール規則の詳細は、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/fundamentals/active-directory-faq#----------------------microsoft-entra---------url-------------------">こちら</a> をご覧ください。</p><p><strong>2023 年 4 月 1 日以降も Azure AD の管理ポータルにアクセスできるのでしょうか？</strong></p><ul><li>Azure AD 管理センター (<a href="https://aad.portal.azure.com/">https://aad.portal.azure.com</a>) は、<strong>2023 年 5 月</strong>まで機能を継続します。  </li><li>Azure ポータル (<a href="https://portal.azure.com/">https://portal.azure.com</a>) でも、Azure のお客様向けに Azure AD の提供を継続します。</li></ul><p>詳細は、<a href="https://jpazureid.github.io/blog/azure-active-directory/new-admin-center-unifies-azure-ad-with-other-identity-and-access-product/">新しい管理センターにおける Azure AD および他の ID とアクセス製品の統合</a> をご確認ください。</p><h2 id="開発者の体験の向上"><a href="#開発者の体験の向上" class="headerlink" title="開発者の体験の向上"></a>開発者の体験の向上</h2><h3 id="Azure-AD-Graph-API"><a href="#Azure-AD-Graph-API" class="headerlink" title="Azure AD Graph API"></a>Azure AD Graph API</h3><p>Azure AD Graph から Microsoft Graph へのスムーズな移行をお客様にお約束することを改めてお伝えしたいと思います。<a href="https://jpazureid.github.io/blog/azure-active-directory/Microsoft-Entra-change-announcements-September-2022-train/">以前に発表した</a> ように、Azure AD Graph は <strong>2023 年 6 月 30 日</strong> まで利用可能です。弊社はこの日以降にいつでもサービスを停止する権利を有していますが、利用状況を監視し、お客様が API から移行するための十分な時間を提供したうえで、停止措置を行うようにいたします。その間、セキュリティ関連の修正を含めた Azure AD Graph のサポートを提供し続けますが、Azure AD Graph に依存した状態で運用環境を構成することは非推奨とします。すべての新機能と特徴は、<a href="https://docs.microsoft.com/ja-jp/graph/overview">Microsoft Graph </a> でのみ提供されます。すべてのお客様が、Microsoft Graph へ移行することを強く推奨します。詳しくは、<a href="https://docs.microsoft.com/ja-jp/graph/migrate-azure-ad-graph-overview">Azure AD Graph アプリを Microsoft Graph に移行する</a> をご覧ください。</p><h3 id="Azure-AD-Preview-と-MSOnline-PowerShell-の廃止"><a href="#Azure-AD-Preview-と-MSOnline-PowerShell-の廃止" class="headerlink" title="Azure AD (Preview) と MSOnline PowerShell の廃止"></a>Azure AD (Preview) と MSOnline PowerShell の廃止</h3><p>Azure AD、Azure AD Preview、MSOnline の 3 つの PowerShell モジュールのサポート期間の終了が近づいており、廃止予定日が <strong>2023 年 6 月 30 日</strong> であることを改めてお知らせしたいと思います。Azure AD API の状況によっては、2023 年 6 月 30 日以降、一部のコマンドレットが動作しなくなる可能性があります。弊社は、使用状況を確認し、お客様が 3 つの PowerShell モジュールから移行するための猶予を提供した上で、これらモジュールの利用を停止させる予定です。Microsoft Graph でこれら API の代替の機能が提供されない限り、API およびコマンドレットを停止させることはありません。</p><p>利用停止までは、セキュリティ関連の更新をサポートし続ける予定です。弊社はこれからも Microsoft Graph PowerShell SDK に対して、全ての PowerShell 関連の機能改善を行う予定であり、お客様においても移行を継続することを推奨します。</p><p>詳しくは、<a href="https://learn.microsoft.com/ja-jp/powershell/microsoftgraph/migration-steps?view=graph-powershell-1.0">Azure AD PowerShell から Microsoft graph PowerShell SDK への移行</a> のドキュメントをご覧ください。</p><h3 id="ライセンス割り当て-API-PowerShell-の廃止"><a href="#ライセンス割り当て-API-PowerShell-の廃止" class="headerlink" title="ライセンス割り当て API/PowerShell の廃止"></a>ライセンス割り当て API/PowerShell の廃止</h3><p><strong>既存テナント</strong> の Azure AD Graph および MSOnline PowerShell ライセンス割り当て API と PowerShell コマンドレットの廃止予定日が <strong>2023 年 3 月 31 日</strong> であることを改めてお知らせします。2022 年 11 月 1 日以降に作成された <strong>新規テナント</strong> では、これら API とコマンドレットは既に動作しません。</p><p><a href="https://jpazureid.github.io/blog/azure-active-directory/migrate-your-apps-to-access-the-license-managements/">Azure AD Graph および MSOnline での従来のライセンスの割り当て方法が廃止され Microsoft Graph によるライセンス管理に変更される</a> および <a href="https://learn.microsoft.com/ja-jp/powershell/microsoftgraph/azuread-msoline-cmdlet-map?view=graph-powershell-1.0">Azure AD と MSOnline コマンドレットに対応する Microosft Graph PowerShell を見つける</a> のガイダンスに従って、Microsoft Graph への移行を速やかに行うことを推奨します。</p><p>以下は、弊社からの変更管理についての連絡予定の概要です。</p><table><thead><tr><th><strong>カテゴリ</strong></th><th><strong>定義</strong></th><th><strong>連絡の予定</strong></th></tr></thead><tbody><tr><td>製品の廃止の連絡</td><td><strong>機能、性能、または製品を特定の期間後に廃止</strong>することを指します。<br/><br/>これは、一般的に、新たなお客様に対してサービスや機能の提供を停止し、廃止予定の機能に対して技術的面での投資が削減されることを意味します。最終的には、EOL (end-of-life) の状態に至り、すべてのお客様に対してサービスや機能の提供が停止されます。</td><td>年に 2 回 (3 月、9 月)</td></tr><tr><td>製品の既存の動作に影響を与える変更および機能変更のお知らせ</td><td><strong>既存の動作に影響を与える変更</strong>: 継続的な運用のためにお客様が何らかの操作や変更を行わない場合、既存のユーザーおよびパートナー体験に影響が生じると想定される変更です。<br/><strong>機能の変更</strong>: 既存の ID の機能に対する変更であり、お客様側での作業は必要はありませんが、ユーザー体験に変化が生じます。多くは、UI/UX (ユーザー インターフェイスおよびユーザー体験) への変更です。<br/>これらの変更は一般的に頻繁に発生するため、より頻繁に弊社からの通知が必要となります。</td><td>年に 4 回 (3 月、6 月、9 月、11 月)</td></tr></tbody></table><p>毎月の更新については、リリースノートのページでご確認ください: <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/fundamentals/whats-new">Azure Active Directory の新着情報</a></p><p>いつものように、フィードバックや提案をお待ちしています。以下のコメントまたは <a href="https://feedback.azure.com/d365community/forum/22920db1-ad25-ec11-b6e6-000d3a4f0789">Azure AD feedback forum</a> でご意見をお聞かせください。また、Microsoft Q&amp;A で、質問、未解決の問題や機能に関するご要望を #AzureADChangeManagementMar2023Train のタグを使用して送信することも可能です。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 高田 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 3 月 31 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techco</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>Azure AD B2B とは</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/what-is-b2b/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/what-is-b2b/</id>
    <published>2023-03-31T15:00:00.000Z</published>
    <updated>2023-04-15T23:00:14.678Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は Technet Blog の更新停止に伴い <a href="https://blogs.technet.microsoft.com/jpazureid/2017/12/12/about-azure-ad-b2b/">TechNet Blog</a> の内容を移行したものです。元の記事の最新の更新情報については、本内容をご参照ください。</p></div><div class="alert is-info"><p class="alert-title">Note</p><p>2017-12-12: 本記事の初版を投稿</p><p>2023-04-01: 画面ショットや Azure ポータル上のメニューの変更に伴い内容を更新</p></div><p>こんにちは、Azure &amp; Identity サポート チームの三輪です。</p><p>今回は Azure AD B2B (Business-To-Business) コラボレーション機能 (以下、Azure AD B2B) について紹介します。この記事はもともと 2017 年 12 月に公開されましたが、その後 Azure ポータルのメニューなどが変更されたため、内容を最新版に更新いたしました</p><p>Azure AD B2B の概要については、公開ドキュメントである <a href="https://docs.microsoft.com/ja-jp/azure/active-directory/active-directory-b2b-what-is-azure-ad-b2b">B2B コラボレーションの概要</a> をまずご覧ください。</p><p>Azure AD B2B と聞くと、もしかしたら小難しく聞こえるかもしれませんが、要は他の Azure AD テナント上のユーザーを自テナントに追加 (招待) する機能のことです。具体的には、Azure AD を利用する中で、次のような要望がでてくることがあります。</p><ul><li>会社間 (Azure AD テナント間) で自社が公開しているリソースを共有したい</li><li>別の Azure AD テナントに紐づいているリソースを使用したい</li><li>ひとりの管理者で、複数の Azure AD テナントを管理したい 等</li></ul><p>このような連携が必要な時に利用する機能が、今回紹介する Azure AD B2B になります。</p><h2 id="はじめに"><a href="#はじめに" class="headerlink" title="はじめに"></a>はじめに</h2><p>Azure サブスクリプションは必ず 1 つの Azure AD テナントに関連付けられています。通常、このサブスクリプションが紐づく Azure AD テナントに所属しているユーザーのみがそのサブスクリプション内のリソースを管理可能です。</p><p><img src="/blog/azure-active-directory/what-is-b2b/subscription-user.png"></p><p>では、複数の Azure AD テナントがある場合はどのようになるでしょうか。この場合、そのままでは別の Azure AD テナント B からテナント A へアクセスしたり、別の Azure AD テナント A に関連付けられているサブスクリプションに Azure AD テナント B のユーザーが管理操作をおこなったりすることはできません。</p><p><img src="/blog/azure-active-directory/what-is-b2b/subscription-user-inaccessible.png"></p><p>こんな時、Azure AD B2B を利用することで、自身の Azure AD テナントに他テナントのユーザーを招待することで、ユーザー本体は別の Azure AD テナントに所属しながら、招待した側のテナントのリソースを利用することが可能となります。</p><p><img src="/blog/azure-active-directory/what-is-b2b/invite-user-to-tenant.png"></p><h2 id="詳細"><a href="#詳細" class="headerlink" title="詳細"></a>詳細</h2><p>別の Azure AD テナントのユーザーを自テナントに招待する方法で多く利用されるものを 2 つ紹介します。</p><h3 id="1-ゲスト-ユーザーの直接的な招待"><a href="#1-ゲスト-ユーザーの直接的な招待" class="headerlink" title="1. ゲスト ユーザーの直接的な招待"></a>1. ゲスト ユーザーの直接的な招待</h3><p>明示的に別の Azure AD テナントのユーザー (または outlook.com や gmail.com など外部アカウント) を招待し追加する操作です。Azure ポータルのメニューより [Azure Active Directory] – [ユーザーとグループ] – [すべてのユーザー] – [新しいユーザー] の順に進みます。下記、[外部ユーザーの招待] からユーザーの E メール アドレス (もしくは Azure AD の UPN) を追加します。指定されたユーザーに招待 E メールが送られますので、E メールを受け取ったユーザーは、その E メールのリンクからウィザードを完了する必要があります。</p><p><img src="/blog/azure-active-directory/what-is-b2b/screenshot-new-guest-user-new.png"></p><h3 id="2-RBAC-アクセス制御-IAM-によるユーザーの招待"><a href="#2-RBAC-アクセス制御-IAM-によるユーザーの招待" class="headerlink" title="2. RBAC (アクセス制御 IAM) によるユーザーの招待"></a>2. RBAC (アクセス制御 IAM) によるユーザーの招待</h3><p>RBAC を用いて、Azure サブスクリプションに紐づけられている Azure AD テナント上のユーザーに対してアクセス許可を割り当てることができます。では、RBAC でアクセス権を割り当てるときに別の Azure AD テナントのユーザーを指定したい時には、先に 1 の作業を実施しておく必要があるのでしょうか？</p><p>いいえ、もしアクセス許可を割り当てようとしているユーザーがそのテナントに存在していない場合には、RBAC の設定時に自動的に 1 のユーザー招待も併せて行われます。手順としては、Azure ポータルの [サブスクリプション] – [サブスクリプション名] – [アクセス制御 (IAM)] の順にお進みください。下記、[追加] から別の Azure AD テナントのユーザーを追加することができます。指定された E メール アドレスには、招待 E メールが送られ、その E メールよりウィザードを完了する流れは同様になりますが、同時にサブスクリプションに対するロールが割り当てられます。</p><p><img src="/blog/azure-active-directory/what-is-b2b/screenshot-iam-new.png"></p><h2 id="よくあるお問い合わせ"><a href="#よくあるお問い合わせ" class="headerlink" title="よくあるお問い合わせ"></a>よくあるお問い合わせ</h2><p><span style="color:blue">Q</span>. B2B の機能以外で Azure AD 間の連携を行うことは可能ですか？</p><p><span style="color:red">A</span>. いいえ、テナント間での連携を行いたい場合は、Azure AD B2B を利用することが基本です。Azure AD のテナント間同機の仕組みでも、Azure AD B2B の仕組みが利用されています。Azure AD B2B の機能は Azure AD のテナント同士を連携するものではなく、 Azure AD テナントと別の Azure AD テナントのユーザーを連携する機能とお考えください。</p><p><span style="color:blue">Q</span>. 別の Azure AD テナントに登録されたアプリケーションを利用するのに、Azure AD B2B の機能を利用できますか？</p><p><span style="color:red">A</span>. はい、B2B の機能で要件を満たせます。Azure AD B2B の機能で別の Azure AD テナントのユーザーを自テナントに招待することで、その招待されたユーザーが 自テナント (自社の Azure AD テナント) 上のアプリケーションを利用することが可能となります。</p><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>今回は、Azure AD B2B に関する概要について紹介しました。Azure AD B2B に関するトラブルや Azure AD B2B 完了後のトラブル、または招待 E メールを利用しない方法などの記事も必要に応じて参照ください。また、それでも問題が解決しない場合は、弊社サポートまで遠慮なくお問い合わせください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は Technet Blog の更新停止に伴い &lt;a href=&quot;https://blogs.technet.microsoft.com/jpazure</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="RBAC" scheme="https://jpazureid.github.io/blog/tags/RBAC/"/>
    
    <category term="Azure AD B2B" scheme="https://jpazureid.github.io/blog/tags/Azure-AD-B2B/"/>
    
  </entry>
  
  <entry>
    <title>招待したユーザーが利用できない</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/azuread-b2b-troubleshooting/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/azuread-b2b-troubleshooting/</id>
    <published>2023-03-26T01:00:00.000Z</published>
    <updated>2023-04-15T23:00:14.146Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は Technet Blog の更新停止に伴い <a href="https://blogs.technet.microsoft.com/jpazureid/2017/11/27/azuread-b2b-troubleshooting/">TechNet Blog</a> の内容を移行したものです。元の記事の最新の更新情報については、本内容をご参照ください。</p></div><div class="alert is-info"><p class="alert-title">Note</p><p>2017-11-27: 本記事の初版を投稿</p><p>2023-03-26: 画面ショットや Azure ポータル上のメニューの変更に伴い内容を更新</p></div><p>こんにちは、Azure &amp; Identity サポート チームの 小出 と 三輪 です。</p><p>本記事では Azure AD に招待したはずのユーザーが利用できない際の確認ポイントについて説明します。この記事はもともと 2017 年 11 月に公開されましたが、その後 Azure ポータルのメニューなどが変更されたため、内容を最新版に更新いたしました。</p><p>Azure AD へのユーザー招待は、明示的に Azure Active Directory の管理画面からゲスト ユーザーを追加した場合だけでなく、その追加したユーザーが Azure AD にすでに追加済みでなければ、Azure のサブスクリプションに対して “所有者” や “仮想マシン共同作成者” の役割を追加したときにも行われます。</p><p>ユーザーを招待した後には、招待されたユーザー側でその招待の受諾処理を行う必要があり、それが完了していないと、役割を割り当てたもののサブスクリプションの利用ができないというような状況になります。そのような状況の場合は、まずはじめに Azure ポータルにて招待状況を確認しましょう。</p><h2 id="Azure-ポータルでの招待状況の確認方法"><a href="#Azure-ポータルでの招待状況の確認方法" class="headerlink" title="Azure ポータルでの招待状況の確認方法"></a>Azure ポータルでの招待状況の確認方法</h2><p>招待操作を行ったテナントの管理者権限を持つユーザーで Azure ポータルにサインインし、[Azure Active Directory] – [ユーザー] – [すべてのユーザー] から該当のゲスト ユーザーを選択します。</p><p>[プロパティ] のタブで「外部ユーザーの状態」(赤枠) の項目が「保留中の承諾」の場合は、招待メールは送信されているものの、該当のユーザーが招待を受け付け操作を完了していない状態を示します。招待を受けたユーザーは送信された E メールに含まれる [招待の承諾] のリンクをクリックしてウィザードを完了させる必要があります。</p><p>なお、招待 E メールが届いていない場合、緑枠部分の「B2B コラボレーション」の [管理（招待の再送信/状態のリセット）] から招待 E メールの再送も可能です。</p><p><img src="/blog/azure-active-directory/azuread-b2b-troubleshooting/new1.png"></p><p><img src="/blog/azure-active-directory/azuread-b2b-troubleshooting/new2.png"></p><p>招待 E メールは下記のようなメールです。</p><p>アドレス: <a href="mailto:&#x69;&#110;&#x76;&#105;&#116;&#x65;&#x73;&#x40;&#109;&#105;&#99;&#114;&#x6f;&#115;&#x6f;&#x66;&#116;&#46;&#99;&#111;&#109;">&#x69;&#110;&#x76;&#105;&#116;&#x65;&#x73;&#x40;&#109;&#105;&#99;&#114;&#x6f;&#115;&#x6f;&#x66;&#116;&#46;&#99;&#111;&#109;</a><br>件名: 組織内のアプリケーションにアクセスするための &lt;招待者&gt; さんからの招待</p><p><img src="/blog/azure-active-directory/azuread-b2b-troubleshooting/new3.png"></p><div class="alert is-info"><p class="alert-title">Note</p><p>件名に招待者の名前がない場合、ProxyAddresses 属性に値が入っていないユーザーで招待操作を行ったことが考えられます。この場合、特定のユーザー名の代わりにテナント名が記載されます。</p></div><p>もし、招待されたユーザーが E メールを利用できない場合や、E メール ボックスの作成前の場合は、招待の再送信後に表示される下記、「招待 URL ※」をコピーして、何らかの手段でその URL を招待されたユーザーにお渡しください。招待されたユーザーは、その URL にブラウザーからアクセスすることで招待の完了作業を進めることができます。</p><p>※ URL にアクセスして招待の完了作業を進めても、招待 E メールの「招待の承諾」を押す場合と同等の操作になります。</p><p><img src="/blog/azure-active-directory/azuread-b2b-troubleshooting/new4.png"></p><p>招待された外部ユーザーの状態が 「保留中の承諾」 ではなく、「承諾済み」となっている場合は、ユーザーの招待は完了しています。</p><p>「承諾済み」の状態で、期待したサブスクリプションの操作や Azure AD テナントの確認ができない場合は、適切なアカウントや Azure AD を選択できていない可能性がありますので、一度 <a href="https://jpazureid.github.io/blog/azure-active-directory/subscription-azuread/">サブスクリプションが見えない</a> の内容をご確認ください。</p><p>なお、招待 E メールに含まれるリンクをクリックし、ウィザードを進めた結果、次のような「表示するアプリはありません。 このコレクションを非表示にする」との画面が表示されることがありますが、こちらは問題なく招待が完了していますのでご安心ください。</p><p><img src="/blog/azure-active-directory/azuread-b2b-troubleshooting/new5.png"></p><p>これは、特に割り当てられたアプリケーションがないことを意味しており、招待自体は正常に完了したことを示します。</p><h2 id="おわりに"><a href="#おわりに" class="headerlink" title="おわりに"></a>おわりに</h2><p>上記内容でもご要望の動作が完了しない場合は、ぜひ弊社サポート サービスをご利用ください。その際は下記の情報を事前にご提供いただけると幸いです。</p><ul><li>招待操作を行ったテナント名 (例: xxx.onmicrosoft.com)</li><li>招待操作を行ったユーザー名 (例: <a href="mailto:&#120;&#120;&#x78;&#x40;&#99;&#x6f;&#x6e;&#x74;&#x6f;&#x73;&#111;&#46;&#99;&#x6f;&#x6d;">&#120;&#120;&#x78;&#x40;&#99;&#x6f;&#x6e;&#x74;&#x6f;&#x73;&#111;&#46;&#99;&#x6f;&#x6d;</a>)</li><li>招待操作を行った時刻</li><li>招待されるユーザーの E メールアドレス (例: <a href="mailto:&#120;&#120;&#120;&#x40;&#102;&#x61;&#x62;&#114;&#x69;&#x6b;&#x61;&#x6d;&#46;&#99;&#x6f;&#109;">&#120;&#120;&#120;&#x40;&#102;&#x61;&#x62;&#114;&#x69;&#x6b;&#x61;&#x6d;&#46;&#99;&#x6f;&#109;</a>)</li><li>問題となっている状況の詳細と画面ショット</li></ul><p>例としては、「招待 E メールが届かない」、「招待 E メールは届くが招待の操作が完了しない」、「招待は完了したが、その後に目的のリソースにアクセスできない」などが挙げられます。それぞれ、上記の情報を添えてお問い合わせを発行いただけますと幸いです。</p><p>また、招待 E メールを使用しないユーザーの追加や CSV を使用した一括招待の方法については、<a href="https://jpazureid.github.io/blog/azure-active-directory/b2bfaq/">Azure における ゲスト ユーザー招待 (B2B) のよくある質問</a> を参照ください。招待 E メールを使用しないユーザーの追加方法についても同様にこの記事の「よくある質問」をご確認ください。</p><p>Azure AD B2B で活用いただける PowerShell サンプルは <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/external-identities/code-samples?tabs=http">Azure Active Directory B2B コラボレーション コードと PowerShell サンプル</a> にまとめられておりますので、併せてご参照ください。</p><p>上記内容が少しでも皆様の参考となりますと幸いです。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は Technet Blog の更新停止に伴い &lt;a href=&quot;https://blogs.technet.microsoft.com/jpazure</summary>
      
    
    
    
    
    <category term="Azure AD B2B" scheme="https://jpazureid.github.io/blog/tags/Azure-AD-B2B/"/>
    
  </entry>
  
  <entry>
    <title>より安全な国家を実現するための ID の技術革新</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/identity-innovation-for-a-more-secure-nation/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/identity-innovation-for-a-more-secure-nation/</id>
    <published>2023-03-26T00:00:00.000Z</published>
    <updated>2023-04-15T23:00:14.430Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 星野 です。</p><p>本記事は、2023 年 2 月 28 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/identity-innovation-for-a-more-secure-nation/ba-p/2365670">Identity Innovation for a More Secure Nation</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>毎秒 1,000 件以上の ID 攻撃 (※ 1) が発生しており、政府機関は史上最も厳しいサイバーセキュリティ環境の中で国民に向けサービスを提供しています。インフラに対する国家規模の攻撃から個人情報の漏洩まで、サイバー攻撃のすべてのエコシステムにおいて、政府が市民の自由を守る行為それ自体が、このような脅威者の格好のターゲットとなっています。拡大するセキュリティの脅威により、連邦政府機関とその最も重要なデータが危険にさらされているのです。</p><p>Microsoft Entra の 1 サービスである Azure Active Directory のフィッシング耐性のある多要素認証 (MFA) のような最近の技術革新により、政府機関のお客様はサイバーセキュリティのガイドラインと規制を順守しながら、政策目標を達成することができます。</p><p>2022 年 1 月、パスワードレスでフィッシング耐性のある多要素認証 (MFA) を使用するよう省庁に指示する国家安全保障の覚書 (<a href="https://www.nsa.gov/Press-Room/News-Highlights/Article/Article/2904637/president-biden-signs-cybersecurity-national-security-memorandum/">NSM-8</a>) が発表されました。各機関は 2023 年 1 月に準拠の期限を迎えました。私たちは、公共への奉仕を目指すこれら多くの機関に対して、この目標達成を支援する重要な機能を提供できることを嬉しく思っています。</p><h2 id="最新の強力な認証が生み出す信頼"><a href="#最新の強力な認証が生み出す信頼" class="headerlink" title="最新の強力な認証が生み出す信頼"></a>最新の強力な認証が生み出す信頼</h2><p>サイバーセキュリティの向上に関する大統領令 (EO 14028) および NSM-8 への対応として、マイクロソフトは、各機関が以下のことを実現するにあたり役立つ強力な認証方式を開発しました。</p><h3 id="レガシーなオンプレミス連携サーバーの脅威とコストを取り除く"><a href="#レガシーなオンプレミス連携サーバーの脅威とコストを取り除く" class="headerlink" title="レガシーなオンプレミス連携サーバーの脅威とコストを取り除く"></a>レガシーなオンプレミス連携サーバーの脅威とコストを取り除く</h3><p>米国連邦政府機関ならびに米国国防総省で使用されている Common Access Card (CAC) や Personal Identity Verification (PIV) カードなどの証明書を使った <strong>Certificate-Based Authentication (CBA)</strong> で、ユーザーを安全に認証することができます。これにより、レガシーなオンプレミス IT インフラに関連する攻撃リスクやコストを削減しながら、CBA をサポートできます。</p><h3 id="適切なリソースに適切な-MFA-方式を使用する"><a href="#適切なリソースに適切な-MFA-方式を使用する" class="headerlink" title="適切なリソースに適切な MFA 方式を使用する"></a>適切なリソースに適切な MFA 方式を使用する</h3><p>最新で使いやすく、フィッシングに強い認証方式を展開しましょう。<strong>条件付きアクセスの認証強度機能</strong>により、フィッシング耐性のある MFA に移行しながら、重要な資産を確実に保護しセキュリティを向上させることができます。</p><h3 id="政府機関を超えた連携を促進する"><a href="#政府機関を超えた連携を促進する" class="headerlink" title="政府機関を超えた連携を促進する"></a>政府機関を超えた連携を促進する</h3><p>フィッシング耐性のある認証 (Azure Active Directory CBA、FIDO2、Windows Hello for Business など) と条件付きアクセスの認証強度を<strong>テナント間のアクセス ポリシー</strong>と組み合わせることで、コンプライアンスを維持しながら、他の政府機関や商業パートナー/請負業者との、あらゆる Microsoft サービスでの安全なコラボレーションをクラウド上で実現できます。</p><h2 id="マイクロソフトがお手伝いできること"><a href="#マイクロソフトがお手伝いできること" class="headerlink" title="マイクロソフトがお手伝いできること"></a>マイクロソフトがお手伝いできること</h2><p>公務員が働く環境では、最新の ID ツールおよびモビリティを使用して柔軟に仕事を行うことが必要です。最高レベルのセキュリティを実現しながらも生産性を最大化し、ID への攻撃を心配することなく国民への奉仕に集中できるようにする必要があります。</p><p>私たちは、最も深刻なセキュリティの脅威からも、データと ID を確実に保護できる強力な認証 ID ソリューションを活用し、政府機関とのパートナーシップを継続していくことを誇りに思います。</p><p>サイバーセキュリティの向上に関する大統領令 (EO 14028) およびフィッシング耐性のある MFA の実装におけるマイクロソフトの取り組みについては、こちらをご覧ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/howto-authentication-passwordless-deployment?source=recommendations">Azure Active Directory でパスワードレス認証のデプロイを計画する</a></li><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/authentication/howto-mfa-getstarted">Azure Active Directory の多要素認証のデプロイを計画する</a></li><li>(英語/ 米国事例) <a href="https://www.microsoft.com/en-us/security/blog/2022/02/17/us-government-sets-forth-zero-trust-architecture-strategy-and-requirements/">US Government sets forth Zero Trust architecture strategy and requirements.</a></li></ul><p>Alex Weinert (<a href="https://twitter.com/Alex_T_Weinert">@Alex_T_Weinert</a>)<br>VP Director of Identity Security, Microsoft</p><p>※ 1: 2022 年の Azure AD の認証ログデータより</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 星野 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 2 月 28 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techco</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>MSOnline / AzureAD PowerShell から Graph PowerShell SDK への移行について 5_グループ管理</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement5/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement5/</id>
    <published>2023-03-12T00:00:00.000Z</published>
    <updated>2023-04-15T23:00:14.166Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、 Azure Identity サポート チームの三輪です。</p><p>この記事は、MSOnline / AzureAD モジュール廃止について、下記シリーズの続きとして連載しています。</p><p><a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement1/">1_概要編</a><br><a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement2/">2_移行導入編</a><br><a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement3/">3_インストール・接続編</a><br><a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement4/">4_ユーザー管理</a></p><p>5 回目となる今回は、グループ管理についてご紹介します。</p><p>まだモジュールをインストールしていない場合や、 Connect-MgGraph コマンドを使用した接続方法が分からない場合などは、本シリーズの 2 と 3 をご確認ください。</p><h2 id="目次"><a href="#目次" class="headerlink" title="目次"></a>目次</h2><ol><li><a href="#idx1">グループの取得</a><ul><li><a href="#idx1-1">テナントの全グループを取得する場合</a></li><li><a href="#idx1-2">特定のグループを取得する場合</a></li><li><a href="#idx1-3">特定の条件に合うグループを取得する場合</a></li></ul></li><li><a href="#idx2">グループ メンバーの取得</a><ul><li><a href="#idx2-1">特定のグループのユーザーを取得する場合</a></li><li><a href="#idx2-2">２つのグループに共通するメンバー</a></li></ul></li><li><a href="#idx3">グループ メンバーの追加および削除</a><ul><li><a href="#idx3-1">グループ メンバーの追加</a></li><li><a href="#idx3-2">グループ メンバーの削除</a></li></ul></li><li><a href="#idx4">特定のユーザーが所属するグループ一覧の取得</a></li></ol><hr><h2 id="idx1">1. グループの取得</h2><p>以前、グループ情報を取得するのに利用していた Get-AzureADGroup や Get-MsolGroup は、Get-MgGroup コマンドに置き換わります。以下にいくつかのシナリオをベースに例を紹介いたします。</p><h3 id="idx1-1">テナントの全グループを取得する場合</h3><p>-All オプションを使用します。Get-AzureADGroup コマンドでは、 -All $true とする必要がありましたが、新しいコマンドでは -All のみで動作します。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgGroup -All</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement5/azuread-module-retirement5-1.png"></p><h3 id="idx1-2">特定のグループを取得する場合</h3><p>ObjectID を指定することで特定のグループの情報を取得が可能です。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgGroup -GroupId 027926f5-a926-464b-89b0-8c4cb1eebb5b</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement5/azuread-module-retirement5-2.png"></p><h3 id="idx1-3">特定の条件に合うグループを取得する場合</h3><p>Get-MgUser コマンドと同様に、-Filter オプション等を活用して、条件に合致するグループのみを表示させることが可能です。以下に例をご紹介します。</p><p>DisplayName が特定の文字列から始まるグループのみを取得する場合</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgGroup -All -Filter &quot;startsWith(DisplayName,&#x27;A&#x27;)&quot;</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement5/azuread-module-retirement5-3.png"></p><p>Teams が有効となっているグループのみを取得する場合</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgGroup -All -Filter &quot;(resourceProvisioningOptions/any(c:c eq &#x27;Team&#x27;))&quot;</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement5/azuread-module-retirement5-4.png"></p><p>利用可能なパラメーターは Filter 以外にもありますが、各属性によってサポートされるオプションが異なります。下記のような公開情報を確認いただき、使用したい属性とオプションがサポートされているか、あらかじめご確認ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/graph/api/resources/group?view=graph-rest-1.0#properties">group リソースの種類 - Microsoft Graph v1.0 | Microsoft Learn</a>  </li><li><a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.graph.groups/get-mggroup?view=graph-powershell-1.0">Get-MgGroup (Microsoft.Graph.Groups) | Microsoft Learn</a>  </li><li><a href="https://learn.microsoft.com/ja-jp/graph/api/group-list?view=graph-rest-1.0&tabs=powershell">グループの一覧表示 - Microsoft Graph v1.0 | Microsoft Learn</a></li></ul><h2 id="idx2">2. グループ メンバーの取得</h2><p>グループに所属するメンバーは、Get-MgGroup コマンドにで取得可能です。</p><h3 id="idx2-1">指定したグループのメンバーを取得する</h3><p>Get-MgGroupMember コマンドを用い、グループの ObjectID を指定します。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgGroupMember -All -GroupId 027926f5-a926-464b-89b0-8c4cb1eebb5b</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement5/azuread-module-retirement5-5.png"></p><p>グループに所属するメンバーの Id 以外の情報を取得したい場合は、以下のように additionalproperties を用いてメンバー情報を取得することが可能です。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">(Get-MgGroupMember -All -GroupId 027926f5-a926-464b-89b0-8c4cb1eebb5b).additionalproperties.displayName</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement5/azuread-module-retirement5-6.png"></p><p>グループに所属するメンバーの Id と 表示名等、任意の複数の情報を取得したい場合には、以下のようにして抽出することも可能です。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgGroupMember -All -GroupId 027926f5-a926-464b-89b0-8c4cb1eebb5b|%&#123; [pscustomobject]@&#123;UserId = $_.id; displayName = $_.additionalproperties.displayName&#125; &#125;</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement5/azuread-module-retirement5-7.png">  </p><h3 id="idx2-2">２つのグループに共通するメンバー</h3><p>コマンドを組み合わせることで、2 つのグループに共通するユーザーのみを抽出することも可能です。以下の例では CommonMemberIds に共通するメンバーのリストが格納されます。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$groupAMembers = Get-MgGroupMember -GroupId dbf376f0-142d-4ed3-845e-e899a7f1cbca -All</span><br><span class="line">$groupBMembers = Get-MgGroupMember -GroupId 607357fb-df96-4593-8429-dcc86654afee -All</span><br><span class="line">$CommonMemberIds = @()</span><br><span class="line">foreach ($groupAMemberId in $groupAMembers.Id) &#123;</span><br><span class="line">    if ($groupBMembers.Id.Contains($groupAMemberId)) &#123;</span><br><span class="line">        $CommonMemberIds += $groupAMemberId</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement5/azuread-module-retirement5-8.png"></p><p>また、GroupA のメンバーではあるが、GroupB のメンバーではないユーザーを取得する際には、以下のようにスクリプトに ”!” を追加して抽出します。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$groupAMembers = Get-MgGroupMember -GroupId dbf376f0-142d-4ed3-845e-e899a7f1cbca -All</span><br><span class="line">$groupBMembers = Get-MgGroupMember -GroupId 607357fb-df96-4593-8429-dcc86654afee -All</span><br><span class="line">$NCommonMemberIds = @()</span><br><span class="line">foreach ($groupAMemberId in $groupAMembers.Id) &#123;</span><br><span class="line">    if (!$groupBMembers.Id.Contains($groupAMemberId)) &#123;</span><br><span class="line">        $NCommonMemberIds += $groupAMemberId</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以下の公開情報も併せてご確認ください。</p><ul><li><a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.graph.groups/get-mggroupmember?view=graph-powershell-1.0">Get-MgGroupMember (Microsoft.Graph.Groups) | Microsoft Learn</a>  </li><li><a href="https://learn.microsoft.com/ja-jp/graph/api/group-list-members?view=graph-rest-1.0&tabs=powershell">メンバーを一覧表示する - Microsoft Graph v1.0 | Microsoft Learn</a>  </li></ul><p>※ Get-MgGroupMember コマンドで取得できるのは、グループのダイレクト メンバーの一覧です。入れ子になったグループ内メンバーを含むすべてのメンバーを推移的に取得したい場合には、Get-MgGroupTransitiveMember を使用します。</p><ul><li><a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.graph.groups/get-mggrouptransitivemember?view=graph-powershell-1.0">Get-MgGroupTransitiveMember (Microsoft.Graph.Groups) | Microsoft Learn</a>  </li><li><a href="https://learn.microsoft.com/ja-jp/graph/api/group-list-transitivemembers?view=graph-rest-1.0&tabs=powershell">グループの推移性のメンバーを一覧表示する - Microsoft Graph v1.0 | Microsoft Learn</a></li></ul><h2 id="idx3">3. グループ メンバーの追加および削除</h2><h3 id="idx3-1">グループ メンバーの追加</h3><p>グループ メンバーの追加には New-MgGroupMember を用い、-GroupId としてグループの ObjectID を、-DirectoryObjectId として追加したいメンバーの ObjectID を指定します。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">New-MgGroupMember -GroupId &#x27;872648e7-b23a-4328-bd46-f1bd431c2354&#x27; -DirectoryObjectId &#x27;8a7c50d3-fcbd-4727-a889-8ab232dfea01&#x27;</span><br></pre></td></tr></table></figure><p>複数のユーザーを 1 つのグループに追加したい場合には、追加したいユーザーの ObjectID の一覧を作成し、-DirectoryObjectId として作成したユーザーの一覧を参照させます。</p><p>追加したいユーザーの ObjectID 一覧の csv ファイル例:</p><p><img src="/blog/azure-active-directory/azuread-module-retirement5/azuread-module-retirement5-9.png"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$GroupId = &quot;872648e7-b23a-4328-bd46-f1bd431c2354&quot;</span><br><span class="line">Import-CSV &quot;C:\Temp\Users.csv&quot; | ForEach &#123;New-MgGroupMember -GroupId $GroupId -DirectoryObjectId $_.ObjectId&#125;</span><br></pre></td></tr></table></figure><p>また、ユーザーの Object ID の代わりに ユーザーの UPN を使用したい場合には、<a href="https://jpazureid.github.io/blog/azure-active-directory/azuread-module-retirement4/">4_ユーザー管理操作の紹介</a> で紹介した Get-MgUser コマンドと組み合わせて、以下のようにスクリプトを作成することも可能です。</p><p><img src="/blog/azure-active-directory/azuread-module-retirement5/azuread-module-retirement5-10.png"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">$GroupId = &quot;872648e7-b23a-4328-bd46-f1bd431c2354&quot;</span><br><span class="line">Import-CSV &quot;C:\Temp\Users.csv&quot; | ForEach &#123;</span><br><span class="line">    $UserId = (Get-MgUser -UserId $_.UserPrincipalName).id</span><br><span class="line">    New-MgGroupMember -GroupId $GroupId -DirectoryObjectId $UserId</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>以下の公開情報も併せてご確認ください。</p><ul><li><a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.graph.groups/new-mggroupmember?view=graph-powershell-1.0">New-MgGroupMember (Microsoft.Graph.Groups) | Microsoft Docs</a>  </li><li><a href="https://learn.microsoft.com/ja-jp/graph/api/group-post-members?view=graph-rest-1.0&tabs=http">メンバーを追加する - Microsoft Graph v1.0 | Microsoft Learn</a>  </li></ul><h3 id="idx3-2">グループ メンバーの削除</h3><p>グループ メンバーの削除には Remove-MgGroupMemberByRef を用い、グループの ObjectID および削除したいユーザーの Object ID を指定してグループ メンバーを削除します。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Remove-MgGroupMemberByRef -GroupId &#x27;872648e7-b23a-4328-bd46-f1bd431c2354&#x27; -DirectoryObjectId &#x27;8a7c50d3-fcbd-4727-a889-8ab232dfea01&#x27;</span><br></pre></td></tr></table></figure><p>グループ メンバー削除に関しても、グループ メンバーの追加と同様、CSV ファイルを利用してのメンバーの一括削除や Get-MgUser とコマンドを組み合わせての UPN 指定によるメンバー削除が可能です。</p><p>以下の公開情報も併せてご確認ください。</p><ul><li><a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.graph.groups/remove-mggroupmemberbyref?view=graph-powershell-1.0">Remove-MgGroupMemberByRef (Microsoft.Graph.Groups) | Microsoft Docs</a>  </li><li><a href="https://learn.microsoft.com/ja-jp/graph/api/group-delete-members?view=graph-rest-1.0&tabs=http">メンバーを削除する - Microsoft Graph v1.0 | Microsoft Learn</a>  </li></ul><h2 id="idx4">4. 特定のユーザーが所属するグループ一覧の取得</h2><p>特定のユーザーが所属するグループ一覧を取得するには、Get-MgUserMemberOf を用い、ユーザーの ObjectID または UPN を指定します。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgUserMemberOf -UserId de673304-dcaf-4bfd-9acb-4f2abb937948</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement5/azuread-module-retirement5-11.png"></p><p>ユーザーが所属するグループの表示名も一緒に出力したい場合は、以下のように additionalproperties から displayName が取得できます。</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">Get-MgUserMemberOf -UserId &quot;de673304-dcaf-4bfd-9acb-4f2abb937948&quot; | %&#123;</span><br><span class="line">    [pscustomobject]@&#123;</span><br><span class="line">        Id = $_.id</span><br><span class="line">        displayName = $_.additionalproperties[&#x27;displayName&#x27;]</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img src="/blog/azure-active-directory/azuread-module-retirement5/azuread-module-retirement5-12.png"></p><p>以下の公開情報も併せてご確認ください。</p><p><a href="https://learn.microsoft.com/en-us/powershell/module/microsoft.graph.users/get-mgusermemberof?view=graph-powershell-1.0">Get-MgUserMemberOf (Microsoft.Graph.Users) | Microsoft Learn</a></p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、 Azure Identity サポート チームの三輪です。&lt;/p&gt;
&lt;p&gt;この記事は、MSOnline / AzureAD モジュール廃止について、下記シリーズの続きとして連載しています。&lt;/p&gt;
&lt;p&gt;&lt;a href=&quot;https://jpazureid.g</summary>
      
    
    
    
    
    <category term="PowerShell" scheme="https://jpazureid.github.io/blog/tags/PowerShell/"/>
    
    <category term="Microsoft Graph" scheme="https://jpazureid.github.io/blog/tags/Microsoft-Graph/"/>
    
  </entry>
  
  <entry>
    <title>組織の境界やマイクロソフトのクラウドを越えたセキュアなコラボレーション</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds/</id>
    <published>2023-03-05T01:00:00.000Z</published>
    <updated>2023-04-15T23:00:14.222Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 張替 です。</p><p>本記事は、2023 年 2 月 23 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/collaborate-securely-across-organizational-boundaries-and/ba-p/3094109">Collaborate securely across organizational boundaries and Microsoft clouds</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>今日、Microsoft のクラウド間でのコラボレーション機能が GA になったことを発表いたします！Azure Active Directory (Azure AD) の B2B コラボレーションが、以下の Microsoft クラウド間でサポートされるようになりました。</p><ul><li>Azure Commercial および Azure Government クラウド </li><li>Azure Commercial および Azure China クラウド（21Vianet）</li></ul><p>Microsoft Entra の一部である <a href="https://learn.microsoft.com/en-us/azure/active-directory/external-identities/what-is-b2b">Azure AD B2B</a> を利用して、Microsoft クラウド内で、サプライヤーやパートナー、ベンダーなどの外部ユーザーとコラボレーションしている方は、すでに多くいらっしゃると思います。また、自身の組織をホストしているクラウドとは異なる Microsoft クラウドでホストされている組織と共有および連携する必要があるお客様もいるでしょう。これまでは、複数のクラウドにテナントを設定し、同じユーザーに異なるアカウントを発行するという複雑なプロセスを踏む必要がありました。しかし現在、組織が Azure Commercial、Government、または China クラウドのいずれであっても、ユーザーは自身のプライマリとなる ID を使用して Microsoft クラウド間でシームレスに連携できるようになりました。</p><h2 id="3つの簡単なステップで-Microsoft-のクラウド間でのコラボレーションを開始する"><a href="#3つの簡単なステップで-Microsoft-のクラウド間でのコラボレーションを開始する" class="headerlink" title="3つの簡単なステップで Microsoft のクラウド間でのコラボレーションを開始する"></a>3つの簡単なステップで Microsoft のクラウド間でのコラボレーションを開始する</h2><p>Azure Government クラウドを使用している組織である Contoso Industries が、Azure Commercial クラウドのパートナーとどのようにコラボレーションしているかを例にとって説明します。</p><p>Contoso Industries は、政府機関や商業組織にミッション クリティカルな機器を供給しています。ビジネスの機密性を考慮し、政府は Contoso Industries を Azure Government Cloud でホスティングすることを求めています。</p><p>Contoso Industries には、Contoso Industries が製造する機器にソフトウェアを提供する Woodgrove のような商業パートナーもいます。現在は Microsoft のクラウドを横断してコラボレーションを行うことができるため、Contoso Industries のユーザーは Woodgrove のユーザーを招待してコラボレーションを行い、在庫管理のアプリケーションや SharePoint のドキュメントにアクセスできるようにすることが可能になっています。</p><p><img src="/blog/azure-active-directory/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds1.png"></p><p>では、実現方法について見ていきましょう。 </p><h3 id="ステップ-1：External-Identities-の-Microsoft-クラウド設定を有効にする"><a href="#ステップ-1：External-Identities-の-Microsoft-クラウド設定を有効にする" class="headerlink" title="ステップ 1：External Identities の Microsoft クラウド設定を有効にする"></a>ステップ 1：External Identities の Microsoft クラウド設定を有効にする</h3><p>Contoso Industries の管理者である Dean は、Azure ポータルの External Identities -&gt; テナント間アクセス設定 に移動して、Azure Commercial cloud と連携する設定を有効にします。</p><p><img src="/blog/azure-active-directory/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds2.png" alt="External Identities で Microsoft クラウドの設定を有効にします"></p><p>Dean は次に、<a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/cross-tenant-access-settings-for-secure-collaboration-now/ba-p/3575844">クロス テナント アクセス設定</a> で、Woodgrove のテナントをパートナーのリストに追加します。Woodgrove の管理者は、Azure ポータルで同様の変更を行います。</p><p>Dean は、特定のユーザーに特定のアプリケーションへのアクセスのみを許可するような、きめ細かい制御を行うこともできます。これによって、外部コラボレーションをさらに安全にすることができます。これらの変更が完了すると、Contoso Industries のユーザーは、Woodgrove からユーザーを招待して、Contoso Industries がホストしている業務系アプリ、SaaS アプリ、Power BI レポート、SharePoint Online サイト、ドキュメント、ファイルでのコラボレーションを行うことができるようになります。</p><p>Microsoft クラウド間でのコラボレーションを実現する方法については、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/external-identities/cross-cloud-settings">B2B コラボレーションの Microsoft クラウド設定を構成する</a> をご覧ください。</p><h3 id="ステップ-2-まず他の-Microsoft-クラウドからの外部ユーザーを管理する"><a href="#ステップ-2-まず他の-Microsoft-クラウドからの外部ユーザーを管理する" class="headerlink" title="ステップ 2: まず他の Microsoft クラウドからの外部ユーザーを管理する"></a>ステップ 2: まず他の Microsoft クラウドからの外部ユーザーを管理する</h3><p>Contoso Industries では、異なるクラウドからのユーザーを適切に管理し、外部ユーザーが Contoso Industries のリソースに限られた時間だけアクセスできるようにしたいと考えています。Dean は、信頼できる組織としてWoodgrove を追加します。</p><p><img src="/blog/azure-active-directory/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds3.png" alt="他の Microsoft クラウドから接続された組織を追加します。"></p><p>Dean は、特定のリソース、アクセス レビュー、承認のためのスポンサーを含むアクセス パッケージを割り当てます。これにより、Woodgrove のユーザーは、セルフ サービスによるオンボーディングが容易になり、Contoso Industries のアクセス ポリシーが即座に適用されるようになりました。</p><p>接続された組織とアクセス パッケージを使用して、異なる Azure AD テナントのユーザーをオンボードし管理する方法については、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/governance/entitlement-management-external-users">エンタイトルメント管理で外部ユーザーのアクセスを管理する</a> をご覧ください。 </p><h3 id="ステップ-3-Microsoft-クラウド間の外部コラボレーションを保護および監視する"><a href="#ステップ-3-Microsoft-クラウド間の外部コラボレーションを保護および監視する" class="headerlink" title="ステップ 3: Microsoft クラウド間の外部コラボレーションを保護および監視する"></a>ステップ 3: Microsoft クラウド間の外部コラボレーションを保護および監視する</h3><p>Dean は Woodgrove のユーザーと共有されるリソースを保護したいと考えています。Woodgrove のユーザーは Contoso Industries のゲスト ユーザーなので、Contoso Industries のリソースにアクセスする前に多要素認証 (MFA) を要求するなど、すべての <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/external-identities/authentication-conditional-access">条件付きアクセス ポリシー</a> を Woodgrove のユーザーに適用することが可能です。</p><p>また、Contoso Industries は、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/external-identities/cross-tenant-access-settings-b2b-collaboration#to-change-inbound-trust-settings-for-mfa-and-device-claims">クロス テナント アクセス設定</a> を利用して、Woodgrove から MFA や準拠済みの Azure AD の参加デバイスを信頼することができ、Woodgrove ユーザーのセキュリティをそのままに、シームレスなコラボレーション体験を実現することができます。</p><p><img src="/blog/azure-active-directory/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds/collaborate-securely-across-organizational-boundaries-and-microsoft-clouds4.png" alt="他の Azure AD テナントからの多要素認証とデバイス情報を信頼する。"></p><p>Woodgrove 社のユーザーが Contoso Industries のリソースにアクセスする場合、Dean はサインイン ログを使用してユーザーのアクティビティを監視することができます。また、<a href="https://learn.microsoft.com/en-us/azure/active-directory/reports-monitoring/workbook-cross-tenant-access-activity">クロス テナント アクセス アクティビティ ワークブック</a> を使用し、Woodgrove ユーザーがアクセスしているリソースを可視化することもできます。</p><h2 id="お客様の声"><a href="#お客様の声" class="headerlink" title="お客様の声"></a>お客様の声</h2><p>プレビューの際に、お客様のようなお客様から頂いた素晴らしいフィードバックを以下にご紹介します。</p><p>“ マイクロソフト クラウド間のコラボレーションにより、いくつものアプリを AD FS から Azure AD に移行可能となりました。AD FS はこれまで、本社ユーザーと中国ユーザーの両方が必要とするアプリへの SSO を提供するためのソリューションでした。この移行が完了すれば、AD FS を廃止し、コストを大幅に削減するとともに、信頼性を高め、セキュリティの工数を最小化することができます。” - 金融サービス業のお客様</p><p>“連携機能の不足でユーザーを政府系テナントに移動させることができなかったのですが、この機能でスムーズに移動できるようになりました！” -エンジニアリングと建設業界のお客様 </p><p>皆様からのフィードバックをお待ちしております。本発表に対するフィードバックは Azure フォーラムか <a href="https://twitter.com/azuread">@AzureAD</a> のタグをつけて Twitter にお寄せください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 張替 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 2 月 23 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techco</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>テナント制限について</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/tenant-restriction/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/tenant-restriction/</id>
    <published>2023-03-01T15:00:00.000Z</published>
    <updated>2023-04-15T23:00:14.666Z</updated>
    
    <content type="html"><![CDATA[<div class="alert is-info"><p class="alert-title">Note</p><p>本記事は Technet Blog の更新停止に伴い <a href="https://blogs.technet.microsoft.com/jpazureid/2018/09/13/tenant-restrictions/">https://blogs.technet.microsoft.com/jpazureid/2018/09/13/tenant-restrictions/</a> の内容を移行したものです。</p><p>また本記事は 2018 年に公開したものですが、サポートへのお問い合わせ状況ならびにエラー画面の変更などをふまえ、2023 年 3 月時点での最新の情報にアップデートいたしました。</p></div><p>こんにちは！ Azure &amp; Identity サポート チームの栗井です。</p><p>今回は Azure AD のテナント制限の機能に関して、よくあるお問い合わせと、その回答をご紹介いたします。</p><h2 id="テナント制限とは"><a href="#テナント制限とは" class="headerlink" title="テナント制限とは"></a>テナント制限とは</h2><p>テナント制限の機能では、ユーザーがアクセス可能な Azure AD テナントを制限することが可能です。</p><p>具体的には、クライアント端末から Azure AD に対する認証の通信をプロキシ経由させ、そのプロキシから送信されるデータに許可対象の Azure AD テナントの情報を付与します。その結果、それ以外の Azure AD テナントへのアクセスがブロックされる動作となります。</p><p>テナント制限の機能の詳細については、以下の公開情報をご参照ください。</p><ul><li><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/manage-apps/tenant-restrictions">公開情報: テナント制限を使用して SaaS アプリへのアクセスを管理する - Microsoft Entra | Microsoft Learn</a></li></ul><p>テナント制限によって許可されていないテナントへアクセスを試行すると、下記のように 「ネットワーク管理者によってアクセスがブロックされました」というエラーメッセージが表示されます (エラーコード: AADSTS500021)。</p><p><img src="/blog/azure-active-directory/tenant-restriction/AADSTS500021.png"></p><p>以下にて、テナント制限に関連する FAQ をまとめました。ぜひご参照ください！</p><h2 id="よくあるお問い合わせ"><a href="#よくあるお問い合わせ" class="headerlink" title="よくあるお問い合わせ"></a>よくあるお問い合わせ</h2><p><font color="DeepSkyBlue">Q</font> : テナント制限の機能のライセンス要件はありますか？</p><p><font color = "red">A</font> : テナント制限のご利用には、Azure AD Premium P1 もしくは P2 相当のライセンスが必要です。</p><p>テナント制限に関する公開情報の中では、Azure AD Premium のライセンスが無くとも、利用の状況・条件によってはテナント制限の利用が可能と受け取れる記載が 2020 年までございました。</p><p>この公開情報をもとに 2017 年に発行された日本語でのブログ記事 (現在はアーカイブ済み) においても、ライセンスに関する適切ではない記述がありましたが、 Azure AD Premium のライセンスが必要となります点ご留意ください。</p><p><font color="DeepSkyBlue">Q</font> : Microsoft アカウント (コンシューマー向けアカウント) によるアクセスを制限することは可能ですか。</p><p><font color = "red">A</font> : はい、可能です。この場合は login.live.com 宛への通信に対してヘッダーを設定しますが、 “Restrict-Access-To-Tenants” とは異なるヘッダーを利用します。</p><p>Microsoft アカウントによるアクセスを制限する場合は、”sec-Restrict-Tenant-Access-Policy” ヘッダーに “restrict-msa” という値が含まれるように構成ください。<br>この設定によって、 Microsoft アカウントの認証エンドポイント (login.live.com) へのアクセスがブロックされます。</p><p>アクセス ブロック時のメッセージとエラーコードは下記の通りです。</p><ul><li>メッセージ: “ここからアクセスすることはできません お客様の IT 部門によって承認されていない組織に属するリソースへのアクセスを試みているようです。” </li><li>エラーコード: 80045C4D</li></ul><p><img src="/blog/azure-active-directory/tenant-restriction/80045C4D.png"></p><p><font color="DeepSkyBlue">Q</font> : 制限されるのは Office 365 だけですか？</p><p><font color = "red">A</font>  : いいえ。以下の認証エンドポイントを使用する、すべてのサービス、言い換えますと Azure AD と連携するサービスが制限されます。</p><ul><li>login.microsoftonline.com  </li><li>login.windows.net  </li><li>login.microsoft.com</li></ul><p>例えば Azure ポータル、EA ポータルにアクセスする際も制限されます。また、ゲストユーザーの場合、招待されたテナントではなく、管理元のテナントで認証が行われるため、ゲストユーザーの招待元テナントも、テナント制限で許可する必要があります。</p><p><font color="DeepSkyBlue">Q</font> : (クライアントですが)、テナント制限によってアクセスできないテナントにアクセスできるようにしてほしい。</p><p><font color = "red">A</font> : 接続元のクライアントが利用するプロキシサーバーの設定変更が必要です。プロキシ サーバーを管理している IT 部門へ申請をあげるなどで、テナント制限の許可するリストに該当のテナントを追加してもらってください。</p><p>テナント制限は設定をおこなったプロキシ経由でのアクセスに制限を加えるものですので、プロキシサーバーによる制限を受けないネットワーク環境から接続することでもテナント制限による制御は回避できます。</p><p><font color="DeepSkyBlue">Q</font> : Azure AD 側での設定変更は必要ですか？</p><p><font color = "red">A</font> : いいえ。プロキシの設定のみで、テナント制限が機能します。</p><p><font color="DeepSkyBlue">Q</font> : “Restrict-Access-To-Tenants” に、ワイルドカードは利用できますか？</p><p><font color = "red">A</font> : いいえ。テナント名かテナント ID を不足なく、入力する必要があります。</p><p><font color="DeepSkyBlue">Q</font> : テナント制限で許可をすることができるテナント数に上限はありますか？</p><p><font color = "red">A</font> : テナント制限にて、許可をするテナント数自体には上限は設けられていません。しかし、ヘッダーの長さの上限 (MaxFieldLength) と、リクエストとヘッダーを含めた合計のサイズの上限 (MaxRequestBytes) があるため、多数のディレクトリを追加する場合、この上限を超えないように注意が必要です。</p><p>上記内容が、皆様のご参考になれば幸甚です。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;div class=&quot;alert is-info&quot;&gt;&lt;p class=&quot;alert-title&quot;&gt;Note&lt;/p&gt;&lt;p&gt;本記事は Technet Blog の更新停止に伴い &lt;a href=&quot;https://blogs.technet.microsoft.com/jpazure</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="Tenant Restrictions" scheme="https://jpazureid.github.io/blog/tags/Tenant-Restrictions/"/>
    
    <category term="テナント制限" scheme="https://jpazureid.github.io/blog/tags/%E3%83%86%E3%83%8A%E3%83%B3%E3%83%88%E5%88%B6%E9%99%90/"/>
    
  </entry>
  
  <entry>
    <title>オンプレミス アプリケーションのガバナンスと自動プロビジョニング</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/automate-provisioning-and-governance-of-your-on-premises/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/automate-provisioning-and-governance-of-your-on-premises/</id>
    <published>2023-03-01T00:00:00.000Z</published>
    <updated>2023-04-15T23:00:14.090Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは、Azure Identity サポート チームの 高田 です。</p><p>本記事は、2023 年 2 月 8 日に米国の Azure Active Directory Identity Blog で公開された <a href="https://techcommunity.microsoft.com/t5/microsoft-entra-azure-ad-blog/automate-provisioning-and-governance-of-your-on-premises/ba-p/2466935">Automate provisioning and governance of your on-premises applications</a> を意訳したものになります。ご不明点等ございましたらサポート チームまでお問い合わせください。</p><hr><p>この度、Microsoft Entra Identity Governance を使用したオンプレミス アプリケーションへのプロビジョニングの一般提供を発表いたします。カスタム コードを必要とせず、オンプレミス アプリケーションのプロビジョニングを自動化し、ユーザーのライフサイクルを管理することができるようになりました。</p><p>すでに多くの方が Microsoft Entra Identity Governance を使用し、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/saas-apps/tutorial-list">既定で提供されているコネクター</a> を活用して何百もの SaaS アプリケーションに <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/app-provisioning/user-provisioning">簡単に ID をプロビジョニング</a> しています。<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/app-provisioning/tutorial-ecma-sql-connector">SQL</a> データベースや <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/app-provisioning/on-premises-ldap-connector-configure">LDAP</a> ディレクトリ (Active Directory Domain Services を除く) にユーザー ID を保存しているオンプレミス アプリや、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/app-provisioning/on-premises-scim-provisioning">SCIM</a> 標準をサポートしているオンプレミス アプリに対し、Azure Active Directory (Azure AD) から ID を直接プロビジョニングすることができるようになりました。つまり、Microsoft Entra Identity Governance を使用すれば、すぐに使えるオンプレミス コネクターを活用して、カスタム コード無しにオンプレミス アプリケーションへのアクセスを管理できるのです。</p><p>ここで例として、Contoso という企業が <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/governance/identity-governance-overview">Microsoft Entra Identity Governance</a> を使用して、重要な製造プロセスを管理するオンプレミス アプリケーションへのアクセスを提供する例を説明します。このアプリケーションは組織内に何年も前から存在しています。このアプリケーションは、ユーザー管理のための最新の SCIM API をサポートしていませんが、ユーザー アクセスの管理には OpenLDAP サーバーを利用しています。Microsoft Entra Identity Governance を使用することで、Contoso は以下のことが可能になります。 </p><ul><li>アプリケーションへのアクセス許可設定を自動化することで、従業員の生産性を向上させる。</li><li>クラウドベースのプロビジョニング ソリューションを導入し、コストを管理する。</li><li>定期的なアクセス権の確認と取り消しを行い、リスクを管理する。</li></ul><p><img src="/blog/azure-active-directory/automate-provisioning-and-governance-of-your-on-premises/1.png" alt="Contoso 社は OpenLDAP をユーザーストアとして利用しているオンプレミスの製造管理アプリを所有しています"></p><p>Contoso の管理者は、以下の簡単な 3 つのステップで、ユーザーがオンプレミス アプリケーションにアクセスできるようにし、同時に必要な統制プロセスを実現できました。</p><h2 id="1-アプリケーション-アクセスの構成"><a href="#1-アプリケーション-アクセスの構成" class="headerlink" title="1. アプリケーション アクセスの構成"></a>1. アプリケーション アクセスの構成</h2><p>従業員が組織に参加すると、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/saas-apps/workday-inbound-cloud-only-tutorial">Workday</a> で採用済みとしてマークされ、Azure AD にてアカウントが自動的にプロビジョニングされます。管理者はエンタイトルメント管理で <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/governance/entitlement-management-access-package-create">アクセス パッケージ</a> を構成しています。製造部門で新しい従業員が採用されると、アクセス パッケージを通じて製造アプリへのアクセス権が　<a href="https://jpazureid.github.io/blog/azure-active-directory/dynamic-automated-access-with-entitlment-management/">自動的に</a> 割り当てられます。従業員が退職したり、転職したりすると、その割り当てが自動的に削除され、そのアプリケーションにアクセスできなくなります。</p><p>製造部門に所属していないユーザーで、製造アプリに期間限定でアクセスする必要がある人もいます。この要件に対応するため、Contoso の管理者はもう一つ別のポリシーを構成しており、それにより他の従業員がアクセス パッケージを介してアプリケーションへのアクセスを要求できるようにしています。</p><p>アクセスが必要なすべてのユーザーは、自動的にアクセス権を付与されるか、セルフ サービスで必要なアクセス権を要求することができます。</p><p><img src="/blog/azure-active-directory/automate-provisioning-and-governance-of-your-on-premises/2.png"></p><h2 id="2-アカウントのプロビジョニングを自動化"><a href="#2-アカウントのプロビジョニングを自動化" class="headerlink" title="2. アカウントのプロビジョニングを自動化"></a>2. アカウントのプロビジョニングを自動化</h2><p>製造業アプリはオンプレミスに存在し、SCIM などの最新規格には対応していませんが、アクセス制御に OpenLDAP サーバーを使用しています。管理者は Azure AD が提供する <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/app-provisioning/on-premises-ldap-connector-configure">汎用的な LDAP コネクター</a> を使用し、プロビジョニングを設定します。アクセス パッケージを通じて製造アプリケーションへのアクセスを許可されたユーザーは、自動的にアカウントがプロビジョニングされます。  </p><p>Contoso の管理者は、アプリケーションを改変することなく、すぐに使える LDAP コネクタを利用し、プロビジョニングを自動化することができるのです。</p><p><img src="/blog/azure-active-directory/automate-provisioning-and-governance-of-your-on-premises/3.png"></p><h2 id="3-定期的なアクセス権のレビューと承認"><a href="#3-定期的なアクセス権のレビューと承認" class="headerlink" title="3. 定期的なアクセス権のレビューと承認"></a>3. 定期的なアクセス権のレビューと承認</h2><p>製造アプリにはビジネス クリティカルなデータがあり、Contoso 社はコンプライアンス プロセスの一環として、製造部門以外の従業員に定期的にアクセスの必要性の確認と正当な理由の提示を求めることが必要とされています。Contoso の管理者は、アプリにアクセスできる製造部門以外のユーザーに対して、多段階のアクセス レビューを設定しました。まず、従業員がアクセスが必要であることを自身で確認し、その後、最終承認のためにアプリケーションの所有者にレビューが転送されます。 アクセス レビューが完了しないユーザーは、自動的にアプリケーションから削除されます。</p><p>適切なアクセス制御とレビューが実施され、「なぜ」アクセス許可が存在するのかが証明できるため、これにより内部および外部の監査要件が満たされます。</p><p><img src="/blog/azure-active-directory/automate-provisioning-and-governance-of-your-on-premises/4.png"></p><p>Azure AD の <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/governance/entitlement-management-overview">エンタイトルメント管理</a>、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/governance/what-is-provisioning">プロビジョニング</a>、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/governance/access-reviews-overview">アクセス レビュー</a> 機能を併用することで、SaaS とオンプレミスの両方のアプリケーションへのアクセスを提供しながら、統制とセキュリティの要件を同時に満たすことが可能になります。今すぐこの新機能を有効にし、SaaS アプリケーションと同じ方法でオンプレミス アプリケーションへのアクセスを管理ください。</p><p>これは、Microsoft Entra Identity Governance のオンプレミス サポートの始まりに過ぎません。PowerShell、Web サービス、その他のビジネス アプリケーションへのカスタム コネクタを使用したプロビジョニング機能など、さらに投資を続け、Microsoft Identity Manager (MIM) を使用しているお客様がプロビジョニング機能を Microsoft Entra Identity Governance に移行できるようにしてまいります。</p><p>これらの新機能に関するご意見は、<a href="https://aka.ms/AzureADFeedback">Azure フォーラム</a> または Twitter で <a href="https://twitter.com/azuread">@AzureAD</a> のタグを付けてお寄せください。</p>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは、Azure Identity サポート チームの 高田 です。&lt;/p&gt;
&lt;p&gt;本記事は、2023 年 2 月 8 日に米国の Azure Active Directory Identity Blog で公開された &lt;a href=&quot;https://techcom</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="US Identity Blog" scheme="https://jpazureid.github.io/blog/tags/US-Identity-Blog/"/>
    
  </entry>
  
  <entry>
    <title>管理者の同意を実施したにも関わらず「管理者の承認が必要です」の画面が表示される</title>
    <link href="https://jpazureid.github.io/blog/azure-active-directory/azure-ad-consent-framework-advance/"/>
    <id>https://jpazureid.github.io/blog/azure-active-directory/azure-ad-consent-framework-advance/</id>
    <published>2023-02-26T15:00:00.000Z</published>
    <updated>2023-04-15T23:00:14.102Z</updated>
    
    <content type="html"><![CDATA[<p>こんにちは。Azure Identity チームの埴山です。<br>不正なアプリを利用した攻撃を防ぐ目的で、一般ユーザーによる同意を制限しているお客様から、管理者同意に関するお問合せを多く頂いております。</p><p>そこで以前、<a href="/blog/azure-active-directory/azure-ad-consent-framework/">「管理者の承認が必要」のメッセージが表示された場合の対処法</a> という記事を書きました。<br>しかしながら記事を参考に管理者同意を実施したにもかかわらず、一般ユーザーがアプリにアクセスすると「管理者の承認が必要です」の画面が表示されるというお問合せをいただくことがございます。</p><p>アプリから想定外に同意要求がなされるのにはいくつかのパターンがあるのですが、いずれも「同意のフレームワーク」の仕組みについて理解が必要になります。<br>そこで今回の記事では、より技術的な視点で「同意のフレームワーク」がどのように動作するのか、想定外の同意要求はどのようにして発生するのか解説し、その対処方法をご案内します。</p><h2 id="アプリが権限を要求する際の流れ"><a href="#アプリが権限を要求する際の流れ" class="headerlink" title="アプリが権限を要求する際の流れ"></a>アプリが権限を要求する際の流れ</h2><p>具体的なパターンを説明する前に、まずはアプリが実際にリソースへの権限を取得する流れを説明します。</p><h3 id="同意の流れ"><a href="#同意の流れ" class="headerlink" title="同意の流れ"></a>同意の流れ</h3><p>サードパーティー製のアプリが、Azure AD で保護されたリソースにアクセスを行う場合、概ね以下のような流れになります。</p><ol><li>アプリが Azure AD の認可 (authorize) エンドポイントにアクセスし、ユーザーの同意を得る</li><li>同意を得た結果 (authorization code) が Azure AD からアプリに返却される</li><li>同意を得た結果 (authorization code) を元にアクセス トークンを取得する</li><li>アクセス トークンを利用し、保護されたリソース (API) の呼び出しを実施する (図では省略)</li></ol><p><img src="/blog/azure-active-directory/azure-ad-consent-framework-advance/consent-flow.png" alt="consent flow"></p><div class="alert is-info"><p class="alert-title">Note</p><p>認証部分は省略しており、サインイン済みの状態を想定しています</p></div><p>アプリは 1 の Step で動作に必要な権限を指定します。以前の記事で説明した通り、権限は scope と呼ばれる単位で管理されており、たとえばメール データを取得するアプリであれば <code>Mail.Read</code> を scope に指定しユーザー同意を得る必要があります。</p><h2 id="認可リクエストの詳細"><a href="#認可リクエストの詳細" class="headerlink" title="認可リクエストの詳細"></a>認可リクエストの詳細</h2><p>同意要求は Azure AD の認可 (authorize) エンドポイントを介して実施されます。具体的には、以下のエンドポイントに対し GET リクエストを送信することで、サインイン ユーザーに対し同意要求を実施することが可能です。</p><ul><li><code>https://login.microsoftonline.com/&#123;tenant&#125;/oauth2/v2.0/authorize</code></li></ul><p>実際には上記の URL にアクセスするだけでは、「どのアプリ」が「どのような権限」を求めているか分かりません。オプショナルなパラメーターを除き、最低限必要なパラメーターを含めたリクエストの例は以下の通りです。</p><ul><li><code>https://login.microsoftonline.com/organizations/oauth2/v2.0/authorize?client_id=d6a9ba66-7c70-4c46-a221-39777901836c&amp;scope=Mail.Read&amp;redirect_uri=https%3A%2F%2Fjwt.ms&amp;response_type=code&amp;etc...</code></li></ul><p>URL の末尾 ? から後のクエリ パラメーターは、<code>=</code> で繋がれた Key, Value 形式になっていますが、同意のフレームワークで重要なのは特に以下パラメーターです。</p><table><thead><tr><th align="left">パラメーター</th><th align="left">意味</th><th align="left">例</th></tr></thead><tbody><tr><td align="left">client_id</td><td align="left">アクセス権を要求しているアプリのアプリケーション ID</td><td align="left">d6a9ba66-7c70-4c46-a221-39777901836c</td></tr><tr><td align="left">scope</td><td align="left">アプリが要求している権限</td><td align="left">Mail.Read</td></tr></tbody></table><p>ここでは <code>d6a9ba66-7c70-4c46-a221-39777901836c</code> のアプリが <code>Mail.Read</code> の権限を求めていることが分かります。</p><h2 id="要求を受け取ったユーザーが出来ること"><a href="#要求を受け取ったユーザーが出来ること" class="headerlink" title="要求を受け取ったユーザーが出来ること"></a>要求を受け取ったユーザーが出来ること</h2><p>ユーザーが自身で同意が出来る場合には、同意画面が表示されます。ユーザーの同意が完了するとアプリは同意された API のアクセス許可の範囲で、ユーザーの代わりに API アクセスが出来るようになります。</p><p><img src="/blog/azure-active-directory/azure-ad-consent-framework-advance/user-can-consent.png"></p><p>一方で、ユーザーが自身で同意できない場合には、管理者の承認が必要の画面が表示され、アプリへのアクセスがブロックされます。ユーザーがどのような条件で同意できるかについては、<a href="/blog/azure-active-directory/azure-ad-consent-framework/">以前の記事</a>で解説をしていますので、そちらを確認してください。</p><p>ポイントとして押さえておいていただきたい点としては、ユーザーが <code>Mail.Read</code> に同意済み、あるいは管理者がユーザーの代わりに同意済みの場合には、同意画面は<strong>再度現れることは無く</strong>、トークンの発行まで完了する点です。</p><p><img src="/blog/azure-active-directory/azure-ad-consent-framework-advance/user-already-consented.png"></p><p>つまり、ユーザー同意を制限している環境においても、管理者同意が完了しているアプリに対しては、同意画面は二度と表示がされないはずです。<br>しかしいくつかのシナリオにおいては、ユーザー同意が要求され「管理者の承認が必要です」の画面が表示されてしまいます。</p><h2 id="管理者の同意を実施したのにユーザー同意が要求される-3-つのパターン"><a href="#管理者の同意を実施したのにユーザー同意が要求される-3-つのパターン" class="headerlink" title="管理者の同意を実施したのにユーザー同意が要求される 3 つのパターン"></a>管理者の同意を実施したのにユーザー同意が要求される 3 つのパターン</h2><p>では、どのようなパターンでユーザー同意が要求されてしまうのでしょうか。結論から言うと、以下の 3 つのパターンが挙げられます。</p><ol><li>アプリが同意要求に <code>prompt=consent</code> クエリ パラメーターを付与している</li><li>アプリがすでに同意済みの権限以外の API のアクセス許可を要求している</li><li>静的な同意と動的な同意の差異により、必要な権限に同意が出来ていない</li></ol><p>それぞれのパターンについて説明します。 </p><h3 id="1-アプリが同意要求に-prompt-consent-クエリ-パラメーターを付与している"><a href="#1-アプリが同意要求に-prompt-consent-クエリ-パラメーターを付与している" class="headerlink" title="1. アプリが同意要求に prompt=consent クエリ パラメーターを付与している"></a>1. アプリが同意要求に <code>prompt=consent</code> クエリ パラメーターを付与している</h3><p>ユーザーまたは管理者が同意済みにも関わらず、毎回同意画面が出てしまう要因として考えられるのが、<code>prompt=consent</code> パラメーターです。<br>アプリは認可エンドポイントへのアクセス時に様々な<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/v2-oauth2-auth-code-flow#request-an-authorization-code">オプション パラメーター</a>を付与することができますが、<code>prompt</code> パラメーターは認可リクエスト時に表示される対話画面を指定します。</p><p><code>prompt</code> パラメーターにより、資格情報の再入力を強制したり、対話的なサインイン画面を省略することを試みたりすることができますが <code>prompt=consent</code> パラメーターはユーザー同意を再度実施するよう強制します。<br>管理者の同意が実施済みであっても、<code>prompt=consent</code> パラメーターが付与されている場合には、必ず同意画面を表示しようと試みるため、ユーザー同意が制限されている環境では「管理者の承認が必要です」のエラー画面が表示されることになります。</p><p>ユーザー同意が制限された環境では <code>prompt=consent</code> パラメーターが付与された同意要求をユーザーが処理することは不可能ですので、ユーザー同意を許可するようテナントの構成を変更するか、アプリが <code>prompt=consent</code> パラメーターを送信しないように改修する必要があります。サードパーティー製アプリの場合には、アプリの開発元にご確認ください。</p><p>パラメーターにより同意画面が表示されているかは、アプリへのアクセス時の通信トレースを確認することで判別できます。Web アプリの場合にはアクセス時にブラウザーの開発者ツール (F12 トレース) を確認することで、authorize エンドポイントへの要求を確認することが可能です。</p><p>開発者ツールの簡単な使い方と同意要求の解析方法は本ブログの<a href="#%E4%BB%98%E9%8C%B2">付録</a>にまとめましたので参考にしてください。</p><h3 id="2-アプリがすでに同意済みの権限以外の-API-のアクセス許可を要求している"><a href="#2-アプリがすでに同意済みの権限以外の-API-のアクセス許可を要求している" class="headerlink" title="2. アプリがすでに同意済みの権限以外の API のアクセス許可を要求している"></a>2. アプリがすでに同意済みの権限以外の API のアクセス許可を要求している</h3><p>Azure AD の同意フレームワークでは「増分および動的な同意」がサポートされています。これは、アプリが必要なタイミングで、必要な権限を要求できるようになる仕組みで、例えば以下のような実装が考えられます。</p><p>アプリは基本的にユーザーのメールボックスと連携するため <code>Mail.Read</code> の権限を要求するが、追加の機能を有効化することで取得したメールの添付ファイルを SharePoint Online に保存が出来る。機能を有効化する際には追加で <code>Files.ReadWrite</code> の権限を要求する。</p><p>このように「増分および動的な同意」の機能により、アプリは必要に応じて、必要なタイミングで同意を要求することが可能です。アプリが最初に要求し同意済みの権限とは別に、追加の権限を要求した場合、そのタイミングでユーザー同意が要求されます。ユーザー同意が制限されている場合には、「管理者の承認が必要です」の画面が表示されます。</p><p>対処方法は 「3. 静的な同意と動的な同意の差異により、必要な権限に同意が出来ていない」のシナリオと同様なので、<a href="#%E5%8B%95%E7%9A%84%E3%81%AA%E6%A8%A9%E9%99%90%E8%A6%81%E6%B1%82%E3%81%AB%E5%AF%BE%E3%81%97%E3%81%A6%E5%90%8C%E6%84%8F%E3%82%92%E5%AE%9F%E6%96%BD%E3%81%99%E3%82%8B">動的な権限要求に対して同意を実施する</a> を確認ください。</p><h3 id="3-静的な同意と動的な同意の差異により、必要な権限に同意が出来ていない"><a href="#3-静的な同意と動的な同意の差異により、必要な権限に同意が出来ていない" class="headerlink" title="3. 静的な同意と動的な同意の差異により、必要な権限に同意が出来ていない"></a>3. 静的な同意と動的な同意の差異により、必要な権限に同意が出来ていない</h3><p>本パターンは、本質的には「アプリがすでに同意済みの権限以外の API のアクセス許可を要求している」と同じ要因ですが、特にお問合せを頂くことが多いため、個別に説明します。</p><p>ここまで説明した「増分および動的な同意」機能は柔軟な権限要求を実装でき、アプリの機能拡張などをしやすくするメリットがあります。ただ動的な要求が出来る性質上、<strong>同意を実施するまでは本当にアプリの動作に必要な権限が分かりません。</strong><br>これは実際に<strong>アプリを利用するタイミングでしか必要な権限が何か分からない</strong>ことを意味しています。</p><div class="alert is-info"><p class="alert-title">Note</p><p>正確にはアプリが authorize エンドポイントに認可リクエストを送信する際、必要な API のアクセス許可として指定する scope パラメーターを確認するまで、動的なアクセス許可が特定できません</p></div><p>この性質により、<strong>実際のアプリの利用時</strong>以外に同意を実施した際に、本当に必要な権限に同意が出来ないことがあります。より具体的には、エンタープライズ アプリケーションのアクセス許可から管理者の同意を付与するパターンでは動的に要求される権限に同意が出来ずに問題となる場合があります。</p><h4 id="Azure-ポータル上から実施するアクセス許可への同意"><a href="#Azure-ポータル上から実施するアクセス許可への同意" class="headerlink" title="Azure ポータル上から実施するアクセス許可への同意"></a>Azure ポータル上から実施するアクセス許可への同意</h4><p>Azure ポータルのエンタープライズ アプリケーションから、登録されたアプリを選択し [アクセス許可] ブレードに移動すると、管理者同意を実施するボタンがあります。</p><p><a href="../azure-active-directory/azure-ad-consent-framework/#%E3%83%91%E3%82%BF%E3%83%BC%E3%83%B3-1-%E3%82%A2%E3%83%97%E3%83%AA%E3%82%B1%E3%83%BC%E3%82%B7%E3%83%A7%E3%83%B3%E3%81%AB%E7%AE%A1%E7%90%86%E3%83%A6%E3%83%BC%E3%82%B6%E3%83%BC%E3%81%A7%E3%82%A2%E3%82%AF%E3%82%BB%E3%82%B9%E3%82%92%E8%A1%8C%E3%81%84%E3%80%81%E7%B5%84%E7%B9%94%E3%81%AE%E4%BB%A3%E7%90%86%E3%81%A8%E3%81%97%E3%81%A6%E5%90%8C%E6%84%8F%E3%81%99%E3%82%8B%E3%81%AB%E3%83%81%E3%82%A7%E3%83%83%E3%82%AF%E3%82%92%E3%81%84%E3%82%8C%E3%81%A6%E5%90%8C%E6%84%8F%E3%82%92%E4%BB%98%E4%B8%8E%E3%81%99%E3%82%8B">「管理者の承認が必要」のメッセージが表示された場合の対処法</a> では、実際にグローバル管理者権限でアプリにサインインを実施し、同意画面で要求された権限に対し [組織の代理として同意する] 方法をお勧めしました。<br>しかし [組織の代理として同意する] にチェックをつけ忘れて承諾した場合、グローバル管理者はユーザー同意を完了させますので、その後アプリが同じ権限のみを求める限り、二度と同意画面が表示されることはありません。</p><p>その際の代替方法として、エンタープライズ アプリケーションの [アクセス許可] ブレードから管理者の同意を付与する方法を紹介しました。</p><p><img src="https://jpazureid.github.io/blog/azure-active-directory/azure-ad-consent-framework/consent-to-enterprise-application.png" alt="アクセス許可"></p><p>上記の [Contoso に管理者の同意を与えます] ボタンをクリックすることで、要求された権限が表示され管理者同意を実施できます。</p><p>前述の通り、アプリが要求している権限はアプリへのアクセス時にしか分かりません。しかし、エンタープライズ アプリケーションの [アクセス許可] ブレードからの同意ではアプリにアクセスせず Azure ポータル上で処理が完結します。<br>Azure ポータル上では一体何の権限に同意しているのでしょうか。</p><h4 id="静的なアクセス許可"><a href="#静的なアクセス許可" class="headerlink" title="静的なアクセス許可"></a>静的なアクセス許可</h4><p>結論から言うと、エンタープライズ アプリケーションの [アクセス許可] ブレードの同意ボタンでは、アプリケーション開発者が設定した [静的なアクセス許可] に同意します。</p><p>アプリの開発者はアプリの開発テナントに登録されたアプリケーション オブジェクトに、あらかじめ必要と考えられる API のアクセス許可、静的なアクセス許可 (構成されたアクセス許可) を定義しておくことが可能です。</p><p><img src="/blog/azure-active-directory/azure-ad-consent-framework-advance/configured-permissions.png" alt="アプリ開発者が設定する静的なアクセス許可"></p><p>事前定義された API のアクセス許可は、以前のバージョンである Azure AD の v1.0 エンドポイントを利用する際に利用されますが、現在主流の v2.0 エンドポイントではほとんど利用されません。</p><p>しかしながら Azure ポータルからアプリに同意を付与する場合には、何の権限に同意すれば良いのかの情報がないため、v1.0 エンドポイントで利用されていた  [静的なアクセス許可] に同意が付与されます。</p><p>結果として、アプリの開発者がアプリの実装時に動的に求める権限 (scope パラメーター) と、Azure AD にあらかじめ登録された [静的なアクセス許可] に差異が生じることがあります。</p><p>例えばアプリ上では <code>Mail.Read</code> の権限を動的に要求しているのにもかかわらず、[静的なアクセス許可] には <code>User.Read</code> のみが設定されていた場合、いくら Azure ポータル上で管理者同意を実施しても <code>User.Read</code> にしか管理者同意が付与されません。そのため、一般ユーザーが <code>Mail.Read</code> の権限を動的に要求しているアプリにアクセスした際には、ユーザー同意が求められ、ユーザー同意が制限された環境では「管理者の承認が必要です」のエラーが表示されることが想定されます。</p><div class="alert is-info"><p class="alert-title">Note</p><p>現在 Azure AD の同意フレームワークでは「増分および動的な同意」がサポートされていますが、以前からサポートされていたわけではありません。</p><p>現在 Azure AD の同意エンドポイントは、MSAL ライブラリでも利用され、主流の v2.0 エンドポイントと、ADAL ライブラリで利用されていた旧来の v1.0 エンドポイントの 2 種類があります。</p><p>v1.0 のエンドポイントではあらかじめアプリの動作に必要な API の権限を定義しておき、定義された権限にのみ同意を実施する「静的な同意」のみをサポートしていました。</p></div><h3 id="動的な権限要求に対して同意を実施する"><a href="#動的な権限要求に対して同意を実施する" class="headerlink" title="動的な権限要求に対して同意を実施する"></a>動的な権限要求に対して同意を実施する</h3><p>2, 3 で紹介した差分同意や動的な権限要求を実施するアプリに対しては、<strong>実際にアプリを利用する</strong>タイミングで求められた権限に同意を実施する必要があります。一つの方法が前回のブログで紹介したグローバル管理者でサインインを実施し [組織の代理として同意する] オプションにチェックを付けたうえで同意を行う方法です。[組織の代理として同意する] にチェックを付け忘れて同意を実施した場合には、エンタープライズ アプリを削除するなどして同意を取り消し、再度同意画面を表示させるという方法が考えられます。</p><p>他の方法としては <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/manage-apps/configure-admin-consent-workflow">管理者の同意ワークフロー</a> を構成いただくことで<strong>ユーザーがアプリ利用時に求められた権限</strong>を把握し、管理者が同意することが可能です。管理者の同意ワークフローではグローバル管理者以外のユーザーでも同意が可能なため、柔軟な運用が可能になります。</p><p>さらに細かい制御を実施したり、特定の権限にのみ同意を実施する方法は、後述の付録をご確認ください。</p><h2 id="付録"><a href="#付録" class="headerlink" title="付録"></a>付録</h2><p>[組織の代理として同意する] チェックボックスでの同意や、管理者の同意ワークフローを利用できない場合、あるいは管理者の同意ではなく特定ユーザーにのみ同意を付与したい、といったシナリオではアプリが求めている API のアクセス許可を正確に把握する必要が出てきます。その際に有効なツールがブラウザーの開発者ツール (F12 トレース) です。</p><h3 id="F12-トレースの確認方法"><a href="#F12-トレースの確認方法" class="headerlink" title="F12 トレースの確認方法"></a>F12 トレースの確認方法</h3><p>採取の仕方はブラウザーによって細かな違いがありますが、概ね以下の通りです。</p><ol><li>ブラウザーを開きます。</li><li>F12 を押し、開発者ツールを起動します。</li><li>[ネットワーク タブ] を選択します。</li><li>“ログの保持” にチェックが入った状態 (有効) にします。</li><li>同意を行うアプリにアクセスし組織アカウントでのサインインを実施します。</li></ol><p><img src="/blog/azure-active-directory/azure-ad-consent-framework-advance/developer-tools.png" alt="Edge の開発者ツール"></p><p>採取した通信のうち、<code>https://login.microsoftonline.com/organizations/oauth2/v2.0/authorize</code> へのアクセスを探し、ペイロードのクエリ文字列パラメーターを確認することで、authorize エンドポイントに対するリクエストの内容が分かります。</p><p>上記の例では <code>client_id</code> (アプリケーション ID) が <code>d6a9ba66-7c70-4c46-a221-39777901836c</code> のアプリが権限を要求していること、<code>scope</code> として <code>User.Read offline_access</code> が要求されていること、<code>prompt</code> として <code>consent</code> が指定されているため、明示的な再同意が求められていることが確認できます。</p><p>なお上記のログは、ダウンロード ボタン (↓) を選択することで har ファイルとしてダウンロード頂けます。サポート サービスをご利用いただく場合には、調査に有用な情報となりますので、問い合わせの際には添付いただくことをお勧めします。</p><h3 id="管理者の同意エンドポイント"><a href="#管理者の同意エンドポイント" class="headerlink" title="管理者の同意エンドポイント"></a>管理者の同意エンドポイント</h3><p>具体的なアプリケーション ID と求められている権限が分かれば、管理者の同意を付与するためのリンクを作成することが可能です。</p><p><a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/v2-admin-consent">管理者の同意エンドポイント (v2.0)</a> は、以下のような形式の URL です。</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line">GET https://login.microsoftonline.com/&#123;tenant&#125;/v2.0/adminconsent</span><br><span class="line">        ?client_id=&#123;client_id&#125;</span><br><span class="line">        &amp;scope=&#123;scope&#125;</span><br><span class="line">        &amp;redirect_uri=&#123;redirect_uri&#125;</span><br><span class="line">        &amp;state=12345</span><br></pre></td></tr></table></figure><p><code>client_id</code> と <code>scope</code> は <code>redirect_uri</code> はトレースなどで得られた値を指定します。<code>tenent</code> は GUID または &lt;初期ドメイン&gt;.onmicrosoft.com などのドメイン名を指定します。<br>たとえば、先ほどの F12 トレースで解析したアプリに対し、管理者同意を実施するには以下のような URL を組み立ててクラウド アプリケーション管理者などの管理者アカウントでアクセスします。</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line">GET https://login.microsoftonline.com/oauth2beginner.onmicrosoft.com/v2.0/adminconsent</span><br><span class="line">        ?client_id=d6a9ba66-7c70-4c46-a221-39777901836c</span><br><span class="line">        &amp;scope=User.Read%20offline_access</span><br><span class="line">        &amp;redirect_uri=https%3A%2F%2Fjwt.ms</span><br><span class="line">        &amp;state=12345</span><br></pre></td></tr></table></figure><p>管理者アカウントでアクセスした場合には、以下のような同意画面が表示され管理者の同意を実施できます。</p><p><img src="/blog/azure-active-directory/azure-ad-consent-framework-advance/admin-consent-review.png" alt="管理者の同意エンドポイント"></p><p>同意が正常に完了すると、redirect_uri に指定した URL に以下のような応答が返却されます。</p><figure class="highlight http"><table><tr><td class="code"><pre><span class="line">https://jwt.ms</span><br><span class="line">    ?admin_consent=True</span><br><span class="line">    &amp;tenant=&#123;tenant-gui&#125;</span><br><span class="line">    &amp;scope=&#123;scope&#125;</span><br><span class="line">    &amp;state=12345</span><br></pre></td></tr></table></figure><p>リダイレクト URI には Azure ポータルの同意ボタンで利用される <code>https://portal.azure.com/TokenAuthorize</code> を指定しても構いません。</p><h3 id="特定のユーザーに対しての同意を管理者が実施する"><a href="#特定のユーザーに対しての同意を管理者が実施する" class="headerlink" title="特定のユーザーに対しての同意を管理者が実施する"></a>特定のユーザーに対しての同意を管理者が実施する</h3><p>アプリが求めている権限が分かれば、<a href="https://learn.microsoft.com/ja-jp/azure/active-directory/manage-apps/grant-consent-single-user?pivots=msgraph-powershell">PowerShell を使用して 1 人のユーザーに代わって同意を許可する</a> のように、特定のユーザーの代わりに管理者が同意することも可能です。<br>通常アプリに対するユーザーの制限は <a href="https://learn.microsoft.com/ja-jp/azure/active-directory/develop/howto-restrict-your-app-to-a-set-of-users">ユーザーの割り当てが必要ですか？</a> のオプションを [はい] に設定し、アクセスを許可するユーザーを割り当てることが適切です。</p><p>一方で、ユーザーにより付与したい権限が変わるようなシナリオでは個別のユーザー同意を付与する API を利用できます。たとえば Microsoft Graph SDK や Microsoft Graph Explorer など、付与する権限によって出来ることが変わるアプリに対し、特定のユーザーにはサインイン ログが見れるアクセス許可を、特定のユーザーにはユーザー一覧が取得できるアクセス許可を付与するといったことが可能です。</p><h3 id="Microsoft-Graph-SDK-のサンプル"><a href="#Microsoft-Graph-SDK-のサンプル" class="headerlink" title="Microsoft Graph SDK のサンプル"></a>Microsoft Graph SDK のサンプル</h3><p>以下にユーザー委任のアクセス許可に関する PowerShell のサンプルを記載します。</p><h4 id="特定アプリに実施した同意情報を取得"><a href="#特定アプリに実施した同意情報を取得" class="headerlink" title="特定アプリに実施した同意情報を取得"></a>特定アプリに実施した同意情報を取得</h4><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># クラウド アプリケーション管理者権限でサインイン</span></span><br><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-Scope</span> <span class="string">&quot;Application.Read.All,DelegatedPermissionGrant.ReadWrite.All&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 権限を割り当てたアプリのサービス プリンシパル オブジェクトの取得</span></span><br><span class="line"><span class="variable">$sp</span> = <span class="built_in">Get-MgServicePrincipal</span> <span class="literal">-Filter</span> <span class="string">&quot;appId eq &#x27;&lt;AppId&gt;&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 付与された同意情報を取得</span></span><br><span class="line"><span class="variable">$delegatedPermissions</span> = <span class="built_in">Get-MgOauth2PermissionGrant</span> <span class="literal">-Filter</span> <span class="string">&quot;clientId eq &#x27;<span class="variable">$</span>(<span class="variable">$sp</span>.Id)&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="variable">$delegatedPermissions</span> | <span class="built_in">Format-List</span> Id, ConsentType, PrincipalId, ResourceId, Scope</span><br><span class="line"></span><br><span class="line"><span class="comment"># ClientId             : クライアント アプリの &quot;オブジェクト ID&quot; (ClientID ではない)</span></span><br><span class="line"><span class="comment"># Id                   : Oauth2PermissionGrant オブジェクトの ID</span></span><br><span class="line"><span class="comment"># ConsentType          : 管理者同意の場合 AllPrincipals, ユーザー同意は Principal</span></span><br><span class="line"><span class="comment"># PrincipalId          : ユーザー同意の場合のユーザー オブジェクト ID</span></span><br><span class="line"><span class="comment"># ResourceId           : リソースのオブジェクト ID</span></span><br><span class="line"><span class="comment"># Scope                : 同意済みの API のアクセス許可のリスト</span></span><br></pre></td></tr></table></figure><h4 id="特定アプリに対するすべてのユーザー委任の同意を削除"><a href="#特定アプリに対するすべてのユーザー委任の同意を削除" class="headerlink" title="特定アプリに対するすべてのユーザー委任の同意を削除"></a>特定アプリに対するすべてのユーザー委任の同意を削除</h4><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># クラウド アプリケーション管理者権限でサインイン</span></span><br><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-Scope</span> <span class="string">&quot;Application.ReadWrite.All,DelegatedPermissionGrant.ReadWrite.All&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 権限を割り当てたアプリのサービス プリンシパル オブジェクトの取得</span></span><br><span class="line"><span class="variable">$sp</span> = <span class="built_in">Get-MgServicePrincipal</span> <span class="literal">-Filter</span> <span class="string">&quot;appId eq &#x27;&lt;AppId&gt;&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 付与された同意を取得</span></span><br><span class="line"><span class="variable">$delegatedPermissions</span> = <span class="built_in">Get-MgOauth2PermissionGrant</span> <span class="literal">-Filter</span> <span class="string">&quot;clientId eq &#x27;<span class="variable">$</span>(<span class="variable">$sp</span>.Id)&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 付与された同意を削除</span></span><br><span class="line"><span class="variable">$delegatedPermissions</span> | <span class="built_in">ForEach-Object</span>&#123; <span class="built_in">Remove-MgOauth2PermissionGrant</span> <span class="literal">-OAuth2PermissionGrantId</span> <span class="variable">$_</span>.Id &#125; </span><br></pre></td></tr></table></figure><h4 id="特定アプリに対する管理者の同意のみを削除"><a href="#特定アプリに対する管理者の同意のみを削除" class="headerlink" title="特定アプリに対する管理者の同意のみを削除"></a>特定アプリに対する管理者の同意のみを削除</h4><figure class="highlight powershell"><table><tr><td class="code"><pre><span class="line"><span class="comment"># クラウド アプリケーション管理者権限でサインイン</span></span><br><span class="line"><span class="built_in">Connect-MgGraph</span> <span class="literal">-Scope</span> <span class="string">&quot;Application.ReadWrite.All,DelegatedPermissionGrant.ReadWrite.All&quot;</span></span><br><span class="line"> </span><br><span class="line"><span class="comment"># 権限を割り当てたアプリのサービス プリンシパル オブジェクトの取得</span></span><br><span class="line"><span class="variable">$sp</span> = <span class="built_in">Get-MgServicePrincipal</span> <span class="literal">-Filter</span> <span class="string">&quot;appId eq &#x27;&lt;AppId&gt;&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 付与された管理者同意を取得</span></span><br><span class="line"><span class="variable">$adminConsents</span> = <span class="built_in">Get-MgOauth2PermissionGrant</span> <span class="literal">-Filter</span> <span class="string">&quot;clientId eq &#x27;<span class="variable">$</span>(<span class="variable">$sp</span>.Id)&#x27; and consentType eq &#x27;AllPrincipals&#x27;&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 付与された管理者同意を削除</span></span><br><span class="line"><span class="variable">$adminConsents</span> | <span class="built_in">ForEach-Object</span>&#123; <span class="built_in">Remove-MgOauth2PermissionGrant</span> <span class="literal">-OAuth2PermissionGrantId</span> <span class="variable">$_</span>.Id &#125;</span><br></pre></td></tr></table></figure>]]></content>
    
    
      
      
    <summary type="html">&lt;p&gt;こんにちは。Azure Identity チームの埴山です。&lt;br&gt;不正なアプリを利用した攻撃を防ぐ目的で、一般ユーザーによる同意を制限しているお客様から、管理者同意に関するお問合せを多く頂いております。&lt;/p&gt;
&lt;p&gt;そこで以前、&lt;a href=&quot;/blog/azure-</summary>
      
    
    
    
    
    <category term="Azure AD" scheme="https://jpazureid.github.io/blog/tags/Azure-AD/"/>
    
    <category term="OAuth" scheme="https://jpazureid.github.io/blog/tags/OAuth/"/>
    
    <category term="Application" scheme="https://jpazureid.github.io/blog/tags/Application/"/>
    
  </entry>
  
</feed>
